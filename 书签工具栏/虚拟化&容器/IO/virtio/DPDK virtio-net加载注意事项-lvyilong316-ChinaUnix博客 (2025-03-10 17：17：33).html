<!-- Filename: 书签工具栏/虚拟化&容器/IO/virtio/DPDK virtio-net加载注意事项-lvyilong316-ChinaUnix博客 (2025-03-10 17：17：33).html
 Page saved with X-Webpage-Conserve 
 url: http://blog.chinaunix.net/uid-28541347-id-5878233.html
 Summary: This text is about the temporary unavailability of publishing content on a blog due to server migration on Chinaunix.net from September 30, 14:00 to October 4, 08:00. The blog in question is lvyilong316, and it has 214 articles, 0 blog points, and 0 blog level. The user is a regular user who registered on January 23, 2013. The blog covers various topics related to Linux systems, including but not limited to networking, performance optimization, virtualization, and programming. The blog's archive includes articles from 2013 to 2025. The text also discusses the process of mapping resources for DPDK (Data Plane Development Kit) virtio-net using vfio and uio, as well as the differences between modern and legacy virtio PCI devices. The text also mentions the importance of opening IOMMU (Input/Output Memory Management Unit) in the VM for using vfio, and the differences in resource mapping for x86 and other architectures. The text concludes by discussing the differences in interrupt notifications for modern and legacy virtio PCI devices and the option to disable event_idx feature to avoid the need for frontend notification to the backend.本文内容涉及 9 月 30 日 14：00 至 10 月 4 日 08：00 期间，由于 Chinaunix.net 上的服务器迁移，在博客上发布内容暂时不可用。有问题的博客是 lvyilong316，它有 214 篇文章，0 个博客点，0 个博客级别。该用户是 2013 年 1 月 23 日注册的普通用户。该博客涵盖了与 Linux 系统相关的各种主题，包括但不限于网络、性能优化、虚拟化和编程。该博客的档案包括 2013 年至 2025 年的文章。本文还讨论了使用 vfio 和 uio 为 DPDK（数据平面开发套件）virtio-net 映射资源的过程，以及现代和传统 virtio PCI 设备之间的差异。文中还提到了在 VM 中打开 IOMMU（输入/输出内存管理单元）以使用 vfio 的重要性，以及 x86 和其他架构的资源映射差异。本文最后讨论了现代和传统 virtio PCI 设备的中断通知的差异，以及禁用event_idx功能以避免向后端发送前端通知的选项。
-->
<html xmlns="http://www.w3.org/1999/xhtml" imt-state="dual"><head>
<script>
var ua = navigator.userAgent.toLowerCase();
if(ua.match(/MicroMessenger/i)=="micromessenger") {
    location.href='http://blog.chinaunix.net/article.php?url='+ window.location.href;
}
</script>
        <style>
    .Blog_nav1_2 a em { display:inline-block; width:16px; height:13px; background:url(/image/v.jpg) no-repeat; overflow:hidden;}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="/css/default/style.css">
<link rel="stylesheet" type="text/css" href="/css/qqface/qqFace.css">
<link rel="stylesheet" type="text/css" href="/css/asyncbox/skins/Chrome/asyncbox.css">
<link rel="stylesheet" type="text/css" href="/assets/3ad80e72/pager.css">
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery.cookies.min.js"></script>
<script type="text/javascript" src="/js/AsyncBox.v1.4.5.js"></script>
<title>DPDK virtio-net加载注意事项-lvyilong316-ChinaUnix博客</title>
<meta name="description" content="
	DPDK virtio-net加载注意事项


	——lvyilong316


	关于DPDK virtio-net pmd的初始化流程我们前文有基于DPDK 17.11的分析，这篇文章主要介绍下其使用过程中的一些注意事">
<script type="text/javascript" src="http://168.it168.com/a/h600.js"></script><script type="text/javascript" src="http://img.168.it168.com/168/a/b/h600.js" charset="utf-8"></script>

<script type="text/javascript">
if(/AppleWebKit.*Mobile/i.test(navigator.userAgent) || (/MIDP|SymbianOS|NOKIA|SAMSUNG|LG|NEC|TCL|Alcatel|BIRD|DBTEL|Dopod|PHILIPS|HAIER|LENOVO|MOT-|Nokia|SonyEricsson|SIE-|Amoi|ZTE/.test(navigator.userAgent))){
	try{
		if(!/iPad/i.test(navigator.userAgent)){
			var oldurl=window.location.href;
			if(window.location.hostname.indexOf('m.blog.chinaunix.net')==-1){
			var wapUrl= oldurl.replace('blog.chinaunix.net', "m.blog.chinaunix.net") ;
			window.location.href = wapUrl;
			}
		}
	}catch(e){}
}
</script>


<script language="javascript">
//用户是否在线
var isOnLine = '';

//消息通知显示和隐藏控制
function showMenu(){
	$('#show_message_slide_button').hover(
		function(){
			$('#message_slide_div').slideDown(100);
		},
		function(){

		}
	);

	$('#message_slide_div').hover(
		function(){

		},
		function(){
			$('#message_slide_div').slideUp(100);
		}
	);
}
$(document).ready(function(){
	var blog = {'name': '', 'name_url': '', 'brief': ''};

	//编辑博客名
	$('#editbna').click(function(){
		blog.name = $('#bnaspan a').text();
		var val = '<input id="bnainput" type="text" style="float:left" value="" rel="' +$(this).attr('rel') + '" /><input id="bnasub" type="button" style="float:left" class="btn1"><input id="bnacanl" type="button" style="float:left" class="btn2"><div class="clear"></div>';
		$('#bnaspan').html(val);
		$('#bnainput').val(blog.name);
		$(this).parent().hide();
	});

	$('#bnasub').live('click', function(){
	    var rel = eval('({' + $('#bnainput').attr('rel') + '})');
		var name = $('#bnainput').val();
		if(name != blog.name){
	        $.ajax({
			    type: "POST",
			    url: rel.url,
			    data: {
				    'name' : name
			    },
			    success:function(data){
				    if(data == 0){
						$('#bnaspan').html(blog.name);
						$('#bnaspan').html('<a href="' + rel.href + '">' + $('#bnaspan').html() + '</a>');
				    }else if(data == -1){
                                        showErrorMsg('名称中含有违禁词，请重新编辑!', '消息提示');
                                    }else{
						$('#bnaspan').html(data);
						$('#bnaspan').html('<a href="' + rel.href + '">' + $('#bnaspan').html() + '</a>');
				    }
					$('#editbna').parent().show();
				}
			});
		}else{
		    $('#bnaspan').text(blog.name).html();
			$('#bnaspan').html('<a href="' + rel.href + '">' + $('#bnaspan').html() + '</a>');
			$('#editbna').parent().show();
		}
	});

	$('#bnacanl').live('click', function(){
		var rel = eval('({' + $('#bnainput').attr('rel') + '})');
		$('#bnaspan').html('<a href="' + rel.href + '">' + blog.name + '</a>');
		$('#editbna').parent().show();
	});

	//编辑签名
	$('#editbrief').click(function(){
	    blog.brief = $('#briefem').text();
		var val = '<input id="brfinput" type="text" style="float:left" value="" rel="' + $(this).attr('rel') + '" /><input id="brfsub" style="float:left"  type="button" class="btn1"><input style="float:left"  id="brfcanl" type="button" class="btn2"><div class="clear"></div>';
		$('#briefem').html(val);
		$('#brfinput').val(blog.brief);
		$(this).parent().hide();
	});

	$('#brfsub').live('click', function(){
	    var url = $('#brfinput').attr('rel');
		var brief = $('#brfinput').val();
		if(brief != blog.brief){
	        $.ajax({
			    type: "POST",
			    url: url,
			    data: {
				    'brief' : brief
			    },
			    success:function(data){
				    if(data == 0){
				        $('#briefem').html(blog.brief);
				    }else if(data == -1){
                                        showErrorMsg('签名中含有违禁词，请重新编辑!', '消息提示');
                                    }else{
						$('#briefem').html(data);
				    }
					$('#editbrief').parent().show();
				}
			});
		}else{
		    $('#briefem').text(blog.brief).html();
			$('#editbrief').parent().show();
		}
	});

	$('#brfcanl').live('click', function(){
		$('#briefem').html(blog.brief);
		$('#editbrief').parent().show();
	});

});
</script>
<script src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=483776"></script><link rel="stylesheet" href="http://bdimg.share.baidu.com/static/api/css/share_style0_16.css?v=8105b07e.css"><style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}
.immersive-translate-attach-loading::after {
  content: " ";

  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;

  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-2000%, -50%);
  z-index: 100;
}

.immersive-translate-loading-spinner {
  vertical-align: middle !important;
  width: 10px !important;
  height: 10px !important;
  display: inline-block !important;
  margin: 0 4px !important;
  border: 2px rgba(221, 244, 255, 0.6) solid !important;
  border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-radius: 50% !important;
  padding: 0 !important;
  -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
  animation: immersive-translate-loading-animation 0.6s infinite linear !important;
}

@-webkit-keyframes immersive-translate-loading-animation {
  from {
    -webkit-transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(359deg);
  }
}

@keyframes immersive-translate-loading-animation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
      100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
      110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
      120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}

.immersive-translate-toast {
  display: flex;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  right: 0;
  top: 1%;
  width: fit-content;
  padding: 12px 20px;
  margin: auto;
  overflow: auto;
  background: #fef6f9;
  box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
  font-size: 15px;
  border-radius: 8px;
  color: #333;
}

.immersive-translate-toast-content {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.immersive-translate-toast-hidden {
  margin: 0 20px 0 72px;
  text-decoration: underline;
  cursor: pointer;
}

.immersive-translate-toast-close {
  color: #666666;
  font-size: 20px;
  font-weight: bold;
  padding: 0 10px;
  cursor: pointer;
}

@media screen and (max-width: 768px) {
  .immersive-translate-toast {
    top: 0;
    padding: 12px 0px 0 10px;
  }
  .immersive-translate-toast-content {
    flex-direction: column;
    text-align: center;
  }
  .immersive-translate-toast-hidden {
    margin: 10px auto;
  }
}

.immersive-translate-modal {
  display: none;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0, 0, 0);
  background-color: rgba(0, 0, 0, 0.4);
  font-size: 15px;
}

.immersive-translate-modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 40px 24px 24px;
  border: 1px solid #888;
  border-radius: 10px;
  width: 80%;
  max-width: 270px;
  font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
    "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
    "Segoe UI Symbol", "Noto Color Emoji";
  position: relative;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-content {
    margin: 50% auto !important;
  }
}

.immersive-translate-modal .immersive-translate-modal-content-in-input {
  max-width: 500px;
}
.immersive-translate-modal-content-in-input .immersive-translate-modal-body {
  text-align: left;
  max-height: unset;
}

.immersive-translate-modal-title {
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #333333;
}

.immersive-translate-modal-body {
  text-align: center;
  font-size: 14px;
  font-weight: 400;
  color: #333333;
  word-break: break-all;
  margin-top: 24px;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-body {
    max-height: 250px;
    overflow-y: auto;
  }
}

.immersive-translate-close {
  color: #666666;
  position: absolute;
  right: 16px;
  top: 16px;
  font-size: 20px;
  font-weight: bold;
}

.immersive-translate-close:hover,
.immersive-translate-close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.immersive-translate-modal-footer {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 24px;
}

.immersive-translate-btn {
  width: fit-content;
  color: #fff;
  background-color: #ea4c89;
  border: none;
  font-size: 16px;
  margin: 0 8px;
  padding: 9px 30px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.immersive-translate-btn:hover {
  background-color: #f082ac;
}
.immersive-translate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.immersive-translate-btn:disabled:hover {
  background-color: #ea4c89;
}

.immersive-translate-cancel-btn {
  /* gray color */
  background-color: rgb(89, 107, 120);
}

.immersive-translate-cancel-btn:hover {
  background-color: hsl(205, 20%, 32%);
}

.immersive-translate-action-btn {
  background-color: transparent;
  color: #ea4c89;
  border: 1px solid #ea4c89;
}

.immersive-translate-btn svg {
  margin-right: 5px;
}

.immersive-translate-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #007bff;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-primary-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-modal input[type="radio"] {
  margin: 0 6px;
  cursor: pointer;
}

.immersive-translate-modal label {
  cursor: pointer;
}

.immersive-translate-close-action {
  position: absolute;
  top: 2px;
  right: 0px;
  cursor: pointer;
}

.imt-image-status {
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 16px !important;
}
.imt-image-status img,
.imt-image-status svg,
.imt-img-loading {
  width: 28px !important;
  height: 28px !important;
  margin: 0 0 8px 0 !important;
  min-height: 28px !important;
  min-width: 28px !important;
  position: relative !important;
}
.imt-img-loading {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
  background-size: 28px 28px;
  animation: image-loading-rotate 1s linear infinite !important;
}

.imt-image-status span {
  color: var(--bg-2, #fff) !important;
  font-size: 14px !important;
  line-height: 14px !important;
  font-weight: 500 !important;
  font-family: "PingFang SC", Arial, sans-serif !important;
}

@keyframes image-loading-rotate {
  from {
    transform: rotate(360deg);
  }
  to {
    transform: rotate(0deg);
  }
}
</style>undefined</head>
<body>
    <div class="Blog_nav1">
    <div class="Blog_nav1_2 Blog_nav1_2_2">
		<a href="/"><img src="/image/default/1.png"></a>
		<a href="http://www.chinaunix.net" class="Blog_a1">Chinaunix首页</a> |
		<a href="http://bbs.chinaunix.net" target="_blank">论坛</a> |
		<a href="http://blog.chinaunix.net" target="_blank">博客</a>
		<span class="Blog_span1"></span>
    <a class="Blog_a1" onclick="link(this)" href="http://account.chinaunix.net/login">登录</a> | <a href="http://account.chinaunix.net/register" onclick="link(this)" class="Blog_a1">注册</a></div>
    </div>
    <div class="box" style="max-width: 1000px;margin: 0 auto;position: relative;">
  <!-- 一级导航 -->
  <div style="margin-top: 10px;">

	<!--自动提示层-->
	<style>
	.bor13221{border:1px #bbb solid;width:206px;position:absolute;top:34px;left:0;background:#fff; z-index:9999;display:none}
	.bor13221 li{height:26px;line-height:26px;padding-left:6px;color:#555;font-size:14px;cursor:pointer;}
	.here{background:#f3f3f3;}
    </style>

	<!--自动提示层-->
    <div class="Blog_nav1_3" style="position:relative; z-index:9999;">
	 <div class="bor13221" style="display: none;">
      <ul>
      </ul>
    </div>
	  <form action="/site/search.html" method="post">
		<input type="text" autocomplete="off" class="Blog_txt1" id="search_input_id" name="keywords">
		<select class="Bolg_sel1" name="type" id="search_type_blog">
		  <option value="blog">博文</option>
		  <option value="author">博主</option>
		</select>
		<input type="submit" value="" name="submit" class="Blog_btn1">
	 </form>
    </div>
    <div class="clear"></div>
  </div>
   <script type="text/javascript">
  	$(function(){
  	    		// 判断是否登录
		$.post("/site/IsLogin.html", "", function(xhr){
			var xhr = JSON.parse(xhr);
			var topHtml = '';
			if(xhr.code == 200){
				var res = xhr.res;
				topHtml += '<a href="/uid/'+res.uid+'.html" class="Blog_a1">';
				if(res.isV){
					var colors = ['black', '#c80000', '#f6c500'];
					topHtml += 		'<font color="'+colors[res.renzhenguserStauts]+'">'+res.username+'</font>';
					topHtml += 	'<em></em>';
				} else {
					topHtml += 		'<font color="black">'+res.username+'</font>';
				}
				topHtml += '</a> | ';
				var notices = parseInt(res.newpm)+parseInt(res.newsm)+parseInt(res.newrequest)+parseInt(res.newnotice);
				topHtml += '<a href="/message/private.html" class="Blog_a1">消息('+notices+')</a><span class="Blog_span2" id="show_message_slide_button"></span> | ';
				topHtml += '<a href="/member/friend.html" class="Blog_a1">好友</a>| ';
				topHtml += '<a href="/member/updateprofile.html" class="Blog_a1">个人中心</a> | ';
				topHtml += '<a href="http://account.chinaunix.net/ucenter/user/index" target="_blank" class="Blog_a1">ChinaUnix通行证</a> | ';
				topHtml += '<a href="http://account.chinaunix.net/login/out" class="Blog_a2" onclick="link(this)">退出</a>';
				topHtml += '<div class="Blog_nav1_layer1" id="message_slide_div" style="display: none;">';
				topHtml += 		'<ul>';
				topHtml += 			'<li><a href="/message/private.html">私人消息('+res.newpm+')</a></li>';
				topHtml += 			'<li><a href="/message/system.html">系统消息('+res.newsm+')</a></li>';
				topHtml +=  		'<li><a href="/member/request.html">好友请求('+res.newrequest+')</a></li>';
				topHtml +=  		'<li><a href="/member/notification.html">通知管理('+res.newnotice+')</a></li>';
				topHtml +=  	'</ul>';
				topHtml += '</div>';
			} else {
				topHtml +=  '<a class="Blog_a1" onclick="link(this)" href="http://account.chinaunix.net/login">登录</a> | ';
				topHtml += '<a href="http://account.chinaunix.net/register" onclick="link(this)" class="Blog_a1">注册</a>';
			}
			$(".Blog_nav1_2").append(topHtml);
			showMenu();
		});

		//点击添加进文本框
		$(".bor13221 li").live( 'click' , function(e){
			if ( e && e.stopPropagation )
			{
				//因此它支持W3C的stopPropagation()方法
				e.stopPropagation();
			}
			else
			{
				//否则，我们需要使用IE的方式来取消事件冒泡
				window.event.cancelBubble = true;
			}
			$('#search_input_id').val($(this).text());
			$(".bor13221 ul").html('');
			$(".bor13221").hide();
		});
		$(".bor13221 ul li").live({
			mouseenter:
			function()
			{
				$(".bor13221 ul li").removeClass("here");
				$(this).addClass('here');
			},
			mouseleave:
			function()
			{
				$(".bor13221 ul li").removeClass("here");
				$(this).removeClass('here');
			}
		});
		//自动提示
		$('#search_input_id').keyup(function(event){
			//取消博主的提示
			var search_type_blog = $('#search_type_blog').val();
			if(search_type_blog == 'author') return false;

			var key = $(this).val();
			//获取键值
			var keycode = event.which; //38 上 40 下
			var count = $('.bor13221 ul li').length;
			if(key != '' && keycode != 38 && keycode != 40)
			{
				$.getJSON("http://api.sou.it168.com/autoWenKuCloud?jsoncallback=?",{"ty":"json","offset":"0","limit":"10","q":key}, function(result)
					{
						var arr = result.data;

						var html ='';
						for (i=0;i<arr.length ;i++ )
						{
							html += '<li>'+arr[i]+'</li>';
						}

						$('.bor13221 ul').html(html);
						(arr.length > 1) ?  $(".bor13221").show() : $(".bor13221").hide();
					}
				);
			}
			else if(keycode == 38)
			{
				if(count > 0)
				{
					//遍历li
					var curr_li_num;
					$('.bor13221 ul li').each(function(index , dom){
						if($(dom).attr('class') == 'here')
						{
							curr_li_num = index;
							return false;
						}
					});
					var next_li_num;
					if(typeof(curr_li_num) == 'undefined')
					{
						next_li_num = count - 1;
					}
					else
					{
						if(curr_li_num == 0)
						{
							next_li_num = count - 1;
						}
						else
						{
							next_li_num = curr_li_num - 1;
						}
					}
					$(".bor13221 ul li").removeClass("here");
					$(".bor13221 ul li:eq(" + next_li_num + ")").addClass("here");
					$('#search_input_id').val($(".bor13221 ul li:eq(" + next_li_num + ")").text());
				}
			}
			else if(keycode == 40)
			{
				if(count > 0)
				{
					//遍历li
					var curr_li_num;
					$('.bor13221 ul li').each(function(index , dom){
						if($(dom).attr('class') == 'here')
						{
							curr_li_num = index;
							return false;
						}
					});
					var next_li_num;
					if(typeof(curr_li_num) == 'undefined')
					{
						next_li_num = 0;
					}
					else
					{
						if(curr_li_num == count - 1)
						{
							next_li_num = 0;
						}
						else
						{
							next_li_num = curr_li_num + 1;
						}
					}
					$(".bor13221 ul li").removeClass("here");
					$(".bor13221 ul li:eq(" + next_li_num + ")").addClass("here");
					$('#search_input_id').val($(".bor13221 ul li:eq(" + next_li_num + ")").text());
				}
			}
		});
		$(document).click(function(e){
			$(".bor13221").hide();
		});

	});
  </script>
    <!-- 头 -->
  <!-- 推荐博客-->
  <div class="Blog_header1">
	<div class="img1"></div>    <div class="Blog_header1_1">
      <p class="Blog_p1"><em><a href="/uid/28541347.html">技术之美</a></em><!--      <p class="Blog_p2" style="color:#125A94">暂无签名</p>-->
    </p></div>
        <div class="Blog_header1_2" id="hide_div1">
    	<span class="Blog_span3"></span>
    	<div class="float_div1" style="white-space:nowrap;" onmouseover="javascript:isMove=false" onmouseout="javascript:isMove=true">
	    <ul id="noticev2" style="line-height: 25px; margin-top: 0px;">
		    		    <li><a href="http://blog.chinaunix.net/uid-29568843-id-5875696.html" target="_blank">4月28日14:30-20:30机房服务器迁移，暂停博客使用</a></li>
		    		    <li><a href="http://blog.chinaunix.net/uid-31509949-id-5825708.html" target="_blank">9/30日 14:00 -10/4日 08:00暂时无法发布内容！</a></li>
		    		    <li><a href="http://blog.chinaunix.net/uid-31509949-id-5825708.html" target="_blank">9/30日 14:00 -10/4日 08:00暂时无法发布内容！</a></li>
		    	    </ul>
	    </div>
    </div>
            <div class="Blog_header1_3"><a href="/uid/28541347.html">首页</a>　| 　<a href="/uid/28541347/abstract/1.html">博文目录</a>　| 　<a href="/member/profile/uid/28541347.html">关于我</a></div>
  </div>
  
  <!-- 内容部分 -->
  	<script type="text/javascript" src="/highlight/scripts/XRegExp.js"></script> <!-- XRegExp is bundled with the final shCore.js during build -->
<script type="text/javascript" src="/highlight/scripts/shCore.js"></script>
<script type="text/javascript" src="/highlight/scripts/shAutoloader.js"></script>
<link type="text/css" rel="stylesheet" href="/highlight/styles/shCore.css">
<link type="text/css" rel="Stylesheet" href="/highlight/styles/shThemeDefault.css">
<link href="/code/css/fck_editorarea.css" rel="stylesheet" type="text/css">
<style>
.Blog_p5 em{ display:inline-block; width:16px; height:13px; background:url(/image/v.jpg) no-repeat; overflow:hidden;}
pre{white-space: normal;background: #545252;color: #eee;}
</style>
  <div class="Blog_contain"> 
    <!-- 左 -->
	<div style="float:left;width:220px">
	<style>
    .Blog_left1_1 p a em { display:inline-block; width:16px; height:13px; background:url(/image/v.jpg) no-repeat; overflow:hidden;}
</style>

<script language="javascript">
$(document).ready(function(){
	$('#ConcernBtn').bind('click',function(){
			var cuid = '28541347';
			var url =  '/member/concern.html';
			var type = $(this).attr('rel');
		
			if(type == 'addConcern'){
				$.ajax({
					type : 'get',
					url  : url,
					data : {'op' : 'ajaxadd' , 'cuid' : cuid, 'random' : Math.random()},
					success : function(msg){	
					   if(msg == -1){
						   showErrorMsg('参数错误！');
					   } else if (msg == 0){
						   showErrorMsg('关注失败，没有该用户！');
					   } else if (msg == 1){
						   showErrorMsg('关注失败，您已经关注了该用户！');
					   } else if (msg == 2){
						   $('#ConcernBtn').val('已关注');
						   $('#ConcernBtn').attr('rel','delConcern');
						   showSucceedMsg('关注成功!');
					   } else if (msg == 3){
						   showErrorMsg('未知错误');
					   }
					}
				});	
			} else if ( type == 'delConcern'){
				$.ajax({
					type : 'get',
					url  : url,
					data : {'op' : 'ajaxdel' , 'cuid' : cuid, 'random' : Math.random()},
					success : function(msg){
					   if(msg == 0){
						   showErrorMsg('参数错误！','消息提示');
					   } else if (msg == 1){
						   showErrorMsg('操作失败，请尝试刷新页面重试！','消息提示');
					   } else if (msg == 2){
						   $('#ConcernBtn').val('加关注');
						   $('#ConcernBtn').attr('rel','addConcern');
						   showSucceedMsg('成功取消关注！','消息提示');
					   } else if (msg == 3){
						   showErrorMsg('未知错误！','消息提示'); 
					   }
					}
				});	
			}
	});					   
});

//加好友
function addFriend(fuid, url){
	if(fuid == '' || fuid.length == 0){
		showErrorMsg('缺少参数！','信息提示');
		return false;
	}
	$.ajax({
		   type : 'get',
		   url : url,
		   data : {'op' : 'add', 'fuid' : fuid , 'random' : Math.random()},
		   success : function(msg){
				if(msg == -1){
					showErrorMsg('参数错误！','消息提示');
				} else if (msg == -2){
					showErrorMsg('添加好友失败,没有该用户的信息！','消息提示');
				} else if (msg == -3){
					showErrorMsg('添加好友失败,你不能添加自己为好友！','消息提示');
				} else if (msg == -4){
					showErrorMsg('添加好友未知错误,该错误已被记录！','消息提示');
				} else if (msg == -5){
					showErrorMsg('添加好友失败,你之前已经发送过好友请求,请耐心等待对方同意申请！','消息提示');
				} else if (msg == -6){
					showErrorMsg('添加好友失败,你们已经是好友了！','消息提示');
				} else {
					$.cover(true);
					asyncbox.open({
						id : 'addFriend',
						title : '添加好友',
						url : url,
						data : {'op' : 'add', 'fuid' : fuid , 'random' : Math.random()},
						width : 490,
						height : 180,
						scroll : 'no',
						callback : function(action) {
							if (action == 'close'){
								$.cover(false);
							}	
						}
					});	
				}
		   }
	});	
	
}

//发送短消息
function postMessage(msguid, url){
	if(msguid == '' || msguid.length == 0){
		showErrorMsg('缺少参数！','信息提示');
		return false;
	}
	
	$.ajax({
		   type : 'post',
		   url : url,
		   data : {'op' : 'ajaxpost', 'msguid' : msguid , 'random' : Math.random()},
		   success : function(msg){
				if(msg == -1){
					showErrorMsg('发送失败，缺少收件人对象！','消息提示');
				} else if(msg == -2){
					showErrorMsg('发送失败，自己不能给自己发送短消息！','消息提示');
				} else {
					$.cover(true);
					asyncbox.open({
						id : 'postMessage',
						title : '发送短消息',
						url : url,
						data : {'op' : 'ajaxpost', 'msguid' : msguid , 'random' : Math.random()},
						width : 510,
						height : 255,
						scroll : 'no',
						callback : function(action) {
							if (action == 'close'){
								$.cover(false);
							}	
						}
					});	
				}
		   }
	});	
}

</script>
<div class="Blog_left">
      <div class="Blog_left1 Blog_bg1">
        <div class="Blog_left1_1">
			<div class="img"></div><!-- 专家博客-->
			<a href="/uid/28541347.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=28541347"><!--                            <img src="http://passport.ixpub.net/avatar.php?uid=28541347&size=middle" />-->
                        </a>
                        <p><a href="/uid/28541347.html">lvyilong316</a></p>
                     </div>
        <ul class="Blog_ul1 Blog_noline1">
          <li>博客访问： 3648453 </li>
          <li>博文数量： 214 </li>
          <li>博客积分： 0 </li>
          <!--<li>专家积分： 180</li>-->
          <li>博客等级： 民兵 </li>
		  <li>技术积分： 7439 </li>
          <li>用  户  组：  普通用户</li>
          <li>注册时间： 2013-01-23 18:56 </li>
                            </ul>  


        
                <div class="HT_line3 HT_line3_1"></div>
        <ul class="Blog_ul2">
          <li><input type="button" value="加关注" id="ConcernBtn" onclick="showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login')"></li>
          <li><input type="button" value="短消息" id="postMessageBtn" onclick="showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login')"></li>
          <li><input type="button" value="论坛" onclick="location.href='http://bbs.chinaunix.net'"></li>
          <li><input type="button" value="加好友" id="addFriendBtn" onclick="showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login')"></li>
        </ul>
              </div>
            <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">个人简介</div>
        <p class="Blog_p3">将晦涩难懂的技术讲的通俗易懂</p>
      </div>
        
         
      <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">文章分类</div>
        <div class="Blog_left2_1">
          <p class="Blog_p4"><a href="/uid/28541347/list/1.html">全部博文</a>（214）</p>
          <ul id="blogCla">
                            <li><a href="/uid/28541347/cid-231595-list-1.html" title="NCCL">NCCL</a>（6）
                                </li>
                            <li><a href="/uid/28541347/cid-231585-list-1.html" title="服务器硬件">服务器硬件</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-231480-list-1.html" title="AI&nbsp;infra">AI&nbsp;infra</a>（11）
                                </li>
                            <li><a href="/uid/28541347/cid-229758-list-1.html" title="网络安全">网络安全</a>（3）
                                </li>
                            <li><a href="/uid/28541347/cid-227016-list-1.html" title="容器技术">容器技术</a>（5）
                                </li>
                            <li><a href="/uid/28541347/cid-227012-list-1.html" title="spdk">spdk</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-225519-list-1.html" title="SDN">SDN</a>（0）
                                </li>
                            <li><a href="/uid/28541347/cid-225402-list-1.html" title="论文">论文</a>（2）
                                </li>
                            <li><a href="/uid/28541347/cid-225401-list-1.html" title="论文">论文</a>（0）
                                </li>
                            <li><a href="/uid/28541347/cid-225372-list-1.html" title="网络大二层">网络大二层</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-225208-list-1.html" title="性能优化">性能优化</a>（6）
                                </li>
                            <li><span class="Blog_jia1"></span><a href="/uid/28541347/cid-224700-list-1.html" title="虚拟化">虚拟化</a>（22）
                                    <div style="display:none;" class="zk">
					                        <p><a href="/uid/28541347/sid-224875-list-1.html" title="qemu-kvm">qemu-kvm</a>（5）</p>
                                        </div>
                                </li>
                            <li><a href="/uid/28541347/cid-224372-list-1.html" title="体系结构">体系结构</a>（5）
                                </li>
                            <li><a href="/uid/28541347/cid-222786-list-1.html" title="dpdk">dpdk</a>（23）
                                </li>
                            <li><a href="/uid/28541347/cid-221175-list-1.html" title="链接、装载与库">链接、装载与库</a>（2）
                                </li>
                            <li><a href="/uid/28541347/cid-219985-list-1.html" title="python">python</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-217845-list-1.html" title="内核网络">内核网络</a>（13）
                                </li>
                            <li><a href="/uid/28541347/cid-210425-list-1.html" title="分布式存储">分布式存储</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-210342-list-1.html" title="Nginx">Nginx</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-209665-list-1.html" title="经典算法">经典算法</a>（1）
                                </li>
                            <li><a href="/uid/28541347/cid-207253-list-1.html" title="学习生活">学习生活</a>（2）
                                </li>
                            <li><a href="/uid/28541347/cid-206683-list-1.html" title="Web">Web</a>（2）
                                </li>
                            <li><a href="/uid/28541347/cid-194662-list-1.html" title="网络编程">网络编程</a>（8）
                                </li>
                            <li><a href="/uid/28541347/cid-194018-list-1.html" title="疑难杂症">疑难杂症</a>（5）
                                </li>
                            <li><a href="/uid/28541347/cid-193253-list-1.html" title="Linux系统使用">Linux系统使用</a>（5）
                                </li>
                            <li><a href="/uid/28541347/cid-192178-list-1.html" title="算法">算法</a>（2）
                                </li>
                            <li><a href="/uid/28541347/cid-192177-list-1.html" title="ASP.NET">ASP.NET</a>（1）
                                </li>
                            <li><span class="Blog_jia1"></span><a href="/uid/28541347/cid-191916-list-1.html" title="linux系统编程">linux系统编程</a>（28）
                                    <div style="display:none;" class="zk">
					                        <p><a href="/uid/28541347/sid-193117-list-1.html" title="epoll">epoll</a>（7）</p>
                                        </div>
                                </li>
                            <li><span class="Blog_jia1"></span><a href="/uid/28541347/cid-174458-list-1.html" title="Linuc/unix">Linuc/unix</a>（36）
                                    <div style="display:none;" class="zk">
					                        <p><a href="/uid/28541347/sid-190255-list-1.html" title="内核">内核</a>（17）</p>
                                        </div>
                                </li>
                            <li><a href="/uid/28541347/cid-173784-list-1.html" title="C/C++">C/C++</a>（18）
                                </li>
                            <li><a href="/uid/28541347/cid--1-list-1.html" title="未分配的博文">未分配的博文</a>（2）
                                </li>
                      </ul>
        </div>
      </div>
      	              <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">文章存档</div>
        <div class="Blog_left2_1" id="blogdtr">
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2025-list-1.html">2025年</a>（6）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-202503-list-1.html">2025年03月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202502-list-1.html">2025年02月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202501-list-1.html">2025年01月</a>（3）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2024-list-1.html">2024年</a>（11）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-202412-list-1.html">2024年12月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202411-list-1.html">2024年11月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202409-list-1.html">2024年09月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202408-list-1.html">2024年08月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202407-list-1.html">2024年07月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202406-list-1.html">2024年06月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202405-list-1.html">2024年05月</a>（1）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2023-list-1.html">2023年</a>（9）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-202311-list-1.html">2023年11月</a>（3）</li>
                        <li><a href="/uid/28541347/year-202308-list-1.html">2023年08月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202307-list-1.html">2023年07月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202306-list-1.html">2023年06月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202305-list-1.html">2023年05月</a>（2）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2022-list-1.html">2022年</a>（4）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-202212-list-1.html">2022年12月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202211-list-1.html">2022年11月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202209-list-1.html">2022年09月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202206-list-1.html">2022年06月</a>（1）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2021-list-1.html">2021年</a>（12）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-202110-list-1.html">2021年10月</a>（4）</li>
                        <li><a href="/uid/28541347/year-202109-list-1.html">2021年09月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202108-list-1.html">2021年08月</a>（3）</li>
                        <li><a href="/uid/28541347/year-202107-list-1.html">2021年07月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202106-list-1.html">2021年06月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202103-list-1.html">2021年03月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202101-list-1.html">2021年01月</a>（1）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2020-list-1.html">2020年</a>（8）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-202011-list-1.html">2020年11月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202008-list-1.html">2020年08月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202007-list-1.html">2020年07月</a>（2）</li>
                        <li><a href="/uid/28541347/year-202006-list-1.html">2020年06月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202005-list-1.html">2020年05月</a>（1）</li>
                        <li><a href="/uid/28541347/year-202004-list-1.html">2020年04月</a>（2）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2019-list-1.html">2019年</a>（18）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201912-list-1.html">2019年12月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201911-list-1.html">2019年11月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201910-list-1.html">2019年10月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201907-list-1.html">2019年07月</a>（4）</li>
                        <li><a href="/uid/28541347/year-201906-list-1.html">2019年06月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201904-list-1.html">2019年04月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201903-list-1.html">2019年03月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201902-list-1.html">2019年02月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201901-list-1.html">2019年01月</a>（2）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2018-list-1.html">2018年</a>（19）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201809-list-1.html">2018年09月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201808-list-1.html">2018年08月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201807-list-1.html">2018年07月</a>（5）</li>
                        <li><a href="/uid/28541347/year-201806-list-1.html">2018年06月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201805-list-1.html">2018年05月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201804-list-1.html">2018年04月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201803-list-1.html">2018年03月</a>（4）</li>
                        <li><a href="/uid/28541347/year-201802-list-1.html">2018年02月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201801-list-1.html">2018年01月</a>（1）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2017-list-1.html">2017年</a>（9）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201711-list-1.html">2017年11月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201710-list-1.html">2017年10月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201705-list-1.html">2017年05月</a>（4）</li>
                        <li><a href="/uid/28541347/year-201704-list-1.html">2017年04月</a>（3）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2016-list-1.html">2016年</a>（26）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201612-list-1.html">2016年12月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201611-list-1.html">2016年11月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201610-list-1.html">2016年10月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201609-list-1.html">2016年09月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201608-list-1.html">2016年08月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201607-list-1.html">2016年07月</a>（6）</li>
                        <li><a href="/uid/28541347/year-201606-list-1.html">2016年06月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201605-list-1.html">2016年05月</a>（4）</li>
                        <li><a href="/uid/28541347/year-201603-list-1.html">2016年03月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201602-list-1.html">2016年02月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201601-list-1.html">2016年01月</a>（1）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2015-list-1.html">2015年</a>（18）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201512-list-1.html">2015年12月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201511-list-1.html">2015年11月</a>（8）</li>
                        <li><a href="/uid/28541347/year-201505-list-1.html">2015年05月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201503-list-1.html">2015年03月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201501-list-1.html">2015年01月</a>（3）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2014-list-1.html">2014年</a>（54）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201412-list-1.html">2014年12月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201411-list-1.html">2014年11月</a>（3）</li>
                        <li><a href="/uid/28541347/year-201410-list-1.html">2014年10月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201408-list-1.html">2014年08月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201407-list-1.html">2014年07月</a>（5）</li>
                        <li><a href="/uid/28541347/year-201406-list-1.html">2014年06月</a>（7）</li>
                        <li><a href="/uid/28541347/year-201405-list-1.html">2014年05月</a>（10）</li>
                        <li><a href="/uid/28541347/year-201404-list-1.html">2014年04月</a>（19）</li>
                        <li><a href="/uid/28541347/year-201403-list-1.html">2014年03月</a>（4）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/28541347/year-2013-list-1.html">2013年</a>（20）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/28541347/year-201310-list-1.html">2013年10月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201309-list-1.html">2013年09月</a>（1）</li>
                        <li><a href="/uid/28541347/year-201307-list-1.html">2013年07月</a>（2）</li>
                        <li><a href="/uid/28541347/year-201304-list-1.html">2013年04月</a>（11）</li>
                        <li><a href="/uid/28541347/year-201303-list-1.html">2013年03月</a>（4）</li>
                        <li><a href="/uid/28541347/year-201301-list-1.html">2013年01月</a>（1）</li>
                      </ul>
                  </div>
      </div>
      	  	        <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">我的朋友</div>
        <ul class="Blog_ul4">
                    <li><a href="/uid/70043869.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70043869"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70043869&size=small" />-->
              </a>
            <p><a href="/uid/70043869.html" title="小杨吃草">小杨吃草</a></p>
          </li>
                    <li><a href="/uid/70011865.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70011865"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70011865&size=small" />-->
              </a>
            <p><a href="/uid/70011865.html" title="yuerxinchen">yuerxinc</a></p>
          </li>
                    <li><a href="/uid/70032180.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70032180"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70032180&size=small" />-->
              </a>
            <p><a href="/uid/70032180.html" title="yadaba">yadaba</a></p>
          </li>
                    <li><a href="/uid/69922962.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=69922962"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=69922962&size=small" />-->
              </a>
            <p><a href="/uid/69922962.html" title="zhangtongjian12">zhangton</a></p>
          </li>
                    <li><a href="/uid/220869.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=220869"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=220869&size=small" />-->
              </a>
            <p><a href="/uid/220869.html" title="coraland">coraland</a></p>
          </li>
                    <li><a href="/uid/70026432.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70026432"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70026432&size=small" />-->
              </a>
            <p><a href="/uid/70026432.html" title="LI112488">LI112488</a></p>
          </li>
                    <li><a href="/uid/70024505.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70024505"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70024505&size=small" />-->
              </a>
            <p><a href="/uid/70024505.html" title="Roadlee">Roadlee</a></p>
          </li>
                    <li><a href="/uid/70023210.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70023210"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70023210&size=small" />-->
              </a>
            <p><a href="/uid/70023210.html" title="Victorzdw">Victorzd</a></p>
          </li>
                    <li><a href="/uid/70021344.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70021344"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70021344&size=small" />-->
              </a>
            <p><a href="/uid/70021344.html" title="龙腾AI技术">龙腾AI技</a></p>
          </li>
                  </ul>
      </div>
	  	        <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">最近访客</div>
        <ul class="Blog_ul4">
                    <li><a href="/uid/70043984.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70043984"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70043984&size=small" />-->
              </a>
            <p><a href="/uid/70043984.html" title="LCAIJUN">LCAIJUN</a></p>
          </li>
                    <li><a href="/uid/70044024.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70044024"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70044024&size=small" />-->
              </a>
            <p><a href="/uid/70044024.html" title="KingdomCS">KingdomC</a></p>
          </li>
                    <li><a href="/uid/26692020.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=26692020"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=26692020&size=small" />-->
              </a>
            <p><a href="/uid/26692020.html" title="gaokeke123">gaokeke1</a></p>
          </li>
                    <li><a href="/uid/70043869.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70043869"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70043869&size=small" />-->
              </a>
            <p><a href="/uid/70043869.html" title="小杨吃草">小杨吃草</a></p>
          </li>
                    <li><a href="/uid/70043760.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70043760"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70043760&size=small" />-->
              </a>
            <p><a href="/uid/70043760.html" title="qunrenzhou302">qunrenzh</a></p>
          </li>
                    <li><a href="/uid/70042299.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70042299"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70042299&size=small" />-->
              </a>
            <p><a href="/uid/70042299.html" title="zf829">zf829</a></p>
          </li>
                    <li><a href="/uid/70043540.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70043540"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70043540&size=small" />-->
              </a>
            <p><a href="/uid/70043540.html" title="justsong">justsong</a></p>
          </li>
                    <li><a href="/uid/70011865.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70011865"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70011865&size=small" />-->
              </a>
            <p><a href="/uid/70011865.html" title="yuerxinchen">yuerxinc</a></p>
          </li>
                    <li><a href="/uid/70043350.html"><img src="http://account.chinaunix.net/api/avatar.php?uid=70043350"><!--              <img src="http://passport.ixpub.net/avatar.php?uid=70043350&size=small" />-->
              </a>
            <p><a href="/uid/70043350.html" title="sybilyi">sybilyi</a></p>
          </li>
                  </ul>
      </div>
	        <!--div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">订阅</div>
        <ul class="Blog_ul5">
          <li><a href="/blog/rss/uid/28541347.html" class="Blog_a4"></a></li>
          <li><a href="http://www.google.com/ig/add?feedurl=http%3A%2F%2Fblog.chinaunix.net%2Fuid%2F28541347.html" class="Blog_a5"></a></li>
        </ul>
      </div-->
            <div class="Blog_left2 Blog_left3 Blog_bg1">
        <div class="Blog_tit1">推荐博文</div>
        <ul class="Blog_ul6">
				  			<li>·<a href="/uid-29578485-id-5886218.html" title="Pytest框架 —— setUp()和tearDown()函数">Pytest框架 —— setUp()和te...</a></li>
		  			<li>·<a href="/uid-70014251-id-5887188.html" title="nginx适配Overlay以及测试工具">nginx适配Overlay以及测试工...</a></li>
		  			<li>·<a href="/uid-31526566-id-5887496.html" title="Linux命令大全之— chown">Linux命令大全之— chown...</a></li>
		  			<li>·<a href="/uid-7655508-id-5887816.html" title="MySQL的RR模式解决不可重复读和幻读了吗？">MySQL的RR模式解决不可重复读...</a></li>
		  			<li>·<a href="/uid-31012107-id-5885962.html" title="shell脚本的调试(trap、tee、shell选项)">shell脚本的调试(trap、tee、...</a></li>
		  						
        </ul>
      </div>
            <!--div class="Blog_left2 Blog_left3 Blog_bg1">
        <div class="Blog_tit1">热词专题</div>
        <ul class="Blog_ul6">
          <!--              <li>·<a href="http://www.dataguru.cn/zhuanti/hadoop220peizhi.shtml" target='blank' title='配置hadoop2.2.0格式化namenode问题'></a></li>
              <li>·<a href="http://www.dataguru.cn/zhuanti/hadoopshouce.shtml" target='blank' title='hadoop2.2.0安装手册'></a></li>-->
        
      
	  
</div>
<script language="javascript">
$(document).ready(function(){
    /*目录树JS效果*/
	$('#blogCla li > span').click(function(){
		var cla = $(this).attr('class');
		if(cla == 'Blog_jia1'){
			//$('#blogCla li > span').removeClass('Blog_jian1').addClass('Blog_jia1');
			//$('#blogCla li > .zk').css('display', 'none');
				
			$(this).removeClass('Blog_jia1').addClass('Blog_jian1');
            $(this).parent().children('.zk').css('display', 'block');
		}else{
			$(this).removeClass('Blog_jian1').addClass('Blog_jia1');
            $(this).parent().children('.zk').css('display', 'none');
		}
	});
		
	$('#blogdtr > p > span').click(function(){
		var cla = $(this).attr('class');
		if(cla == 'Blog_jia1'){
			//$('#blogdtr > .Blog_p4 > span').removeClass('Blog_jian1').addClass('Blog_jia1');
			//$('#blogdtr ul').css('display', 'none');
				
			$(this).removeClass('Blog_jia1').addClass('Blog_jian1');
            $(this).parent().next().css('display', 'block');
		}else{
			$(this).removeClass('Blog_jian1').addClass('Blog_jia1');
            $(this).parent().next().css('display', 'none');
		}
	});
});
</script>
                  <div class="Blog_left2 Blog_left3 Blog_bg1" style="float:left">
            <div class="Blog_tit1">相关博文</div>
            <ul class="Blog_ul6" style="width:208px;padding-left:10px">
                              <li>·<a href="https://blog.itpub.net/70028343/viewspace-3075166/" title="Jtti.cc：ubuntu服务器挂载分区失败怎么办">Jtti.cc：ubuntu服务器挂载分...</a></li>
                              <li>·<a href="https://blog.itpub.net/70017159/viewspace-3075163/" title="Linux服务器Node.js日志轮转策略怎样配置">Linux服务器Node.js日志轮转...</a></li>
                              <li>·<a href="https://blog.itpub.net/70004278/viewspace-3075133/" title="「2024龙蜥社区年度优秀贡献者」榜单公布，恭喜上榜企业和个人">「2024龙蜥社区年度优秀贡献...</a></li>
                              <li>·<a href="https://blog.itpub.net/69952527/viewspace-3075097/" title="Linux工作岗位有哪些？">Linux工作岗位有哪些？...</a></li>
                              <li>·<a href="https://blog.itpub.net/70025954/viewspace-3075056/" title="百度搜索：蓝易云 - Django数据库类库MySQLdb使用详解">百度搜索：蓝易云 - Django数...</a></li>
                              <li>·<a href="https://blog.itpub.net/69952527/viewspace-3074939/" title="在Linux系统中如何查看进程路径？">在Linux系统中如何查看进程路...</a></li>
                              <li>·<a href="https://blog.itpub.net/69952527/viewspace-3074931/" title="Linux运维工程师薪资待遇如何？">Linux运维工程师薪资待遇如何...</a></li>
                              <li>·<a href="https://blog.itpub.net/70025954/viewspace-3074916/" title="百度搜索：蓝易云 - JavaScript中exec()方法详解">百度搜索：蓝易云 - JavaScri...</a></li>
                              <li>·<a href="https://blog.itpub.net/69952527/viewspace-3074853/" title="Linux新手必须知道的命令！">Linux新手必须知道的命令！...</a></li>
                              <li>·<a href="https://blog.itpub.net/69952527/viewspace-3074742/" title="学Linux运维前途好不好？">学Linux运维前途好不好？...</a></li>
                        </ul></div>
        
	</div>

    <!-- 右 -->
    <div class="Blog_right1">
      <div class="Blog_right1_1 Blog_right1_11">
          <div class="img0307"></div><!--推荐博文-->
        <div class="Blog_right1_2 ">
            <div class="tit0307">
                <a href="/uid-28541347-id-5878233.html">DPDK virtio-net加载注意事项</a>
                            </div>
            <div class="tit0307_1">
                                <b class="yuanchuang"></b>
                                <p><span>分类：</span> LINUX</p><p>2023-07-15 19:00:43</p>
            </div>
      
          <div class="Blog_con2">
            <div class="Blog_con3">
              
			                <p></p>
            </div>
           <div class="Blog_wz1" style="word-wrap: break-word;">
						<h1 style="text-align:center;">
	<b><span style="font-family:宋体;font-size:24pt;">DPDK virtio-net加载注意事项</span></b><b><span style="font-family:宋体;font-size:24pt;"></span></b>
</h1>
<div style="text-align:right;">
	<b><span style="font-family:宋体;font-size:14px;">——lvyilong316</span></b>
</div>
<p style="text-align:left;text-indent:21pt;">
	<span style="font-family:宋体;font-size:10.5000pt;"><span>关于</span>DPDK virtio-net pmd<span>的初始化流程我们前文有基于</span><span>DPDK 17.11</span><span>的分析，这篇文章主要介绍下其使用过程中的一些注意事项和加载初始化的细节补充。首先我们回顾一下</span><span>17.11</span><span>的</span><span>virtio-net</span><span>加载流程，如下图所示。而我们今天主要介绍有关的是图中标黄色的部分，即和</span><span>virtio-net pcie</span><span>映射有关的部分。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p style="text-align:center;">
	<img src="/attachment/202307/15/28541347_1689417940s559.jpg" width="700" height="450.47318611987" alt=""><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">&nbsp;&nbsp;<span>我们看下</span>vtpci_init<span>的实现。可以看到对于</span><span>morden</span><span>设备，仅需调用</span></span><span style="font-family:Calibri;font-size:10.5000pt;">virtio_read_caps</span><span style="font-family:宋体;font-size:10.5000pt;"><span>，而对于</span>lagecy<span>设备则需调用</span></span><span style="font-family:Calibri;font-size:10.5000pt;">rte_pci_ioport_map</span><span style="font-family:宋体;font-size:10.5000pt;">。</span>
</p>
<p>
	<br>
</p>
<div>
	<div class="codeheads">
		<p>
			点击(<span style="cursor:pointer;color:red;" .="code_hide('code754')">此处</span>)折叠或打开
		</p>
	</div>
	<div id="code754" class="codeText">
		<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
			<li>
				<span style="color:#000000;"><span style="color:#FF0000;">int</span><br>
</span>
			</li>
			<li>
				vtpci_init<span style="color:#0000CC;">(</span>struct rte_pci_device <span style="color:#0000CC;">*</span>dev<span style="color:#0000CC;">,</span> struct virtio_hw <span style="color:#0000CC;">*</span>hw<span style="color:#0000CC;">)</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">/</span><span style="color:#0000CC;">*</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000CC;">*</span> Try <span style="color:#0000FF;">if</span> we can succeed reading virtio pci caps<span style="color:#0000CC;">,</span> which exists<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000CC;">*</span> only <span style="color:#0000FF;">on</span> modern pci device<span style="color:#0000CC;">.</span> <span style="color:#0000FF;">If</span> failed<span style="color:#0000CC;">,</span> we fallback <span style="color:#0000FF;">to</span> legacy<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000CC;">*</span> virtio handling<span style="color:#0000CC;">.</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000CC;">*</span><span style="color:#0000CC;">/</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>virtio_read_caps<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> hw<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PMD_INIT_LOG<span style="color:#0000CC;">(</span>INFO<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"modern virtio pci detected."</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;virtio_hw_internal<span style="color:#0000CC;">[</span>hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>port_id<span style="color:#0000CC;">]</span><span style="color:#0000CC;">.</span>vtpci_ops <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">&amp;</span>modern_ops<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>modern <span style="color:#0000CC;">=</span> 1<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;PMD_INIT_LOG<span style="color:#0000CC;">(</span>INFO<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"trying with legacy virtio pci."</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>rte_pci_ioport_map<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> 0<span style="color:#0000CC;">,</span> VTPCI_IO<span style="color:#0000CC;">(</span>hw<span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">&lt;</span> 0<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>kdrv <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> RTE_KDRV_UNKNOWN <span style="color:#0000CC;">&amp;</span><span style="color:#0000CC;">&amp;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000CC;">(</span><span style="color:#0000CC;">!</span>dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>device<span style="color:#0000CC;">.</span>devargs <span style="color:#0000CC;">|</span><span style="color:#0000CC;">|</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>device<span style="color:#0000CC;">.</span>devargs<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>bus <span style="color:#0000CC;">!</span><span style="color:#0000CC;">=</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     rte_bus_find_by_name<span style="color:#0000CC;">(</span><span style="color:#FF00FF;">"pci"</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PMD_INIT_LOG<span style="color:#0000CC;">(</span>INFO<span style="color:#0000CC;">,</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF00FF;">"skip kernel managed virtio device."</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000CC;">-</span>1<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;virtio_hw_internal<span style="color:#0000CC;">[</span>hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>port_id<span style="color:#0000CC;">]</span><span style="color:#0000CC;">.</span>vtpci_ops <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">&amp;</span>legacy_ops<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>modern <span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">}</span>
			</li>
		</ol>
	</div>
</div>
<p>
	<br>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">其中</span><span style="font-family:Calibri;font-size:10.5000pt;">virtio_read_caps</span><span style="font-family:宋体;font-size:10.5000pt;"><span>的调用过程如下所示，可以看到根据设备使用的</span>vfio<span>驱动，或者</span><span>igb_uio/uio_pci_generic</span><span>，选择不同的</span><span>map_resource</span><span>函数。下面我们分别解析。</span></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418010cPkC.jpg" width="622" height="346" alt=""><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<h2>
	<b><span style="font-family:黑体;font-size:16pt;">vfio mem map</span></b><b><span style="font-family:黑体;font-size:16pt;"></span></b>
</h2>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>使用</span>vfio<span>时的资源映射主要由函数</span><span>pci_vfio_map_resource</span><span>完成，其主要流程如下图所示：</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p style="text-align:center;">
	<img src="/attachment/202307/15/28541347_1689418056SFco.jpg" width="700" height="550.27247956403" alt=""><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:Calibri;font-size:10.5000pt;">&nbsp;</span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">这里我们针对其中一个个关键问题进行探讨：</span><b><span style="font-family:宋体;font-size:10.5pt;"><span>当我们在虚拟机中为了使用</span>DPDK virtio-net<span>而使用</span><span>vfio</span><span>时，是否一定需要支持</span><span>iommu</span><span>呢？</span></span></b><b><span style="font-family:Calibri;font-size:10.5pt;"></span></b>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">这里我们可以从以下调用逻辑看出关系：</span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">pci_vfio_map_resource--&gt;pci_vfio_map_resource_primary--&gt;rte_vfio_setup_device--&gt;vfio_get_group_no</span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>从</span>rte_vfio_setup_device<span>中可以看出，</span><span>vfio_get_group_no</span><span>如果返回</span><span>0</span><span>则表示这个设备没有被</span><span>vfio</span><span>接管，所以直接返错。</span></span>
</p>
<p>
	<br>
</p>
<div>
	<div class="codeheads">
		<p>
			点击(<span style="cursor:pointer;color:red;" .="code_hide('code970')">此处</span>)折叠或打开
		</p>
	</div>
	<div id="code970" class="codeText">
		<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
			<li>
				<span style="color:#000000;"><span style="color:#FF0000;">int</span><br>
</span>
			</li>
			<li>
				rte_vfio_setup_device<span style="color:#0000CC;">(</span><span style="color:#0000FF;">const</span> char <span style="color:#0000CC;">*</span>sysfs_base<span style="color:#0000CC;">,</span> <span style="color:#0000FF;">const</span> char <span style="color:#0000CC;">*</span>dev_addr<span style="color:#0000CC;">,</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> <span style="color:#0000CC;">*</span>vfio_dev_fd<span style="color:#0000CC;">,</span> struct vfio_device_info <span style="color:#0000CC;">*</span>device_info<span style="color:#0000CC;">)</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;struct vfio_group_status group_status <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">.</span>argsz <span style="color:#0000CC;">=</span> sizeof<span style="color:#0000CC;">(</span>group_status<span style="color:#0000CC;">)</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> vfio_group_fd<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> iommu_group_no<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> ret<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">/</span><span style="color:#0000CC;">*</span> <span style="color:#0000FF;">get</span> group number <span style="color:#0000CC;">*</span><span style="color:#0000CC;">/</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> vfio_get_group_no<span style="color:#0000CC;">(</span>sysfs_base<span style="color:#0000CC;">,</span> dev_addr<span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>iommu_group_no<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>ret <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span>WARNING<span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"  %s not managed by VFIO driver, skipping\n"</span><span style="color:#0000CC;">,</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_addr<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">/</span><span style="color:#0000CC;">/</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">}</span>
			</li>
		</ol>
	</div>
</div>
<p>
	<br>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">&nbsp;&nbsp;<span>而</span></span><span style="font-family:Calibri;font-size:10.5000pt;">vfio_get_group_no</span><span style="font-family:宋体;font-size:10.5000pt;"><span>函数会尝试打开</span>/sys/bus/pci/devices/$bdf/</span><span style="font-family:Calibri;font-size:10.5000pt;">iommu_group</span><span style="font-family:宋体;font-size:10.5000pt;"><span>来获取设备的</span>iommu group<span>，但是如果没有打开</span><span>iommu</span><span>设备是不会被加入</span><span>iommu group</span><span>的。</span></span>
</p>
<p>
	<br>
</p>
<div>
	<div class="codeheads">
		<p>
			点击(<span style="cursor:pointer;color:red;" .="code_hide('code264')">此处</span>)折叠或打开
		</p>
	</div>
	<div id="code264" class="codeText">
		<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
			<li>
				<span style="color:#000000;"><span style="color:#FF0000;">int</span><br>
</span>
			</li>
			<li>
				vfio_get_group_no<span style="color:#0000CC;">(</span><span style="color:#0000FF;">const</span> char <span style="color:#0000CC;">*</span>sysfs_base<span style="color:#0000CC;">,</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">const</span> char <span style="color:#0000CC;">*</span>dev_addr<span style="color:#0000CC;">,</span> <span style="color:#FF0000;">int</span> <span style="color:#0000CC;">*</span>iommu_group_no<span style="color:#0000CC;">)</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">{</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;char linkname<span style="color:#0000CC;">[</span>PATH_MAX<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;char filename<span style="color:#0000CC;">[</span>PATH_MAX<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;char <span style="color:#0000CC;">*</span>tok<span style="color:#0000CC;">[</span>16<span style="color:#0000CC;">]</span><span style="color:#0000CC;">,</span> <span style="color:#0000CC;">*</span>group_tok<span style="color:#0000CC;">,</span> <span style="color:#0000CC;">*</span><span style="color:#0000FF;">end</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> ret<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color:#0000CC;">(</span>linkname<span style="color:#0000CC;">,</span> 0<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>linkname<span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;memset<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">,</span> 0<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">/</span><span style="color:#0000CC;">*</span> try <span style="color:#0000FF;">to</span> find out IOMMU group <span style="color:#0000FF;">for</span> this device <span style="color:#0000CC;">*</span><span style="color:#0000CC;">/</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;snprintf<span style="color:#0000CC;">(</span>linkname<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>linkname<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">"%s/%s/iommu_group"</span><span style="color:#0000CC;">,</span> sysfs_base<span style="color:#0000CC;">,</span> dev_addr<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> readlink<span style="color:#0000CC;">(</span>linkname<span style="color:#0000CC;">,</span> filename<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">/</span><span style="color:#0000CC;">*</span> <span style="color:#0000FF;">if</span> the <span style="color:#FF0000;">link</span> doesn<span style="color:#0000CC;">'</span>t exist<span style="color:#0000CC;">,</span> no VFIO <span style="color:#0000FF;">for</span> us <span style="color:#0000CC;">*</span><span style="color:#0000CC;">/</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>ret <span style="color:#0000CC;">&lt;</span> 0<span style="color:#0000CC;">)</span><br>
			</li>
			<li>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0<span style="color:#0000CC;">;</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">/</span><span style="color:#0000CC;">/</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><br>
			</li>
			<li>
				<span style="color:#0000CC;">}</span>
			</li>
		</ol>
	</div>
</div>
<p>
	<br>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">&nbsp;&nbsp;&nbsp;<span>所以看其来是必须依赖</span>VM<span>内开启</span><span>iommu</span><span>吗？说道</span><span>vm</span><span>开启</span><span>iommu</span><span>其实有两个条件：</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">1.&nbsp;</span><span style="font-family:宋体;font-size:10.5000pt;">Qemu<span>虚拟化支持</span><span>viommu</span><span>；</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">2.&nbsp;</span><span style="font-family:宋体;font-size:10.5000pt;">VM OS<span>内部开启</span><span>iommu</span><span>，如下图所示：</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418166dVk3.png" width="700" height="147.46666666667" alt=""><span style="font-family:宋体;font-size:10.5000pt;">&nbsp;&nbsp;&nbsp;</span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">&nbsp;&nbsp;<span>但是目前</span>qemu<span>支持</span><span>viomm</span><span>由于稳定性和性能问题很少使用，所以一般情况是不支持的，所以仅仅</span><span>OS</span><span>开启</span><span>iommu</span><span>是没有什么意义的，如下图所示，</span><span>OS</span><span>开启</span><span>iommu</span><span>后直接绑定设备到</span><span>vfio-pci</span><span>是有问题的。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:Calibri;font-size:10.5000pt;"><img src="/attachment/202307/15/28541347_1689418238We2W.png" width="700" height="62.066666666667" alt="">&nbsp;</span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">内核会打印如下日志：</span><span style="font-family:宋体;font-size:10.5000pt;"><br>
</span><span style="font-family:宋体;font-size:10.5000pt;">Jul&nbsp;&nbsp;9&nbsp;01:04:28&nbsp;localhost&nbsp;kernel:&nbsp;vfio-pci:&nbsp;probe&nbsp;of&nbsp;0000:00:06.0&nbsp;failed&nbsp;with&nbsp;error&nbsp;-22</span><span style="font-family:宋体;font-size:10.5000pt;"><br>
</span><span style="font-family:宋体;font-size:10.5000pt;">对应内核代码如下：<br>
	</span></p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code961')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code961" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;">static <span style="color:#FF0000;">int</span> vfio_pci_probe<span style="color:#0000CC;">(</span>struct pci_dev <span style="color:#0000CC;">*</span>pdev<span style="color:#0000CC;">,</span> <span style="color:#0000FF;">const</span> struct pci_device_id <span style="color:#0000CC;">*</span>id<span style="color:#0000CC;">)</span><br>
</span>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> ret<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>pdev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>hdr_type <span style="color:#0000CC;">!</span><span style="color:#0000CC;">=</span> PCI_HEADER_TYPE_NORMAL<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000CC;">-</span>EINVAL<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;group <span style="color:#0000CC;">=</span> vfio_iommu_group_get<span style="color:#0000CC;">(</span><span style="color:#0000CC;">&amp;</span>pdev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>dev<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span><span style="color:#0000CC;">!</span>group<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000CC;">-</span>EINVAL<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> vfio_add_group_dev<span style="color:#0000CC;">(</span><span style="color:#0000CC;">&amp;</span>pdev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>dev<span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>vfio_pci_ops<span style="color:#0000CC;">,</span> vdev<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>ret<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vfio_iommu_group_put<span style="color:#0000CC;">(</span>group<span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>pdev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>dev<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kfree<span style="color:#0000CC;">(</span>vdev<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<span style="font-family:宋体;font-size:10.5000pt;"></span>
<p></p>
<p style="margin-left:0.0000pt;text-indent:0.0000pt;background:#F6F6F6;">
	<br>
</p>
<p>
	<span style="font-family:Calibri;font-size:10.5000pt;">22<span>是</span><span>EINVAL</span><span>，看代码是</span><span>iommu group</span><span>导致的，再分析是因为机器没有</span><span>iommu</span><span>硬件单元，意思就是</span><span>qemu</span><span>没有模拟出</span><span>iommu</span><span>硬件单元，把模拟的</span><span>iommu</span><span>称为虚拟的</span><span>iommu</span><span>，就是</span><span>viommu</span><span>。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p style="text-indent:21.0000pt;">
	<span style="font-family:宋体;font-size:10.5000pt;"><span>那是不是</span>qemu<span>不支持</span><span>viommu</span><span>，我们就无法在</span><span>vm</span><span>中使用</span><span>vfio</span><span>了呢？其实也不是这样，</span><span>vfio</span><span>模块有一个</span><span>noiommu_mode</span><span>的选项，如下所示，开启这个选项后设备即可绑定</span><span>vfio-pci</span><span>。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p style="text-indent:21.0000pt;">
	<span style="font-family:Calibri;font-size:10.5000pt;"><img src="/attachment/202307/15/28541347_1689418345i331.png" width="700" height="269.73333333333" alt="">&nbsp;</span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>绑定后设备也会生成对应的</span>iommu_group<span>，只是都是</span><span>0</span><span>，如下图所示</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418363qSKc.png" width="700" height="146.06666666667" alt=""><span style="font-family:Calibri;font-size:10.5000pt;">&nbsp;</span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>而如果</span>vfio<span>开启了</span><span>noiommu_mode</span><span>，系统</span><span>OS</span><span>是否开启</span><span>iommu</span><span>也无所谓。</span></span>
</p>
<h2>
	<b><span style="font-family:黑体;font-size:16pt;">uio mem map</span></b><b><span style="font-family:黑体;font-size:16pt;"></span></b>
</h2>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>使用</span>igb_uio<span>或</span><span>uio_pci_generic</span><span>时的资源映射流程主要工作由</span><span>pci_uio_map_resource</span><span>来完成，其主要流程如下所示。</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418396x9iF.jpg" width="700" height="506.4264849075" alt=""><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>其中用于保存</span>uio<span>场景映射资源的关键结构</span><span>maped_pci_resource</span><span>如下所示。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418420w6fB.jpg" width="700" height="213.36538461538" alt=""><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>其中的每一个</span>pci_map<span>结构对应设备的一个可用的</span><span>BAR</span><span>空间，</span><span>PCI</span><span>设备{BANNED}最佳大可用支持</span><span>6</span><span>个</span><span>BAR</span><span>空间，但是设备并不一定全部使用，这个可以通过读取设备的</span><span>resource</span><span>查看地址是否为</span><span>0</span><span>确认。如果设备使用了</span><span>BAR0</span><span>，则</span><span>reource</span><span>的第</span><span>1</span><span>行地址就不为</span><span>0</span><span>，并对应在设备目录下有</span><span>resource0</span><span>这个文件，但是注意这个文件是不能直接读取的。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418573CiqZ.png" width="700" height="303.39943342776" alt=""><span style="font-family:Calibri;font-size:10.5000pt;">&nbsp;</span><b><span style="font-family:黑体;font-size:16pt;">pio map</span></b>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">在</span><span style="font-family:Calibri;font-size:10.5000pt;">virtio_read_caps</span><span style="font-family:宋体;font-size:10.5000pt;"><span>有如下逻辑，如果设备没有以下对应的</span>CAPABILITY_LIST<span>，则不认为是一个</span><span>morden</span><span>设备，而是一个</span><span>lagecy</span><span>设备。</span></span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code160')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code160" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;"><span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>common_cfg <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span> <span style="color:#0000CC;">|</span><span style="color:#0000CC;">|</span> hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>notify_base <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span> <span style="color:#0000CC;">|</span><span style="color:#0000CC;">|</span><br>
</span>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;    hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>dev_cfg <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span> <span style="color:#0000CC;">|</span><span style="color:#0000CC;">|</span> hw<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>isr <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PMD_INIT_LOG<span style="color:#0000CC;">(</span>INFO<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"no modern virtio pci device found."</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000CC;">-</span>1<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">这种情况就会调用</span><span style="font-family:Calibri;font-size:10.5000pt;">rte_pci_ioport_map</span><span style="font-family:宋体;font-size:10.5000pt;"><span>进行</span>io<span>资源映射（我们在</span><span>vfio</span><span>的</span><span>mem</span><span>资源映射过程中可以看到</span><span>vfio</span><span>是跳过</span><span>io BAR</span><span>的映射的），又会因为使用</span><span>vfio</span><span>和</span><span>uio</span><span>的不同调用不同的函数。</span></span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code36')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code36" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;"><span style="color:#FF0000;">int</span><br>
</span>
				</li>
				<li>
					rte_pci_ioport_map<span style="color:#0000CC;">(</span>struct rte_pci_device <span style="color:#0000CC;">*</span>dev<span style="color:#0000CC;">,</span> <span style="color:#FF0000;">int</span> bar<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct rte_pci_ioport <span style="color:#0000CC;">*</span>p<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> ret <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">-</span>1<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;switch <span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>kdrv<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					#ifdef VFIO_PRESENT<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">case</span> RTE_KDRV_VFIO<span style="color:#0000CC;">:</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>pci_vfio_is_enabled<span style="color:#0000CC;">(</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> pci_vfio_ioport_map<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> bar<span style="color:#0000CC;">,</span> p<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#endif<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">case</span> RTE_KDRV_IGB_UIO<span style="color:#0000CC;">:</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> pci_uio_ioport_map<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> bar<span style="color:#0000CC;">,</span> p<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">case</span> RTE_KDRV_UIO_GENERIC<span style="color:#0000CC;">:</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">if</span> defined<span style="color:#0000CC;">(</span>RTE_ARCH_X86<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> pci_ioport_map<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> bar<span style="color:#0000CC;">,</span> p<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">else</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> pci_uio_ioport_map<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> bar<span style="color:#0000CC;">,</span> p<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#endif<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">case</span> RTE_KDRV_NONE<span style="color:#0000CC;">:</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">if</span> defined<span style="color:#0000CC;">(</span>RTE_ARCH_X86<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="color:#0000CC;">=</span> pci_ioport_map<span style="color:#0000CC;">(</span>dev<span style="color:#0000CC;">,</span> bar<span style="color:#0000CC;">,</span> p<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#endif<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;default<span style="color:#0000CC;">:</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span><span style="color:#0000CC;">!</span>ret<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>dev <span style="color:#0000CC;">=</span> dev<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;return ret<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>这里面问题是当使用</span>uio<span>时需要注意两点：</span></span><span style="font-family:宋体;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">1.&nbsp;</span><span style="font-family:宋体;font-size:10.5000pt;"><span>如果是</span>x86<span>环境，</span><span>pci_uio_ioport_map</span><span>会通过以下路径获取对应的</span><span>BAR</span><span>的</span><span>pio</span><span>地址：</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:Calibri;font-size:10.5000pt;">/sys/bus/pci/devices</span><span style="font-family:Calibri;font-size:10.5000pt;">/$bdf/uio</span><span style="font-family:宋体;font-size:10.5000pt;">/portio/port%d/start<span>，如果是其他架构（比如</span><span>arm</span><span>）则是从</span></span><span style="font-family:Calibri;font-size:10.5000pt;">/</span><span style="font-family:Calibri;font-size:10.5000pt;">sys/bus/pci/devices/$bdf/resource</span><span style="font-family:宋体;font-size:10.5000pt;"><span>找</span>pio BAR<span>进行映射。但在新版本的</span><span>DPDK</span><span>（</span><span>21.05</span><span>后），对这两种方式进行了统一，都是使用</span><span>sys</span><span>下的</span><span>resource</span><span>进行映射；</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p style="margin-left:0.0000pt;text-indent:0.0000pt;">
	<span style="font-family:宋体;font-size:10.5000pt;">2.&nbsp;</span><span style="font-family:宋体;font-size:10.5000pt;"><span>通过</span>1<span>可以看到无论是哪种方式</span><span>DPDK</span><span>都认为</span><span>lagecy</span><span>设备的</span><span>BAR</span><span>必须是一个</span><span>PIO BAR</span><span>，但这并不符合</span><span>virtio</span><span>规范，</span><span>virtio</span><span>中也没有这么规定，只是早期纯软件虚拟化大家也基本都是这么实现的。但是随着智能网卡、</span><span>DPU</span><span>的普及，这种</span><span>PIO</span><span>方式实现</span><span>BAR</span><span>的方式不再适用，因为对应</span><span>x86</span><span>来说，</span><span>PIO</span><span>的地址空间十分有限，如果都使用</span><span>PIO</span><span>作为设备</span><span>BAR</span><span>，则支持设备的数量将十分受限。因此基于智能网卡的很多实现也将</span><span>lagecy</span><span>设备的</span><span>BAR</span><span>实现为了</span><span>mmio</span><span>方式。但由于</span><span>DPDK</span><span>早期的实现，在</span><span>21.05</span><span>版本之前，如果使用</span><span>uio</span><span>是无法支持的。针对这点新版本的</span><span>DPDK</span><span>也做了修改。因此在这种智能网卡的虚拟化环境如果遇到这种问题，要么升级</span><span>DPDK</span><span>版本继续用</span><span>uio</span><span>，要么就改用</span><span>vfio</span><span>。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;">&nbsp;</span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>以下是对比</span>DPDK17.11<span>和</span><span>DPDK 22.11</span><span>的实现</span></span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code292')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code292" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;"><span style="color:#FF0000;">int</span><br>
</span>
				</li>
				<li>
					pci_uio_ioport_map<span style="color:#0000CC;">(</span>struct rte_pci_device <span style="color:#0000CC;">*</span>dev<span style="color:#0000CC;">,</span> <span style="color:#FF0000;">int</span> bar<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   struct rte_pci_ioport <span style="color:#0000CC;">*</span>p<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;FILE <span style="color:#0000CC;">*</span>f<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;char buf<span style="color:#0000CC;">[</span>BUFSIZ<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;char filename<span style="color:#0000CC;">[</span>PATH_MAX<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;uint64_t phys_addr<span style="color:#0000CC;">,</span> end_addr<span style="color:#0000CC;">,</span> flags<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> fd<span style="color:#0000CC;">,</span> i<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;void <span style="color:#0000CC;">*</span>addr<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">/</span><span style="color:#0000CC;">*</span> open <span style="color:#0000FF;">and</span> read addresses of the corresponding resource <span style="color:#0000FF;">in</span> sysfs <span style="color:#0000CC;">*</span><span style="color:#0000CC;">/</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;snprintf<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s/"</span> PCI_PRI_FMT <span style="color:#FF00FF;">"/resource"</span><span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rte_pci_get_sysfs_path<span style="color:#0000CC;">(</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span>domain<span style="color:#0000CC;">,</span> dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span>bus<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span>devid<span style="color:#0000CC;">,</span> dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span><span style="color:#0000FF;">function</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;f <span style="color:#0000CC;">=</span> fopen<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"r"</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>f <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"Cannot open sysfs resource: %s\n"</span><span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strerror<span style="color:#0000CC;">(</span>errno<span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000CC;">-</span>1<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">for</span> <span style="color:#0000CC;">(</span>i <span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">;</span> i <span style="color:#0000CC;">&lt;</span> bar <span style="color:#0000CC;">+</span> 1<span style="color:#0000CC;">;</span> i<span style="color:#0000CC;">+</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>fgets<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> f<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"Cannot read sysfs resource\n"</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>pci_parse_one_sysfs_resource<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>phys_addr<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">&amp;</span>end_addr<span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>flags<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">&lt;</span> 0<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span><span style="color:#0000CC;">(</span>flags <span style="color:#0000CC;">&amp;</span> IORESOURCE_IO<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"BAR %d is not an IO resource\n"</span><span style="color:#0000CC;">,</span> bar<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">/</span><span style="color:#0000CC;">/</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>对比</span>DPDK 22.11<span>的实现可以看到无论是</span><span>pio </span><span>（</span></span><span style="font-family:Calibri;font-size:10.5000pt;">IORESOURCE_IO</span><span style="font-family:宋体;font-size:10.5000pt;"><span>）还是</span>mmio<span>（</span></span><span style="font-family:Calibri;font-size:10.5000pt;">&nbsp;IORESOURCE_MEM</span><span style="font-family:宋体;font-size:10.5000pt;"><span>）</span>uio<span>的</span><span>iomap</span><span>都做了支持。</span></span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code126')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code126" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;"><span style="color:#FF0000;">int</span><br>
</span>
				</li>
				<li>
					pci_uio_ioport_map<span style="color:#0000CC;">(</span>struct rte_pci_device <span style="color:#0000CC;">*</span>dev<span style="color:#0000CC;">,</span> <span style="color:#FF0000;">int</span> bar<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   struct rte_pci_ioport <span style="color:#0000CC;">*</span>p<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;FILE <span style="color:#0000CC;">*</span>f <span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;char dirname<span style="color:#0000CC;">[</span>PATH_MAX<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;char filename<span style="color:#0000CC;">[</span>PATH_MAX<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;char buf<span style="color:#0000CC;">[</span>BUFSIZ<span style="color:#0000CC;">]</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;uint64_t phys_addr<span style="color:#0000CC;">,</span> end_addr<span style="color:#0000CC;">,</span> flags<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;unsigned long base<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> i<span style="color:#0000CC;">,</span> fd<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">/</span><span style="color:#0000CC;">*</span> open <span style="color:#0000FF;">and</span> read addresses of the corresponding resource <span style="color:#0000FF;">in</span> sysfs <span style="color:#0000CC;">*</span><span style="color:#0000CC;">/</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;snprintf<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s/"</span> PCI_PRI_FMT <span style="color:#FF00FF;">"/resource"</span><span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rte_pci_get_sysfs_path<span style="color:#0000CC;">(</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span>domain<span style="color:#0000CC;">,</span> dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span>bus<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span>devid<span style="color:#0000CC;">,</span> dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>addr<span style="color:#0000CC;">.</span><span style="color:#0000FF;">function</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;f <span style="color:#0000CC;">=</span> fopen<span style="color:#0000CC;">(</span>filename<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"r"</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>f <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s(): Cannot open sysfs resource: %s\n"</span><span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__func__<span style="color:#0000CC;">,</span> strerror<span style="color:#0000CC;">(</span>errno<span style="color:#0000CC;">)</span><span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <span style="color:#0000CC;">-</span>1<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">for</span> <span style="color:#0000CC;">(</span>i <span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">;</span> i <span style="color:#0000CC;">&lt;</span> bar <span style="color:#0000CC;">+</span> 1<span style="color:#0000CC;">;</span> i<span style="color:#0000CC;">+</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>fgets<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> f<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">=</span><span style="color:#0000CC;">=</span> <span style="color:#0000FF;">NULL</span><span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s(): Cannot read sysfs resource\n"</span><span style="color:#0000CC;">,</span> __func__<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>pci_parse_one_sysfs_resource<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">,</span> sizeof<span style="color:#0000CC;">(</span>buf<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>phys_addr<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">&amp;</span>end_addr<span style="color:#0000CC;">,</span> <span style="color:#0000CC;">&amp;</span>flags<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">&lt;</span> 0<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>flags <span style="color:#0000CC;">&amp;</span> IORESOURCE_IO<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">(</span>unsigned long<span style="color:#0000CC;">)</span>phys_addr<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>base <span style="color:#0000CC;">&gt;</span> PIO_MAX<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s(): %08lx too large PIO resource\n"</span><span style="color:#0000CC;">,</span> __func__<span style="color:#0000CC;">,</span> base<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span>DEBUG<span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s(): PIO BAR %08lx detected\n"</span><span style="color:#0000CC;">,</span> __func__<span style="color:#0000CC;">,</span> base<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span> <span style="color:#0000FF;">else</span> <span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>flags <span style="color:#0000CC;">&amp;</span> IORESOURCE_MEM<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">(</span>unsigned long<span style="color:#0000CC;">)</span>dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>mem_resource<span style="color:#0000CC;">[</span>bar<span style="color:#0000CC;">]</span><span style="color:#0000CC;">.</span>addr<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span>DEBUG<span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s(): MMIO BAR %08lx detected\n"</span><span style="color:#0000CC;">,</span> __func__<span style="color:#0000CC;">,</span> base<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span> <span style="color:#0000FF;">else</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span> <span style="color:#FF00FF;">"%s(): unknown BAR type\n"</span><span style="color:#0000CC;">,</span> __func__<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto <span style="color:#0000FF;">error</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">/</span><span style="color:#0000CC;">/</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><span style="color:#0000CC;">.</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>相关</span>patch<span>为：</span></span><a href="https://lore.kernel.org/dpdk-dev/b34311c7-5b09-a1f6-1957-c9e19bb2a273@intel.com/T/"><span style="font-family:宋体;color:#2980B9;">https://lore.kernel.org/dpdk-dev/b34311c7-5b09-a1f6-1957-c9e19bb2a273@intel.com/T/</span></a>
</p>
<h2>
	<b><span style="font-family:黑体;font-size:16pt;">中断通知</span></b><b><span style="font-family:黑体;font-size:16pt;"></span></b>
</h2>
<p style="text-indent:21.0000pt;">
	<span style="font-family:宋体;font-size:10.5000pt;"><span>下面看一下，如果前端</span>DPDK<span>使用</span><span>virtio-net pmd</span><span>，在收发包过程中</span><span>notify</span><span>后端的问题。首先</span><span>lagecy</span><span>设备和</span><span>modern</span><span>设备</span><span>notify</span><span>后端的流程是不一样的。</span><span>lagecy</span><span>设备根据使用</span><span>vfio</span><span>还是</span><span>uio</span><span>调用如下。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<img src="/attachment/202307/15/28541347_1689418741jDTG.jpg" width="365" height="256" alt=""><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>其中</span>vfio<span>会调用</span></span><span style="font-family:Calibri;font-size:10.5000pt;">pci_vfio_ioport_write</span><span style="font-family:宋体;font-size:10.5000pt;">。</span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code170')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code170" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;">void<br>
</span>
				</li>
				<li>
					pci_vfio_ioport_write<span style="color:#0000CC;">(</span>struct rte_pci_ioport <span style="color:#0000CC;">*</span>p<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">const</span> void <span style="color:#0000CC;">*</span>data<span style="color:#0000CC;">,</span> size_t <span style="color:#FF0000;">len</span><span style="color:#0000CC;">,</span> off_t offset<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">const</span> struct rte_intr_handle <span style="color:#0000CC;">*</span>intr_handle <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">&amp;</span>p<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>dev<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>intr_handle<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span>pwrite64<span style="color:#0000CC;">(</span>intr_handle<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>vfio_dev_fd<span style="color:#0000CC;">,</span> data<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF0000;">len</span><span style="color:#0000CC;">,</span> p<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>base <span style="color:#0000CC;">+</span> offset<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">&lt;</span><span style="color:#0000CC;">=</span> 0<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RTE_LOG<span style="color:#0000CC;">(</span><span style="color:#FF0000;">ERR</span><span style="color:#0000CC;">,</span> EAL<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF00FF;">"Can't write to PCI bar (%"</span> PRIu64 <span style="color:#FF00FF;">") : offset (%x)\n"</span><span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VFIO_GET_REGION_IDX<span style="color:#0000CC;">(</span>p<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>base<span style="color:#0000CC;">)</span><span style="color:#0000CC;">,</span> <span style="color:#0000CC;">(</span><span style="color:#FF0000;">int</span><span style="color:#0000CC;">)</span>offset<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>可以看到</span>lagecy<span>设备如果使用</span><span>vfio</span><span>的情况会使用</span><span>pwrite</span><span>写文件</span><span>fd</span><span>的方式进行</span><span>notify</span><span>，这个</span></span><b><span style="font-family:宋体;color:#0000FF;font-size:10.5pt;"><span>在流量较大的情况会产生较高的</span>sys<span>开销</span></span></b><span style="font-family:宋体;font-size:10.5000pt;"><span>。而在</span>uio<span>时调用的是</span></span><span style="font-family:Calibri;font-size:10.5000pt;">pci_uio_ioport_write</span><span style="font-family:宋体;font-size:10.5000pt;"><span>，如下所示，是通过内存映射方式</span>notify<span>，因此不会有系统调用开销。</span></span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code491')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code491" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;">void<br>
</span>
				</li>
				<li>
					pci_uio_ioport_write<span style="color:#0000CC;">(</span>struct rte_pci_ioport <span style="color:#0000CC;">*</span>p<span style="color:#0000CC;">,</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">const</span> void <span style="color:#0000CC;">*</span>data<span style="color:#0000CC;">,</span> size_t <span style="color:#FF0000;">len</span><span style="color:#0000CC;">,</span> off_t offset<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">const</span> uint8_t <span style="color:#0000CC;">*</span>s<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#FF0000;">int</span> size<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;uintptr_t reg <span style="color:#0000CC;">=</span> p<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>base <span style="color:#0000CC;">+</span> offset<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">for</span> <span style="color:#0000CC;">(</span>s <span style="color:#0000CC;">=</span> data<span style="color:#0000CC;">;</span> <span style="color:#FF0000;">len</span> <span style="color:#0000CC;">&gt;</span> 0<span style="color:#0000CC;">;</span> s <span style="color:#0000CC;">+</span><span style="color:#0000CC;">=</span> size<span style="color:#0000CC;">,</span> reg <span style="color:#0000CC;">+</span><span style="color:#0000CC;">=</span> size<span style="color:#0000CC;">,</span> <span style="color:#FF0000;">len</span> <span style="color:#0000CC;">-</span><span style="color:#0000CC;">=</span> size<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span><span style="color:#FF0000;">len</span> <span style="color:#0000CC;">&gt;</span><span style="color:#0000CC;">=</span> 4<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color:#0000CC;">=</span> 4<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">if</span> defined<span style="color:#0000CC;">(</span>RTE_ARCH_X86<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outl_p<span style="color:#0000CC;">(</span><span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span><span style="color:#0000FF;">const</span> uint32_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>s<span style="color:#0000CC;">,</span> reg<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">else</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span>volatile uint32_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>reg <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span><span style="color:#0000FF;">const</span> uint32_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>s<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#endif<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span> <span style="color:#0000FF;">else</span> <span style="color:#0000FF;">if</span> <span style="color:#0000CC;">(</span><span style="color:#FF0000;">len</span> <span style="color:#0000CC;">&gt;</span><span style="color:#0000CC;">=</span> 2<span style="color:#0000CC;">)</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color:#0000CC;">=</span> 2<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">if</span> defined<span style="color:#0000CC;">(</span>RTE_ARCH_X86<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outw_p<span style="color:#0000CC;">(</span><span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span><span style="color:#0000FF;">const</span> uint16_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>s<span style="color:#0000CC;">,</span> reg<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">else</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span>volatile uint16_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>reg <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span><span style="color:#0000FF;">const</span> uint16_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>s<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#endif<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span> <span style="color:#0000FF;">else</span> <span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size <span style="color:#0000CC;">=</span> 1<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">if</span> defined<span style="color:#0000CC;">(</span>RTE_ARCH_X86<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outb_p<span style="color:#0000CC;">(</span><span style="color:#0000CC;">*</span>s<span style="color:#0000CC;">,</span> reg<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#<span style="color:#0000FF;">else</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">*</span><span style="color:#0000CC;">(</span>volatile uint8_t <span style="color:#0000CC;">*</span><span style="color:#0000CC;">)</span>reg <span style="color:#0000CC;">=</span> <span style="color:#0000CC;">*</span>s<span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					#endif<br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000CC;">}</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p style="text-indent:21.0000pt;">
	<span style="font-family:宋体;font-size:10.5000pt;"><span>如果是</span>modern<span>设备，其</span><span>notify</span><span>统一如下，采用内存映射直接访问地址的方式，也不会存在系统调用开销。</span></span>
</p>
<p>
	</p><div>
		<div class="codeheads">
			<p>
				点击(<span style="cursor:pointer;color:red;" .="code_hide('code433')">此处</span>)折叠或打开
			</p>
		</div>
		<div id="code433" class="codeText">
			<ol style="margin:0 1px 0 0px;padding-left:40px;" start="1" class="dp-css">
				<li>
					<span style="color:#000000;">static void<br>
</span>
				</li>
				<li>
					modern_notify_queue<span style="color:#0000CC;">(</span>struct virtio_hw <span style="color:#0000CC;">*</span>hw __rte_unused<span style="color:#0000CC;">,</span> struct virtqueue <span style="color:#0000CC;">*</span>vq<span style="color:#0000CC;">)</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">{</span><br>
				</li>
				<li>
					&nbsp;&nbsp;&nbsp;&nbsp;rte_write16<span style="color:#0000CC;">(</span>vq<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>vq_queue_index<span style="color:#0000CC;">,</span> vq<span style="color:#0000CC;">-</span><span style="color:#0000CC;">&gt;</span>notify_addr<span style="color:#0000CC;">)</span><span style="color:#0000CC;">;</span><br>
				</li>
				<li>
					<span style="color:#0000CC;">}</span>
				</li>
			</ol>
		</div>
	</div>
<p></p>
<p>
	<span style="font-family:宋体;font-size:10.5000pt;"><span>当前我们如果在</span>vm<span>内部使用</span><span>DPDK</span><span>，又要使用</span><span>vfio</span><span>，为了避免</span><span>notify</span><span>引入的系统开销，可以关闭</span><span>event_idx feature</span><span>，这样就不需要前端去</span><span>notify</span><span>后端了。</span></span><span style="font-family:Calibri;font-size:10.5000pt;"></span>
</p>                                   </div>
            <!-- <div class="Blog_con3_1">管理员在2009年8月13日编辑了该文章文章。</div> -->
            <div class="Blog_con2_1 Blog_con3_2">
              <div>
			  <!--<img src="/image/default/tu_8.png">-->
			  <!-- JiaThis Button BEGIN -->
				<div class="bdsharebuttonbox bdshare-button-style0-16" data-bd-bind="1741597556284"><a class="bds_more" href="#" data-cmd="more"></a><a class="bds_qzone" title="分享到QQ空间" href="#" data-cmd="qzone"></a><a class="bds_tsina" title="分享到新浪微博" href="#" data-cmd="tsina"></a><a class="bds_tqq" title="分享到腾讯微博" href="#" data-cmd="tqq"></a><a class="bds_renren" title="分享到人人网" href="#" data-cmd="renren"></a><a class="bds_weixin" title="分享到微信" href="#" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
				<!-- JiaThis Button END -->
			  </div>
              阅读(31806) | 评论(0) | 转发(0) |
			                <div class="HT_line3"></div>
            </div>
            
            <div class="Blog_con3_3">
              <div><span id="digg_num">0</span><a href="javascript:void(0)" id="digg" bid="5878233" url="/blog/digg.html"></a></div>
              <p>上一篇：<a href="/uid-28541347-id-5877488.html">DPDK 22.11内存管理变化解析</a></p>
              <p>下一篇：<a href="/uid-28541347-id-5879366.html">virtio-mmio实现分析</a></p>    
            </div>
            
          </div>
          		  <!--
          <div class="Blog_con3_4 Blog_con3_5">
            <div class="Blog_tit2 Blog_tit7">热门推荐</div>
            <ul>
			              <li><a href="" title="" target='blank' ></a></li>
			            </ul>
          </div>
		  -->
        </div>
      </div>
      <div class="Blog_right1_7" id="replyList">
		<div class="Blog_tit3">给主人留下些什么吧！~~</div>
				<!--暂无内容-->
				<!-- 评论分页-->
		<div class="Blog_right1_6 Blog_right1_12">
        		</div>
		<!-- 评论分页-->
        <div class="Blog_right1_10" style="display:none">
          <div class="Blog_tit3">评论热议</div>
		  		 <!--未登录 -->
        <div class="Blog_right1_8">
          <div class="nologin_con1"> 请登录后评论。
            <p><a href="http://account.chinaunix.net/login" onclick="link(this)">登录</a> <a href="http://account.chinaunix.net/register?url=http%3a%2f%2fblog.chinaunix.net">注册</a></p>
          </div>
        </div>
       
		
        </div>
        <div style="text-align:center;margin-top:10px;">
            <script type="text/javascript" smua="d=p&amp;s=b&amp;u=u3118759&amp;w=960&amp;h=90" src="//www.nkscdn.com/smu0/o.js"></script>
        </div>
      </div>
    </div>
  </div>
  <input type="hidden" id="report_url" value="/blog/ViewReport.html">

<script type="text/javascript">
  	//测试字符串的长度 一个汉字算2个字节
	function mb_strlen(str)
	{
		var len=str.length;
		var totalCount=0;
		for(var i=0;i<len;i++)
		{
			var c = str.charCodeAt(i);
			if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) {
				totalCount++;
			}else{
				totalCount+=2;
			}
		}
		return totalCount;
	}
	/*
	var Util = {};
	Util.calWbText = function (text, max){
		if(max === undefined)
			max = 500;
		var cLen=0;
		var matcher = text.match(/[^\x00-\xff]/g),
			wlen  = (matcher && matcher.length) || 0;
		//匹配url链接正则 http://***
		var pattern = /http:\/\/([\w-]+\.)+[\w-]+(\/*[\w-\.\/\?%&=][^\s^\u4e00-\u9fa5]*)?/gi;
		//匹配的数据存入数组
		var arrPt = new Array();
		var i = 0;
		while((result = pattern.exec(text)) != null){
			arrPt[i] = result[0];
			i++;
		}
		//替换掉原文本中的链接
		for(var j = 0;j<arrPt.length;j++){
			text = text.replace(arrPt[j],"");
		}
		//减掉链接所占的长度
		return Math.floor((max*2 - text.length - wlen)/2 - 12*i);
	};
	*/
	var allowComment = '0';
	
	//举报弹出层
	function showJuBao(url, cid){
		
			$.cover(false);
			asyncbox.open({
				id  : 'report_thickbox',
				url : url,
				title : '举报违规',
				width : 378,
				height : 240,
				scroll : 'no',
				data : {
					'cid'	 : cid,
					'idtype' : 2 ,
                                        'blogurl' : window.location.href
				},
				callback : function(action){
					if(action == 'close'){
						$.cover(false);
					}
				}
			});
	}

	$(function(){

		//创建管理员删除的弹出层
		$('#admin_article_del').click(function(){
			$.cover(false);
			asyncbox.open({
				id : 'class_thickbox',
				html : '<div class="HT_layer3_1"><ul><li class="HT_li1">操作原因：<select class="HT_sel7" id="del_type" name="del_type"><option value="广告文章">广告文章</option><option value="违规内容">违规内容</option><option value="标题不明">标题不明</option><option value="文不对题">文不对题</option></select></li><li class="HT_li1" ><input class="HT_btn4" id="admin_delete"  type="button" /></li></ul></div>',
				title : '选择类型',
				width : 300,
				height : 150,
				scroll : 'no',
				callback : function(action){
					if(action == 'close'){
						$.cover(false);
					}
				}
			});
		});
		$('#admin_delete').live('click' , function(){
			///blog/logicdel/id/3480184/url/%252Fblog%252Findex.html.html
			var type = $('#del_type').val();
			var url = '/blog/logicdel/id/5878233/url/%252Fuid%252F28541347.html.html';
			window.location.href= url + '?type=' + type;
		});


		//顶  js中暂未添加&过滤 
		$('#digg').live('click' , function(){

			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				return false;
			}

			var bid = $('#digg').attr('bid');
			var url = $('#digg').attr('url');

			var digg_str = $.cookie('digg_id');
			if(digg_str != null)
			{
				var arr= new Array(); //定义一数组

				arr = digg_str.split(","); //字符分割     
				for( i=0 ; i < arr.length ; i++ )   
				{   
					if(bid == arr[i])
					{
						showErrorMsg('已经赞过该文章', '消息提示'); 
						return false;
					}
				} 
			}
			$.ajax({
				type:"POST",
				url:url,	
				data: {
					'bid' : bid 
				},
				dataType: 'json',
				success:function(msg){
					if(msg.error == 0)
					{
						var num = parseInt($('#digg_num').html(),10);
						num += 1;
						$('#digg_num').html(num);
						$('#digg').die();

						if(digg_str == null)
						{
							$.cookie('digg_id', bid, {expires: 30 , path: '/'});
						}
						else
						{
							$.cookie('digg_id', digg_str + ',' + bid, {expires: 30 , path: '/'});
						}
						showSucceedMsg('谢谢' , '消息提示');
					}
					else if(msg.error == 1)
					{
						//showErrorMsg(msg.error_content , '消息提示'); 
						showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
					}
					else if(msg.error == 2)
					{
						showErrorMsg(msg.error_content , '消息提示'); 
					}
				}
			});
		});
		//举报弹出层
		/*$('.box_report').live('click' , function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				return false;
			}
			var url = $('#report_url').val();
			var cid = $(this).attr('cid');
			$.cover(false);
			asyncbox.open({
				id  : 'report_thickbox',
				url : url,
				title : '举报违规',
				width : 378,
				height : 240,
				scroll : 'no',
				data : {
					'cid'	 : cid,
					'idtype' : 2 
				},
				callback : function(action){
					if(action == 'close'){
						$.cover(false);
					}
				}
			});
		});*/


		//评论相关代码
		
		//点击回复显示评论框
		$('.Blog_a10').live('click' , function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				return false;
			}

			if(allowComment == 1)
			{
				showErrorMsg('该博文不允许评论' , '消息提示'); 
				return false;
			}
			var tid = $(this).attr('toid');//留言作者id
			var bid = $(this).attr('bid');//blogid
			var cid = $(this).attr('cid');//留言id
			var tname = $(this).attr('tname');
                         			var tpl  = '<div class="Blog_right1_9">';
				tpl +=	 '<div class="div2">';
				tpl +=     '<textarea name="" cols="" rows="" class="Blog_ar1_1" id="rmsg">文明上网，理性发言...</textarea>';
				tpl +=	 '</div>';
				tpl +=   '<div class="div3">';
				tpl +=		'<div class="div3_2"><a href="javascript:void(0);" class="Blog_a11" id="quota_sbumit" url="/Comment/PostComment.html" tid="'+tid+'" bid="'+bid+'" cid="'+cid+'" tname="'+tname+'" ></a><a href="javascript:void(0)" id="qx_comment" class="Blog_a12"></a></div>';
				tpl +=		'<div class="div3_1"><a href="javascript:void(0);" id="mface"><span></span>表情</a></div>';
				tpl +=		'<div class="clear"></div>';
				tpl +=	 '</div>';
				tpl +=  '</div>';
                                 			$('.z_move_comment').html('');
			$(this).parents('.Blog_right1_8').find('.z_move_comment').html(tpl).show();
		});
		//引用的评论提交
		$('#quota_sbumit').live('click' , function(){

			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				return false;
			}

			var bid   = $(this).attr('bid');
			var tid   = $(this).attr('tid');//被引用人的id
			var qid   = $(this).attr('cid');//引用的id
			var url = $(this).attr('url');
			var text = $('#rmsg').val();
			var tname = $(this).attr('tname');
			if(text == '' || text=='文明上网，理性发言...')
			{
				showErrorMsg('评论内容不能为空！' , '消息提示'); 
				return false;
			}
			else
			{
				if(mb_strlen(text) > 1000){
					showErrorMsg('评论内容不能超过500个汉字' , '消息提示'); 
					return false;
				}
			}
		    $.ajax({
		        type: "post",
			    url: url ,
			    data: {'bid': bid , 'to' : tid , 'qid' : qid , 'text': text , 'tname' : tname },
				dataType: 'json',
			    success: function(data){
				    if(data.code == 1){
						var tpl =  '<div class="Blog_right1_8">';
							tpl+=     '<div class="Blog_right_img1"><a href="' +data.info.url+ '" >' + data.info.header + '</a></div>';
							tpl+=     '<div class="Blog_right_font1">';
							tpl+=         '<p class="Blog_p5"><span><a href="' +data.info.url+ '" >' + data.info.username + '</a></span>' + data.info.dateline + '</p>';
							tpl+=         '<p class="Blog_p7"><a href="' + data.info.quota.url + '">' + data.info.quota.username + '</a>：'+ data.info.quota.content + '</p>';
							tpl+=         '<p class="Blog_p8">' + data.info.content + '</p><span class="span_text1"><a href="javascript:void(0);" class="Blog_a10" toid=' + data.info.fuid + ' bid=' + data.info.bid + ' cid=' + data.info.cid + '  tname = ' + data.info.username + ' >回复</a> | 　<a class="comment_del_mark" style="cursor:pointer" url="' + data.info.delurl + '" >删除</a>　| 　<a href="javascript:showJuBao(\'/blog/ViewReport.html\','+data.info.cid+')" class="box_report" cid="' + data.info.cid + '" >举报</a></span></div>';
							tpl+=         '<div class="z_move_comment" style="display:none"></div>';
							tpl+=	      '<div class="Blog_line1"></div></div>';
							$('#replyList .Blog_right1_8:first').before(tpl);
							$('.z_move_comment').html('').hide();
				    }
					else if(data.code == -1){
						//showErrorMsg(data.info , '消息提示'); 
						showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
			        }
                },
			    error: function(){//请求出错处理
                        
                }
			});
		});
		//底部发表评论
		$('#submitmsg').click(function(){
			if(allowComment == 1)
			{
				showErrorMsg('该博文不允许评论' , '消息提示'); 
				return false;
			}
			var bid   = $(this).attr('bid');
			var toid  = $(this).attr('toid');
			var text = $('#reply').val();
			var url = $(this).attr('url');
			if(text == '' || text=='文明上网，理性发言...')
			{
				showErrorMsg('评论内容不能为空！' , '消息提示'); 
				return false;
			}
			else
			{
				if(mb_strlen(text) > 1000){
					showErrorMsg('评论内容不能超过500个汉字' , '消息提示'); 
					return false;
				}
			}
		    $.ajax({
		        type: "post",
			    url: url ,
			    data: {'bid': bid , 'to' : toid ,'text': text},
				dataType: 'json',
			    success: function(data){
				    if(data.code == 1)
					{
						var tpl   = '<div class="Blog_right1_8">';
							tpl  +=   '<div class="Blog_right_img1"><a href="' +data.info.url+ '" >' + data.info.header + '</a></div>';
							tpl  +=	  '<div class="Blog_right_font1">';
							tpl  +=       '<p class="Blog_p5"><span><a href="' +data.info.url+ '" >' + data.info.username + '</a></span>' + data.info.dateline + '</p>';
							tpl  +=       '<p class="Blog_p6">' + data.info.content + '</p>';
							tpl  +=		  '<div class="div1"><a href="javascript:void(0);" class="Blog_a10"  toid=' + data.info.fuid + ' bid=' + data.info.bid + ' cid=' + data.info.cid + '>回复</a> | 　<a class="comment_del_mark" style="cursor:pointer" url="' + data.info.delurl + '">删除</a>　| 　<a href="javascript:showJuBao(\'/blog/ViewReport.html\','+data.info.cid+')" class="box_report" cid="' + data.info.cid + '">举报</a></div>';
							tpl  +=		  '<div class="z_move_comment" style="display:none"></div>';
							tpl  +=    '</div><div class="Blog_line1"></div></div>';
							$('.Blog_tit3:first').after(tpl);
							$('#reply').val('文明上网，理性发言...');
					}
					else if(data.code == -1)
					{
						showErrorMsg(data.info , '消息提示'); 
			        }
                },
			    error: function(){//请求出错处理
                        
                }
		    });
			
		});
		//底部评论重置
		$('#reset_comment').click(function(){
			$('#reply').val('文明上网，理性发言...');
		});
		//取消回复
		$('#qx_comment').live('click' , function(){
			$('.z_move_comment').html('').hide();
		});


		$('#rmsg, #reply').live({
		    focus:function(){
			    if($(this).val() == '文明上网，理性发言...'){
			        $(this).val('');
			    }
			},
			blur:function(){
		        if($(this).val() == ''){
			        $(this).val('文明上网，理性发言...');
			    }
			}
		});
		//删除留言确认
		$('.comment_del_mark').live('click' , function(){
			var url = $(this).attr('url');
			asyncbox.confirm('删除留言','确认', function(action){
				if(action == 'ok')
				{
					location.href = url;
				}
			});
		});
		//删除时间确认
		$('.del_article_id').click(function(){
			var delurl = $(this).attr('delurl');
			asyncbox.confirm('删除文章','确认', function(action){
				if(action == 'ok')
				{
					location.href = delurl;
				}
			});
		});
		/*
		//字数限制
		$('#rmsg, #reply').live('keyup', function(){
			var id = $(this).attr('id');
			var left = Util.calWbText($(this).val(), 500);
			var eid = '#errmsg';
			
			if(id == 'reply') eid =  '#rerrmsg';
			if (left >= 0)
		        $(eid).html('您还可以输入<span>' + left + '</span>字');
		    else
		        $(eid).html('<font color="red">您已超出<span>' + Math.abs(left) + '</span>字 </font>');
		});
		*/
		//加载表情
	    $('#face').qqFace({id : 'facebox1', assign : 'reply', path : '/image/qqface/'});
	    $('#mface').qqFace({id : 'facebox', assign : 'rmsg', path:'/image/qqface/'});
	    
		/*
		$('#class_one_id').change(function(){
			alert(123213);
			var id = parseInt($(this).val() , 10);
			if(id == 0) return false;
			$('.hidden_son_class span').each(function( index , dom ){
				if( dom.attr('cid')  == id )
				{
				}
			});
		});
		*/
		//转载文章
		var turn_url = "/blog/viewClassPart.html";
		$('#repost_bar').click(function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				return false;
			}
			var id = $(this).attr('bid');
			asyncbox.open({
				id  : 'turn_class_thickbox',
				url : turn_url,
				title : '转载文章',
				width : 330,
				height : 131,
				scroll : 'no',
				data : {
					'id'	 : id
				},
				callback : function(action){
					if(action == 'close'){
						$.cover(false);
					}
				}
			});
		});
		/*
	    //转发文章
	    $('#repost_bar').live('click' , function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				return false;
			}
	    	var bid  = $(this).attr('bid');
	    	var url  = $(this).attr('url');
	    	asyncbox.confirm('转载文章','确认', function(action){
	    	  if(action == 'ok'){
	    	    $.ajax({
				type:"POST",
				url:url,	
				data: {
					'bid' : bid 
				},
				dataType: 'json',
				success:function(msg){
				  if(msg.error == 0){
				    showSucceedMsg('转发成功！', '消息提示');
				  }else if(msg.error == 1){
				    //location.href = '/index.php?r=site/login';
					showErrorMsg('操作失败,您需要先登录!', '消息提示', 'http://account.chinaunix.net/login');
				  }else{
				    showErrorMsg(msg.error_content, '消息提示');
			      }
				}
			  });
	    	  }
	    	});

		});
		*/

	});
</script>
<!--该部分应该放在输出代码块的后面才起作用 -->
<script type="text/javascript">

SyntaxHighlighter.autoloader(
	'applescript			/highlight/scripts/shBrushAppleScript.js',
	'actionscript3 as3		/highlight/scripts/shBrushAS3.js',
	'bash shell				/highlight/scripts/shBrushBash.js',
	'coldfusion cf			/highlight/scripts/shBrushColdFusion.js',
	'cpp c					/highlight/scripts/shBrushCpp.js',
	'c# c-sharp csharp		/highlight/scripts/shBrushCSharp.js',
	'css					/highlight/scripts/shBrushCss.js',
	'delphi pascal			/highlight/scripts/shBrushDelphi.js',
	'diff patch pas			/highlight/scripts/shBrushDiff.js',
	'erl erlang				/highlight/scripts/shBrushErlang.js',
	'groovy					/highlight/scripts/shBrushGroovy.js',
	'java					/highlight/scripts/shBrushJava.js',
	'jfx javafx				/highlight/scripts/shBrushJavaFX.js',
	'js jscript javascript	/highlight/scripts/shBrushJScript.js',
	'perl pl				/highlight/scripts/shBrushPerl.js',
	'php					/highlight/scripts/shBrushPhp.js',
	'text plain				/highlight/scripts/shBrushPlain.js',
	'py python				/highlight/scripts/shBrushPython.js',
	'ruby rails ror rb		/highlight/scripts/shBrushRuby.js',
	'scala					/highlight/scripts/shBrushScala.js',
	'sql					/highlight/scripts/shBrushSql.js',
	'vb vbnet				/highlight/scripts/shBrushVb.js',
	'xml xhtml xslt html	/highlight/scripts/shBrushXml.js'
);
SyntaxHighlighter.all();


function code_hide(id){
	var code = document.getElementById(id).style.display;
	if(code == 'none'){
		document.getElementById(id).style.display = 'block';
	}else{
		document.getElementById(id).style.display = 'none';
	}
}
</script>
<!--回顶部js2011.12.30-->
<script language="javascript">
 lastScrollY=0;
 function heartBeat(){
 var diffY;
 if (document.documentElement && document.documentElement.scrollTop)
     diffY = document.documentElement.scrollTop;
 else if (document.body)
     diffY = document.body.scrollTop
 else
     {/*Netscape stuff*/}
 percent=.1*(diffY-lastScrollY);
 if(percent>0)percent=Math.ceil(percent);
 else percent=Math.floor(percent);
 document.getElementById("full").style.top=parseInt(document.getElementById("full").style.top)+percent+"px";
 lastScrollY=lastScrollY+percent;
 if(lastScrollY<200)
 {
 document.getElementById("full").style.display="none";
 }
 else
 {
 document.getElementById("full").style.display="block";
 }
 }
 var gkuan=document.body.clientWidth;
 var ks=(gkuan-960)/2-30;
 suspendcode="<div id=\"full\" style='right:-30px;POSITION:absolute;TOP:500px;z-index:100;width:26px; height:86px;cursor:pointer;'><a href=\"javascript:void(0)\" onclick=\"window.scrollTo(0,0);\"><img src=\"\/image\/top.png\" /></a></div>"
 document.write(suspendcode);
 window.setInterval("heartBeat()",1);
 </script><div id="full" style="right: -30px; position: absolute; top: 630px; z-index: 100; width: 26px; height: 86px; cursor: pointer; display: none;"><a href="javascript:void(0)" onclick="window.scrollTo(0,0);"><img src="/image/top.png"></a></div>
  <!-- footer -->
  <div class="Blog_footer" style="clear:both">
    <div><a href="http://www.chinaunix.net/about/index.shtml" target="_blank" rel="nofollow">关于我们</a> | <a href="http://www.it168.com/bottomfile/it168.shtml" target="_blank" rel="nofollow">关于IT168</a> | <a href="http://www.chinaunix.net/about/connect.html" target="_blank" rel="nofollow">联系方式</a> | <a href="http://www.chinaunix.net/about/service.html" target="_blank" rel="nofollow">广告合作</a> | <a href="http://www.it168.com//bottomfile/flgw/fl.htm" target="_blank" rel="nofollow">法律声明</a> | <a href="http://account.chinaunix.net/register?url=http%3a%2f%2fblog.chinaunix.net" target="_blank" rel="nofollow">免费注册</a>
      <p>Copyright  2001-2010 ChinaUnix.net All Rights Reserved 北京皓辰网域网络信息技术有限公司. 版权所有 </p>
      <div>感谢所有关心和支持过ChinaUnix的朋友们
        <p><a href="http://beian.miit.gov.cn/">16024965号-6 </a></p>
      </div>
    </div>
  </div>
</div>
<script language="javascript">

//全局错误提示弹出框
function showErrorMsg(content, title, url){
	var url = url || '';
	var title = title || '消息提示';
	var html = '';
	html += '<div class="HT_layer3_1 HT_layer3_2"><ul><li><p><span class="login_span1"></span>' + content + '</p></li>';
	if(url == '' || url.length == 0){
		html += '<li class="HT_li1"><input type="button" class="HT_btn2"  onclick=\'close_windows("error_msg")\'></li>';
	} else {
		html += '<li class="HT_li1"><input type="button" class="login_btn1" onclick="location.href=\'' + url + '\'"></li>';
	}
	html += '</ul></div>';
	$.cover(true);
	   asyncbox.open({
		 id: 'error_msg',
		 title : title,
		 html : html,
		 'callback' : function(action){
			 if(action == 'close'){
				 $.cover(false);
			 }
		 }
	});
}

//全局正确提示
function showSucceedMsg(content, title , url ){
	var url = url || '';
	var title = title || '消息提示';
	var html = '';
	html += '<div class="HT_layer3_1 HT_layer3_2"><ul><li><p><span class="login_span2"></span>' + content + '</p></li>';
	if(url == '' || url.length == 0){
		html += '<li class="HT_li1"><input type="button" class="HT_btn2"  onclick=\'close_windows("error_msg")\'></li>';
	} else {
		html += '<li class="HT_li1"><input type="button" class="HT_btn2" onclick="location.href=\'' + url + '\'"></li>';
	}
	html += '</ul></div>';
	$.cover(true);
	asyncbox.open({
		 id: 'error_msg',
		 title : title,
		 html : html,
		 'callback' : function(action){
			 if(action == 'close'){
				 $.cover(false);
			 }
		 }
	});
}

//关闭指定id的窗口
function close_windows(id){
	$.cover(false);
	$.close(id);
}


//公告
var tID;
var tn;                        // 高度
var nStopTime = 5000;        // 不同行间滚动时间隔的时间，值越小，移动越快
var nSpeed = 50;            // 滚动时，向上移动一像素间隔的时间，值越小，移动越快
var isMove = true;
var nHeight = 25;
var nS = 0;
var nNewsCount = 3;

/**
 * n 用于表示是否为第一次运行
 **/
function moveT(n)
{
    clearTimeout(tID)
    var noticev2 = document.getElementById("noticev2")
    nS = nSpeed;

    // 只在第一次调用时运行，初始化环境（有没有参数）
    if (n)
    {
        // 设置行高
        noticev2.style.lineHeight = nHeight + "px";
        // 初始化显示位置
        tn = 0;
        // 刚进入时在第一行停止时间
        nS = nStopTime;
    }

    // 判断鼠标是否指向层
    if (isMove)
    {
        // 向上移动一像素
        tn--;
        // 如果移动到最下面一行了，则移到顶行
        if (Math.abs(tn) == nNewsCount * nHeight)
        {
            tn = 0;
        }
        // 设置位置
        noticev2.style.marginTop = tn + "px";
        // 完整显示一行时，停止一段时间
        if (tn % nHeight == 0)
        {
            nS = nStopTime;
        }
    }

    tID = setTimeout("moveT()", nS);
}
moveT(1);    // 此处可以传入任何参数
</script>
<script type="text/javascript">
//  var _gaq = _gaq || [];
//  _gaq.push(['_setAccount', 'UA-20237423-2']);
//  _gaq.push(['_setDomainName', '.chinaunix.net']);
//  _gaq.push(['_trackPageview']);
//
//  (function() {
//    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
//    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
//    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
//  })();

</script>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F0ee5e8cdc4d43389b3d1bfd76e83216b' type='text/javascript'%3E%3C/script%3E"));

function link(t){
     var href= $(t).attr('href');
     href+="?url="+encodeURIComponent(location.href);
     $(t).attr('href',href);
    //setCookie("returnOutUrl", location.href, 60, "/");
}
</script><script src=" http://hm.baidu.com/h.js?0ee5e8cdc4d43389b3d1bfd76e83216b" type="text/javascript"></script>
<script type="text/javascript" src="/js/jquery.qqFace.js"></script>


<div id="asyncbox_cover" unselectable="on" style="opacity:0.1;filter:alpha(opacity=10);background:#000"></div><div id="asyncbox_clone"></div><div id="asyncbox_focus"></div><div id="asyncbox_load"><div><span></span></div></div><orbit-wrapper style="border-block: initial; border-inline: initial; border-start-start-radius: initial; border-start-end-radius: initial; border-end-start-radius: initial; border-end-end-radius: initial; overflow-block: initial; overflow-inline: initial; overscroll-behavior-block: initial; overscroll-behavior-inline: initial; margin-block: initial; margin-inline: initial; scroll-margin-block: initial; scroll-margin-inline: initial; padding-block: initial; padding-inline: initial; scroll-padding-block: initial; scroll-padding-inline: initial; inset-block: initial; inset-inline: initial; block-size: initial; min-block-size: initial; max-block-size: initial; inline-size: initial; min-inline-size: initial; max-inline-size: initial; contain-intrinsic-block-size: initial; contain-intrinsic-inline-size: initial; background: initial; background-blend-mode: initial; border: initial; border-radius: initial; box-decoration-break: initial; -moz-float-edge: initial; display: initial; position: fixed; float: initial; clear: initial; vertical-align: initial; baseline-source: initial; overflow: initial; overflow-anchor: initial; transform: initial; rotate: initial; scale: initial; translate: initial; offset: initial; scroll-behavior: initial; scroll-snap-align: initial; scroll-snap-type: initial; scroll-snap-stop: initial; overscroll-behavior: initial; isolation: initial; break-after: initial; break-before: initial; break-inside: initial; resize: initial; perspective: initial; perspective-origin: initial; backface-visibility: initial; transform-box: initial; transform-style: initial; transform-origin: initial; contain: initial; content-visibility: initial; container: initial; appearance: initial; -moz-orient: initial; will-change: initial; shape-image-threshold: initial; shape-margin: initial; shape-outside: initial; touch-action: initial; -webkit-line-clamp: initial; scrollbar-gutter: initial; zoom: initial; columns: initial; column-fill: initial; column-rule: initial; column-span: initial; content: initial; counter-increment: initial; counter-reset: initial; counter-set: initial; opacity: initial; box-shadow: initial; clip: initial; filter: initial; backdrop-filter: initial; mix-blend-mode: initial; font: initial; font-synthesis: initial; font-palette: initial; math-depth: initial; math-style: initial; visibility: initial; writing-mode: initial; text-orientation: initial; print-color-adjust: initial; image-rendering: initial; image-orientation: initial; dominant-baseline: initial; text-anchor: initial; color-interpolation: initial; color-interpolation-filters: initial; fill: initial; fill-opacity: initial; fill-rule: initial; shape-rendering: initial; stroke: initial; stroke-width: initial; stroke-linecap: initial; stroke-linejoin: initial; stroke-miterlimit: initial; stroke-opacity: initial; stroke-dasharray: initial; stroke-dashoffset: initial; clip-rule: initial; marker: initial; paint-order: initial; border-collapse: initial; empty-cells: initial; caption-side: initial; border-spacing: initial; color: initial; text-transform: initial; hyphens: initial; -moz-text-size-adjust: initial; text-indent: initial; overflow-wrap: initial; word-break: initial; text-justify: initial; text-align-last: initial; text-align: initial; letter-spacing: initial; word-spacing: initial; white-space: initial; text-shadow: initial; text-emphasis: initial; text-emphasis-position: initial; tab-size: initial; line-break: initial; -webkit-text-fill-color: initial; -webkit-text-stroke: initial; ruby-align: initial; ruby-position: initial; text-combine-upright: initial; text-rendering: initial; text-underline-offset: initial; text-underline-position: initial; text-decoration-skip-ink: initial; hyphenate-character: initial; forced-color-adjust: initial; -webkit-text-security: initial; text-wrap: initial; cursor: initial; pointer-events: initial; caret-color: initial; accent-color: initial; color-scheme: initial; scrollbar-color: initial; list-style: initial; quotes: initial; margin: initial; overflow-clip-margin: initial; scroll-margin: initial; outline: initial; outline-offset: initial; padding: initial; scroll-padding: initial; page: initial; top: 0px; right: 0px; bottom: initial; left: initial; z-index: 2147483647; flex-flow: initial; place-content: initial; place-items: initial; flex: initial; place-self: initial; order: initial; height: 100vh; min-height: initial; max-height: initial; width: 0px; min-width: initial; max-width: initial; box-sizing: initial; object-fit: initial; object-position: initial; grid-area: initial; grid: initial; gap: initial; aspect-ratio: initial; contain-intrinsic-size: initial; vector-effect: initial; stop-color: initial; stop-opacity: initial; flood-color: initial; flood-opacity: initial; lighting-color: initial; mask-type: initial; clip-path: initial; mask: initial; x: initial; y: initial; cx: initial; cy: initial; rx: initial; ry: initial; r: initial; d: initial; table-layout: initial; text-overflow: initial; text-decoration: initial; ime-mode: initial; scrollbar-width: initial; user-select: initial; -moz-window-dragging: initial; -moz-force-broken-image-icon: initial; transition: initial; animation: initial; animation-composition: initial; -moz-box-align: initial; -moz-box-direction: initial; -moz-box-flex: initial; -moz-box-orient: initial; -moz-box-pack: initial; -moz-box-ordinal-group: initial;"></orbit-wrapper></body><div style="all: initial;"><div style="all: initial;" id="__hcfy__"></div></div><div id="immersive-translate-popup" style="all: initial"></div></html>