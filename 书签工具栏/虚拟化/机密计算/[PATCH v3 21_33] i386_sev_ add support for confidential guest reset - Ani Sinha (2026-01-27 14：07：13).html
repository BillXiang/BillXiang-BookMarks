<!-- Filename: 书签工具栏/虚拟化/机密计算/[PATCH v3 21_33] i386_sev_ add support for confidential guest reset - Ani Sinha (2026-01-27 14：07：13).html
 Page saved with X-Webpage-Conserve 
 url: https://lore.kernel.org/kvm/20260127051612.219475-22-anisinha@redhat.com/
 Summary: 
-->
<html><head><title>[PATCH v3 21/33] i386/sev: add support for confidential guest reset - Ani Sinha</title><link rel="alternate" title="Atom feed" href="../new.atom" type="application/atom+xml"><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link type="text/css" rel="stylesheet" href="../216light.css?6914e0a5" media="screen,print"><link type="text/css" rel="stylesheet" href="../216dark.css?6914e0a5" media="screen and (prefers-color-scheme:dark)"><style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}
.immersive-translate-attach-loading::after {
  content: " ";

  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;

  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-2000%, -50%);
  z-index: 100;
}

.immersive-translate-loading-spinner {
  vertical-align: middle !important;
  width: 10px !important;
  height: 10px !important;
  display: inline-block !important;
  margin: 0 4px !important;
  border: 2px rgba(221, 244, 255, 0.6) solid !important;
  border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-radius: 50% !important;
  padding: 0 !important;
  -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
  animation: immersive-translate-loading-animation 0.6s infinite linear !important;
}

@-webkit-keyframes immersive-translate-loading-animation {
  from {
    -webkit-transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(359deg);
  }
}

@keyframes immersive-translate-loading-animation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
      100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
      110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
      120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}

.immersive-translate-toast {
  display: flex;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  right: 0;
  top: 1%;
  width: fit-content;
  padding: 12px 20px;
  margin: auto;
  overflow: auto;
  background: #fef6f9;
  box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
  font-size: 15px;
  border-radius: 8px;
  color: #333;
}

.immersive-translate-toast-content {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.immersive-translate-toast-hidden {
  margin: 0 20px 0 72px;
  text-decoration: underline;
  cursor: pointer;
}

.immersive-translate-toast-close {
  color: #666666;
  font-size: 20px;
  font-weight: bold;
  padding: 0 10px;
  cursor: pointer;
}

@media screen and (max-width: 768px) {
  .immersive-translate-toast {
    top: 0;
    padding: 12px 0px 0 10px;
  }
  .immersive-translate-toast-content {
    flex-direction: column;
    text-align: center;
  }
  .immersive-translate-toast-hidden {
    margin: 10px auto;
  }
}

.immersive-translate-dialog {
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  display: flex;
  width: 300px;
  flex-direction: column;
  align-items: center;
  font-size: 15px;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  margin: auto;
  height: fit-content;
  border-radius: 20px;
  background-color: #fff;
}

.immersive-translate-modal {
  display: none;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0, 0, 0);
  background-color: rgba(0, 0, 0, 0.4);
  font-size: 15px;
}

.immersive-translate-modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 40px 24px 24px;
  border-radius: 12px;
  width: 350px;
  font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
    "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
    "Segoe UI Symbol", "Noto Color Emoji";
  position: relative;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-content {
    margin: 25% auto !important;
  }
}

@media screen and (max-width: 480px) {
  .immersive-translate-modal-content {
    width: 80vw !important;
    margin: 20vh auto !important;
    padding: 20px 12px 12px !important;
  }

  .immersive-translate-modal-title {
    font-size: 14px !important;
  }

  .immersive-translate-modal-body {
    font-size: 13px !important;
    max-height: 60vh !important;
  }

  .immersive-translate-btn {
    font-size: 13px !important;
    padding: 8px 16px !important;
    margin: 0 4px !important;
  }

  .immersive-translate-modal-footer {
    gap: 6px !important;
    margin-top: 16px !important;
  }
}

.immersive-translate-modal .immersive-translate-modal-content-in-input {
  max-width: 500px;
}
.immersive-translate-modal-content-in-input .immersive-translate-modal-body {
  text-align: left;
  max-height: unset;
}

.immersive-translate-modal-title {
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #333333;
}

.immersive-translate-modal-body {
  text-align: center;
  font-size: 14px;
  font-weight: 400;
  color: #333333;
  margin-top: 24px;
  word-break: break-all;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-body {
    max-height: 250px;
    overflow-y: auto;
  }
}

.immersive-translate-close {
  color: #666666;
  position: absolute;
  right: 16px;
  top: 16px;
  font-size: 20px;
  font-weight: bold;
}

.immersive-translate-close:hover,
.immersive-translate-close:focus {
  text-decoration: none;
  cursor: pointer;
}

.immersive-translate-modal-footer {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 24px;
}

.immersive-translate-btn {
  width: fit-content;
  color: #fff;
  background-color: #ea4c89;
  border: none;
  font-size: 14px;
  margin: 0 8px;
  padding: 9px 30px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.immersive-translate-btn-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.immersive-translate-btn:hover {
  background-color: #f082ac;
}
.immersive-translate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.immersive-translate-btn:disabled:hover {
  background-color: #ea4c89;
}

.immersive-translate-link-btn {
  background-color: transparent;
  color: #ea4c89;
  border: none;
  cursor: pointer;
  height: 30px;
  line-height: 30px;
}

.immersive-translate-cancel-btn {
  /* gray color */
  background-color: rgb(89, 107, 120);
}

.immersive-translate-cancel-btn:hover {
  background-color: hsl(205, 20%, 32%);
}

.immersive-translate-action-btn {
  background-color: transparent;
  color: #ea4c89;
  border: 1px solid #ea4c89;
}

.immersive-translate-btn svg {
  margin-right: 5px;
}

.immersive-translate-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-primary-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-modal input[type="radio"] {
  margin: 0 6px;
  cursor: pointer;
}

.immersive-translate-modal label {
  cursor: pointer;
}

.immersive-translate-close-action {
  position: absolute;
  top: 2px;
  right: 0px;
  cursor: pointer;
}

.imt-image-status {
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 16px !important;
}
.imt-image-status img,
.imt-image-status svg,
.imt-img-loading {
  width: 28px !important;
  height: 28px !important;
  margin: 0 0 8px 0 !important;
  min-height: 28px !important;
  min-width: 28px !important;
  position: relative !important;
}
.imt-img-loading {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
  background-size: 28px 28px;
  animation: image-loading-rotate 1s linear infinite !important;
}

.imt-image-status span {
  color: var(--bg-2, #fff) !important;
  font-size: 14px !important;
  line-height: 14px !important;
  font-weight: 500 !important;
  font-family: "PingFang SC", Arial, sans-serif !important;
}

.imt-primary-button {
  display: flex;
  padding: 12px 80px;
  justify-content: center;
  align-items: center;
  gap: 8px;
  border-radius: 8px;
  background: #ea4c89;
  color: #fff;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
  line-height: 24px;
  border: none;
  cursor: pointer;
}

.imt-retry-text {
  color: #999;
  text-align: center;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 21px;
  cursor: pointer;
}

.imt-action-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.imt-modal-content-text {
  text-align: left;
  color: #333;
  font-size: 16px;
  font-weight: 400;
  line-height: 24px;
}

@keyframes image-loading-rotate {
  from {
    transform: rotate(360deg);
  }
  to {
    transform: rotate(0deg);
  }
}

.imt-linear-gradient-text {
  background: linear-gradient(90deg, #00a6ff 0%, #c369ff 52.4%, #ff4590 100%);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.imt-flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.imt-linear-black-btn {
  border-radius: 50px;
  background: linear-gradient(66deg, #222 19%, #696969 94.25%);
  height: 48px;
  width: 100%;
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  cursor: pointer;
  justify-content: center;
}
</style><style>pre { white-space: pre-wrap; }* { font-size: 100%; font-family: monospace; }</style><style>* { font-size: 100%; font-family: monospace; background: rgb(255, 255, 255); color: rgb(0, 0, 51); }pre { white-space: pre-wrap; }a:link { color: rgb(0, 0, 255); text-decoration: none; }a:visited { color: rgb(136, 0, 136); }.q { color: rgb(0, 0, 102); }.add { color: rgb(0, 102, 0); }.del { color: rgb(153, 0, 0); }.head { color: rgb(0, 0, 0); }.hunk { color: rgb(153, 102, 0); }.hl.num { color: rgb(255, 51, 0); }.hl.esc { color: rgb(255, 0, 255); }.hl.str { color: rgb(255, 51, 0); }.hl.ppc { color: rgb(204, 51, 204); }.hl.pps { color: rgb(255, 51, 0); }.hl.slc { color: rgb(0, 153, 153); }.hl.com { color: rgb(0, 153, 153); }.hl.kwa { color: rgb(255, 153, 0); }.hl.kwb { color: rgb(0, 102, 0); }.hl.kwc { color: rgb(255, 153, 0); }</style><style>* { font-size: 100%; font-family: monospace; background: rgb(0, 0, 0); color: rgb(204, 204, 204); }pre { white-space: pre-wrap; }a:link { color: rgb(102, 153, 255); text-decoration: none; }a:visited { color: rgb(153, 102, 255); }.q { color: rgb(0, 153, 255); }.add { color: rgb(0, 255, 255); }.del { color: rgb(255, 0, 255); }.head { color: rgb(255, 255, 255); }.hunk { color: rgb(204, 153, 51); }.hl.num { color: rgb(255, 51, 0); }.hl.esc { color: rgb(255, 0, 255); }.hl.str { color: rgb(255, 51, 0); }.hl.ppc { color: rgb(255, 0, 255); }.hl.pps { color: rgb(255, 51, 0); }.hl.slc { color: rgb(0, 153, 255); }.hl.com { color: rgb(0, 153, 255); }.hl.kwa { color: rgb(255, 255, 0); }.hl.kwb { color: rgb(0, 255, 0); }.hl.kwc { color: rgb(255, 255, 0); }</style></head><body><form action="../"><pre><a href="../?t=20260127051743"><b>kvm.vger.kernel.org archive mirror</b></a>
<input name="q" type="text"><input type="submit" value="search"> <a href="../_/text/help/">help</a> / <a href="../_/text/color/">color</a> / <a id="mirror" href="../_/text/mirror/">mirror</a> / <a href="../new.atom">Atom feed</a></pre></form><pre id="b">From: Ani Sinha &lt;anisinha@redhat.com&gt;
To: Paolo Bonzini &lt;pbonzini@redhat.com&gt;,
	Marcelo Tosatti &lt;mtosatti@redhat.com&gt;,
	Zhao Liu &lt;zhao1.liu@intel.com&gt;
Cc: kraxel@redhat.com, Ani Sinha &lt;anisinha@redhat.com&gt;,
	<a href="../../kvm/?t=20260127051743">kvm@vger.kernel.org</a>, <a href="../../qemu-devel/?t=20260127051743">qemu-devel@nongnu.org</a>
Subject: <a href="#r" id="t">[PATCH v3 21/33] i386/sev: add support for confidential guest reset</a>
Date: Tue, 27 Jan 2026 10:45:49 +0530	<a href="#r">[thread overview]</a>
Message-ID: &lt;20260127051612.219475-22-anisinha@redhat.com&gt; (<a href="raw">raw</a>)
In-Reply-To: &lt;<a href="../20260127051612.219475-1-anisinha@redhat.com/">20260127051612.219475-1-anisinha@redhat.com</a>&gt;

When the KVM VM file descriptor changes as a part of the confidential guest
reset mechanism, it necessary to create a new confidential guest context and
re-encrypt the VM memeory. This happens for SEV-ES and SEV-SNP virtual machines
as a part of SEV_LAUNCH_FINISH, SEV_SNP_LAUNCH_FINISH operations.

A new resettable interface for SEV module has been added. A new reset callback
for the reset 'exit' state has been implemented to perform the above operations
when the VM file descriptor has changed during VM reset.

Tracepoints has been added also for tracing purpose.

Signed-off-by: Ani Sinha &lt;anisinha@redhat.com&gt;
---
 <a id="iZ31target:i386:sev.c" href="#Z31target:i386:sev.c">target/i386/sev.c</a>        | 58 ++++++++++++++++++++++++++++++++++++++++
 <a id="iZ31target:i386:trace-events" href="#Z31target:i386:trace-events">target/i386/trace-events</a> |  1 +
 2 files <a href="#related">changed</a>, 59 insertions(+)

<span class="head"><a href="#iZ31target:i386:sev.c" id="Z31target:i386:sev.c">diff</a> --git a/target/i386/sev.c b/target/i386/sev.c
index d1dc0f3c1d..a53b4696e2 100644
--- a/target/i386/sev.c
+++ b/target/i386/sev.c
</span><span class="hunk">@@ -30,8 +30,10 @@
</span> #include "system/kvm.h"
 #include "kvm/kvm_i386.h"
 #include "sev.h"
<span class="add">+#include "system/cpus.h"
</span> #include "system/system.h"
 #include "system/runstate.h"
<span class="add">+#include "system/reset.h"
</span> #include "trace.h"
 #include "migration/blocker.h"
 #include "qom/object.h"
<span class="hunk">@@ -85,6 +87,10 @@ typedef struct QEMU_PACKED PaddedSevHashTable {
</span>     uint8_t padding[ROUND_UP(sizeof(SevHashTable), 16) - sizeof(SevHashTable)];
 } PaddedSevHashTable;
 
<span class="add">+static void sev_handle_reset(Object *obj, ResetType type);
+
+SevKernelLoaderContext sev_load_ctx = {};
+
</span> QEMU_BUILD_BUG_ON(sizeof(PaddedSevHashTable) % 16 != 0);
 
 #define SEV_INFO_BLOCK_GUID     "00f771de-1a7e-4fcb-890e-68c77e2fb44e"
<span class="hunk">@@ -128,6 +134,7 @@ struct SevCommonState {
</span>     uint8_t build_id;
     int sev_fd;
     SevState state;
<span class="add">+    ResettableState reset_state;
</span> 
     QTAILQ_HEAD(, SevLaunchVmsa) launch_vmsa;
 };
<span class="hunk">@@ -1665,6 +1672,11 @@ sev_vm_state_change(void *opaque, bool running, RunState state)
</span>             error_setg(&amp;sev_mig_blocker,
                        "SEV: Migration is not implemented");
             migrate_add_blocker(&amp;sev_mig_blocker, &amp;error_fatal);
<span class="add">+            /*
+             * mark SEV guest as resettable so that we can reinitialize
+             * SEV upon reset.
+             */
+            qemu_register_resettable(OBJECT(sev_common));
</span>         }
     }
 }
<span class="hunk">@@ -1991,6 +2003,41 @@ static int sev_snp_kvm_init(ConfidentialGuestSupport *cgs, Error **errp)
</span>     return 0;
 }
 
<span class="add">+/*
+ * handle sev vm reset
+ */
+static void sev_handle_reset(Object *obj, ResetType type)
+{
+    SevCommonState *sev_common = SEV_COMMON(MACHINE(qdev_get_machine())-&gt;cgs);
+    SevCommonStateClass *klass = SEV_COMMON_GET_CLASS(sev_common);
+
+    if (!sev_common) {
+        return;
+    }
+
+    if (!runstate_is_running()) {
+        return;
+    }
+
+    sev_add_kernel_loader_hashes(&amp;sev_load_ctx, &amp;error_fatal);
+    if (sev_es_enabled() &amp;&amp; !sev_snp_enabled()) {
+        sev_launch_get_measure(NULL, NULL);
+    }
+    if (!sev_check_state(sev_common, SEV_STATE_RUNNING)) {
+        /* this calls sev_snp_launch_finish() etc */
+        klass-&gt;launch_finish(sev_common);
+    }
+
+    trace_sev_handle_reset();
+    return;
+}
+
+static ResettableState *sev_reset_state(Object *obj)
+{
+    SevCommonState *sev_common = SEV_COMMON(obj);
+    return &amp;sev_common-&gt;reset_state;
+}
+
</span> int
 sev_encrypt_flash(hwaddr gpa, uint8_t *ptr, uint64_t len, Error **errp)
 {
<span class="hunk">@@ -2469,6 +2516,8 @@ bool sev_add_kernel_loader_hashes(SevKernelLoaderContext *ctx, Error **errp)
</span>         return false;
     }
 
<span class="add">+    /* save the context here so that it can be re-used when vm is reset */
+    memcpy(&amp;sev_load_ctx, ctx, sizeof(*ctx));
</span>     return klass-&gt;build_kernel_loader_hashes(sev_common, area, ctx, errp);
 }
 
<span class="hunk">@@ -2729,8 +2778,16 @@ static void
</span> sev_common_class_init(ObjectClass *oc, const void *data)
 {
     ConfidentialGuestSupportClass *klass = CONFIDENTIAL_GUEST_SUPPORT_CLASS(oc);
<span class="add">+    ResettableClass *rc = RESETTABLE_CLASS(oc);
</span> 
     klass-&gt;kvm_init = sev_common_kvm_init;
<span class="add">+    /*
+     * the exit phase makes sure sev handles reset after all legacy resets
+     * have taken place (in the hold phase) and IGVM has also properly
+     * set up the boot state.
+     */
+    rc-&gt;phases.exit = sev_handle_reset;
+    rc-&gt;get_state = sev_reset_state;
</span> 
     object_class_property_add_str(oc, "sev-device",
                                   sev_common_get_sev_device,
<span class="hunk">@@ -2780,6 +2837,7 @@ static const TypeInfo sev_common_info = {
</span>     .abstract = true,
     .interfaces = (const InterfaceInfo[]) {
         { TYPE_USER_CREATABLE },
<span class="add">+        { TYPE_RESETTABLE_INTERFACE },
</span>         { }
     }
 };
<span class="head"><a href="#iZ31target:i386:trace-events" id="Z31target:i386:trace-events">diff</a> --git a/target/i386/trace-events b/target/i386/trace-events
index 51301673f0..b320f655ee 100644
--- a/target/i386/trace-events
+++ b/target/i386/trace-events
</span><span class="hunk">@@ -14,3 +14,4 @@ kvm_sev_attestation_report(const char *mnonce, const char *data) "mnonce %s data
</span> kvm_sev_snp_launch_start(uint64_t policy, char *gosvw) "policy 0x%" PRIx64 " gosvw %s"
 kvm_sev_snp_launch_update(uint64_t src, uint64_t gpa, uint64_t len, const char *type) "src 0x%" PRIx64 " gpa 0x%" PRIx64 " len 0x%" PRIx64 " (%s page)"
 kvm_sev_snp_launch_finish(char *id_block, char *id_auth, char *host_data) "id_block %s id_auth %s host_data %s"
<span class="add">+sev_handle_reset(void) ""
</span>-- 
2.42.0

</pre><hr><pre><a href="../20260127051612.219475-27-anisinha@redhat.com/" rel="next">next</a> <a href="../20260127051612.219475-21-anisinha@redhat.com/" rel="prev">prev</a> <a href="../20260127051612.219475-1-anisinha@redhat.com/">parent</a> <a href="#R">reply</a>	other threads:[<a href="../?t=20260127051743">~2026-01-27  5:17 UTC</a>|<a href="../">newest</a>]

<b>Thread overview: </b>19+ messages / expand[<a href="T/#u">flat</a>|<a href="t/#u">nested</a>]  <a href="t.mbox.gz">mbox.gz</a>  <a href="t.atom">Atom feed</a>  <a href="#b">top</a>
     [not found] &lt;<a href="../20260127051612.219475-1-anisinha@redhat.com/">20260127051612.219475-1-anisinha@redhat.com</a>&gt;
2026-01-27  5:15 ` <a href="../20260127051612.219475-2-anisinha@redhat.com/">[PATCH v3 01/33] i386/kvm: avoid installing duplicate msr entries in msr_handlers</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-3-anisinha@redhat.com/">[PATCH v3 02/33] accel/kvm: add confidential class member to indicate guest rebuild capability</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-6-anisinha@redhat.com/">[PATCH v3 05/33] accel/kvm: add changes required to support KVM VM file descriptor change</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-7-anisinha@redhat.com/">[PATCH v3 06/33] accel/kvm: mark guest state as unprotected after vm</a> " Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-8-anisinha@redhat.com/">[PATCH v3 07/33] accel/kvm: add a notifier to indicate KVM VM file descriptor has changed</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-9-anisinha@redhat.com/">[PATCH v3 08/33] accel/kvm: notify when KVM VM file fd is about to be changed</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-10-anisinha@redhat.com/">[PATCH v3 09/33] i386/kvm: unregister smram listeners prior to vm file descriptor change</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-11-anisinha@redhat.com/">[PATCH v3 10/33] kvm/i386: implement architecture support for kvm</a> " Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-14-anisinha@redhat.com/">[PATCH v3 13/33] kvm/i386: reload firmware for confidential guest reset</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-15-anisinha@redhat.com/">[PATCH v3 14/33] accel/kvm: rebind current VCPUs to the new KVM VM file descriptor upon reset</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-16-anisinha@redhat.com/">[PATCH v3 15/33] i386/tdx: refactor TDX firmware memory initialization code into a new function</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-17-anisinha@redhat.com/">[PATCH v3 16/33] i386/tdx: finalize TDX guest state upon reset</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-18-anisinha@redhat.com/">[PATCH v3 17/33] i386/tdx: add a pre-vmfd change notifier to reset tdx state</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-19-anisinha@redhat.com/">[PATCH v3 18/33] i386/sev: add migration blockers only once</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-20-anisinha@redhat.com/">[PATCH v3 19/33] i386/sev: add notifiers</a> " Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-21-anisinha@redhat.com/">[PATCH v3 20/33] i386/sev: free existing launch update data and kernel hashes data on init</a> Ani Sinha
<b>2026-01-27  5:15 ` <a id="r" href="#t">Ani Sinha [this message]</a></b>
2026-01-27  5:15 ` <a href="../20260127051612.219475-27-anisinha@redhat.com/">[PATCH v3 26/33] kvm/xen-emu: re-initialize capabilities during confidential guest reset</a> Ani Sinha
2026-01-27  5:15 ` <a href="../20260127051612.219475-30-anisinha@redhat.com/">[PATCH v3 29/33] kvm/vcpu: add notifiers to inform vcpu file descriptor change</a> Ani Sinha
</pre><form id="related" action="../"><pre>find likely ancestor, descendant, or conflicting patches for <a href="#t">this message</a>:
<textarea name="q" cols="72" rows="3">( dfblob:d1dc0f3c1 dfblob:a53b4696e dfblob:51301673f dfblob:b320f655e )
 OR (
bs:"[PATCH v3 21/33] i386/sev: add support for confidential guest reset" )</textarea>
<input type="submit" value="search">	(<a href="../_/text/help/#search">help</a>)</pre></form>
<hr><pre id="R"><b>Reply instructions:</b>

You may reply publicly to <a href="#t">this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a href="raw">mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \n    --in-reply-to=20260127051612.219475-22-anisinha@redhat.com \n    --to=anisinha@redhat.com \n    --cc=kraxel@redhat.com \n    --cc=kvm@vger.kernel.org \n    --cc=mtosatti@redhat.com \n    --cc=pbonzini@redhat.com \n    --cc=qemu-devel@nongnu.org \n    --cc=zhao1.liu@intel.com \n    /path/to/YOUR_REPLY

  <a href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a href="mailto:anisinha@redhat.com?In-Reply-To=%3C20260127051612.219475-22-anisinha@redhat.com%3E&amp;Cc=kraxel%40redhat.com%2Ckvm%40vger.kernel.org%2Cmtosatti%40redhat.com%2Cpbonzini%40redhat.com%2Cqemu-devel%40nongnu.org%2Czhao1.liu%40intel.com&amp;Subject=Re%3A%20%5BPATCH%20v3%2021%2F33%5D%20i386%2Fsev%3A%20add%20support%20for%20confidential%20guest%20reset">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is a public inbox, see <a href="../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body><div style="all: initial;"><div style="all: initial;" id="__hcfy__"></div></div><div id="immersive-translate-popup" style="all: initial"></div></html>