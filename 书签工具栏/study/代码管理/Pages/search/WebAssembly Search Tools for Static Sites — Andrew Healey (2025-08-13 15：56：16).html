<!-- Filename: 书签工具栏/study/代码管理/Pages/search/WebAssembly Search Tools for Static Sites — Andrew Healey (2025-08-13 15：56：16).html
 Page saved with X-Webpage-Conserve 
 url: https://healeycodes.com/webassembly-search-tools-for-static-websites
 Summary: 
-->
<html lang="en"><head><title class="jsx-2905096934 jsx-1164733520">WebAssembly Search Tools for Static Sites — Andrew Healey</title><meta name="description" content="Building a technical demo to understand this blossoming area of technology." class="jsx-2905096934 jsx-1164733520"><link rel="alternate" type="application/rss+xml" title="RSS Feed for https://healeycodes.com" href="/feed.xml" class="jsx-2905096934 jsx-1164733520"><link rel="shortcut icon" href="/favicon.ico" class="jsx-2905096934 jsx-1164733520"><meta charset="UTF-8" class="jsx-2905096934 jsx-1164733520"><meta property="og:title" content="WebAssembly Search Tools for Static Sites" class="jsx-2905096934 jsx-1164733520"><meta property="og:description" content="Building a technical demo to understand this blossoming area of technology." class="jsx-2905096934 jsx-1164733520"><meta property="og:type" content="website" class="jsx-2905096934 jsx-1164733520"><meta property="twitter:card" content="summary" class="jsx-2905096934 jsx-1164733520"><meta property="twitter:site" content="@healeycodes" class="jsx-2905096934 jsx-1164733520"><meta property="twitter:creator" content="@healeycodes" class="jsx-2905096934 jsx-1164733520"><meta property="twitter:title" content="WebAssembly Search Tools for Static Sites" class="jsx-2905096934 jsx-1164733520"><meta property="twitter:description" content="Building a technical demo to understand this blossoming area of technology." class="jsx-2905096934 jsx-1164733520"><meta name="viewport" content="initial-scale=1.0, width=device-width" class="jsx-2905096934 jsx-1164733520"><link rel="preload" as="image" imagesrcset="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fstork.gif&amp;w=640&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fstork.gif&amp;w=1200&amp;q=100 2x" fetchpriority="high"><link rel="preload" as="image" imagesrcset="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane-search-small.png&amp;w=750&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane-search-small.png&amp;w=1920&amp;q=100 2x" fetchpriority="high"><link rel="preload" as="image" imagesrcset="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane.gif&amp;w=640&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane.gif&amp;w=1080&amp;q=100 2x" fetchpriority="high"><meta name="next-head-count" content="17"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-fa99431b15635937.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-0c7baedefba6b077.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-8c08bb75136edd63.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-d666bbe72a2cf2d6.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/846-164672c1075ebaaf.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/358-d1246b349c06c7d4.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/675-d3ebc23ed35e922d.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/941-568f493525fac32d.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/78-8d24c53930c6d44f.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/%5Bid%5D-e83c0f85a6440c69.js" defer="" crossorigin=""></script><script src="/_next/static/Q_5VSVzDpSrSjY_zBB1-M/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/Q_5VSVzDpSrSjY_zBB1-M/_ssgManifest.js" defer="" crossorigin=""></script><style id="__jsx-b6b2ba738cc0019d">ul.jsx-b6b2ba738cc0019d{list-style:none;padding:0;margin:0;display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap}li.jsx-b6b2ba738cc0019d{padding-right:16px}</style><style id="__jsx-9f7294b33c809b30">.spacer.jsx-9f7294b33c809b30{padding-top:16px;padding-bottom:16px}</style><style id="__jsx-1290c20ab25545a6">.code-line.jsx-1290c20ab25545a6{-webkit-transition:background-color.2s;-moz-transition:background-color.2s;-o-transition:background-color.2s;transition:background-color.2s;padding-left:.75rem}.code-line.highlighted.jsx-1290c20ab25545a6{background-color:#fef3c7;border-left:4px solid#f59e0b;padding-left:.5rem}</style><style id="__jsx-2834850720">.newsletter-section.jsx-2834850720{margin-top:20px;padding-left:16px;padding-right:16px;padding-bottom:16px;border:1px solid var(--border);-webkit-border-radius:.4rem;-moz-border-radius:.4rem;border-radius:.4rem}.newsletter-desc.jsx-2834850720{margin-bottom:16px}.control.jsx-2834850720{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;max-width:500px}.email.jsx-2834850720{width:212px;border:0 solid;border-color:var(--border);font-family:inherit;display:block;-webkit-border-radius:.4rem;-moz-border-radius:.4rem;border-radius:.4rem;border-width:1px;background-color:var(--input-background);padding:.5rem .75rem;font-size:1rem;font-weight:400;margin-right:.5rem;outline:none}.subscribe.jsx-2834850720{-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;font-family:inherit;cursor:pointer;-webkit-border-radius:.4rem;-moz-border-radius:.4rem;border-radius:.4rem;border-width:1px;border-color:transparent;vertical-align:middle;font-size:1rem;line-height:1.5rem;padding:.375rem .75rem;background-color:var(--button);font-weight:500;color:var(--button-text);min-width:8rem}@media only screen and (max-width:725px){.control.jsx-2834850720{display:block}.email.jsx-2834850720{width:100%}.subscribe.jsx-2834850720{margin-top:8px;width:100%}}</style><style id="__jsx-b6ee29e184816190">header.jsx-b6ee29e184816190{padding-top:16px;padding-bottom:16px}.post-title.jsx-b6ee29e184816190{margin-bottom:0px;padding-bottom:0px}.post-text.jsx-b6ee29e184816190{padding-top:16px}.post-date.jsx-b6ee29e184816190{margin-top:0px;padding-top:8px;color:var(--light-text)}.other-posts.jsx-b6ee29e184816190{padding-top:48px;display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-moz-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;gap:16px}.other-posts-link.jsx-b6ee29e184816190{padding-bottom:32px}.other-posts-link.prev.jsx-b6ee29e184816190{text-align:left}.other-posts-link.next.jsx-b6ee29e184816190{text-align:right}aside.jsx-b6ee29e184816190{background-color:var(--aside);padding:1.5em 1.5em;margin-bottom:2.5em}</style><style id="__jsx-1164733520">:root{--text:#1d1d27;--input-background:#fff;--link:#1772ea;--link-hover:#496495;--light-text:#73738b;--border:#b6b6c2;--code-border:#b6b6c294;--button:#4a7ddd;--button-text:#fff;--aside:#d7d5ce}html,body{padding:0;margin:0;font-family:"Inter",sans-serif;font-size:16px;letter-spacing:-.01em}h1,h2,h3,h4,h5,h6{letter-spacing:-.24px;font-weight:400;padding-top:16px;padding-bottom:16px}p{margin-top:20px;margin-bottom:20px;line-height:25px;color:var(--text)}pre,code{font-family:"IBM Plex Mono",monospace;font-size:14px;-webkit-border-radius:.4em;-moz-border-radius:.4em;border-radius:.4em}code{background-color:#f6f8fa;padding:3px;-webkit-border-radius:.4em;-moz-border-radius:.4em;border-radius:.4em}.prism-code{-webkit-border-radius:.4em;-moz-border-radius:.4em;border-radius:.4em;border:1px solid var(--code-border)}hr{border-top:1px solid var(--border);margin-top:48px;margin-bottom:48px}div[class*="language-"],div[class*="language-"]{line-height:25px;padding-top:8px;padding-left:8px;padding-right:8px;padding-bottom:16px;overflow:overlay}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}a{color:var(--link);text-decoration:none;word-wrap:break-word}a:hover{color:var(--link-hover);text-decoration:none}ul{padding-top:3px;padding-bottom:3px;padding-left:24px}li{padding-top:3px;padding-bottom:3px;line-height:25px}blockquote{color:var(--light-text);margin-left:14px;margin-right:0px;border-left-color:var(--border);border-left-style:solid;border-left-width:2px}blockquote>p{color:var(--light-text);padding-left:14px}</style><style id="__jsx-2905096934">.container.jsx-2905096934{margin-left:auto;margin-right:auto;max-width:725px;padding-top:32px;padding-left:14px;padding-right:14px;padding-bottom:96px}</style><style data-href="https://fonts.googleapis.com/css2?family=Inter&amp;display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff) format('woff');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff) format('woff');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff) format('woff');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff) format('woff');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff) format('woff');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff) format('woff');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><style data-href="https://fonts.googleapis.com/css2?family=IBM%20Plex%20Mono&amp;display=swap">@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n5is.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iIq131nj-otFQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1isq131nj-otFQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iAq131nj-otFQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iEq131nj-otFQ.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1i8q131nj-o.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><script src="/_vercel/insights/script.js" defer="" data-sdkn="@vercel/analytics/react" data-sdkv="1.5.0"></script><link as="script" rel="prefetch" href="/_next/static/chunks/pages/index-a259723d5cc826a6.js"><link as="script" rel="prefetch" href="/_next/static/chunks/pages/articles-d2f9082d0b927151.js"><link as="script" rel="prefetch" href="/_next/static/chunks/pages/projects-a04138a241233f9b.js"><link as="script" rel="prefetch" href="/_next/static/chunks/pages/notes-bf66985585fc676f.js"><link as="script" rel="prefetch" href="/_next/static/chunks/pages/about-dba03966484d34da.js"><style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}
.immersive-translate-attach-loading::after {
  content: " ";

  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;

  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-2000%, -50%);
  z-index: 100;
}

.immersive-translate-loading-spinner {
  vertical-align: middle !important;
  width: 10px !important;
  height: 10px !important;
  display: inline-block !important;
  margin: 0 4px !important;
  border: 2px rgba(221, 244, 255, 0.6) solid !important;
  border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-radius: 50% !important;
  padding: 0 !important;
  -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
  animation: immersive-translate-loading-animation 0.6s infinite linear !important;
}

@-webkit-keyframes immersive-translate-loading-animation {
  from {
    -webkit-transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(359deg);
  }
}

@keyframes immersive-translate-loading-animation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
      100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
      110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
      120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}

.immersive-translate-toast {
  display: flex;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  right: 0;
  top: 1%;
  width: fit-content;
  padding: 12px 20px;
  margin: auto;
  overflow: auto;
  background: #fef6f9;
  box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
  font-size: 15px;
  border-radius: 8px;
  color: #333;
}

.immersive-translate-toast-content {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.immersive-translate-toast-hidden {
  margin: 0 20px 0 72px;
  text-decoration: underline;
  cursor: pointer;
}

.immersive-translate-toast-close {
  color: #666666;
  font-size: 20px;
  font-weight: bold;
  padding: 0 10px;
  cursor: pointer;
}

@media screen and (max-width: 768px) {
  .immersive-translate-toast {
    top: 0;
    padding: 12px 0px 0 10px;
  }
  .immersive-translate-toast-content {
    flex-direction: column;
    text-align: center;
  }
  .immersive-translate-toast-hidden {
    margin: 10px auto;
  }
}

.immersive-translate-modal {
  display: none;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0, 0, 0);
  background-color: rgba(0, 0, 0, 0.4);
  font-size: 15px;
}

.immersive-translate-modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 40px 24px 24px;
  border: 1px solid #888;
  border-radius: 10px;
  width: 80%;
  max-width: 270px;
  font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
    "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
    "Segoe UI Symbol", "Noto Color Emoji";
  position: relative;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-content {
    margin: 50% auto !important;
  }
}

.immersive-translate-modal .immersive-translate-modal-content-in-input {
  max-width: 500px;
}
.immersive-translate-modal-content-in-input .immersive-translate-modal-body {
  text-align: left;
  max-height: unset;
}

.immersive-translate-modal-title {
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #333333;
}

.immersive-translate-modal-body {
  text-align: center;
  font-size: 14px;
  font-weight: 400;
  color: #333333;
  word-break: break-all;
  margin-top: 24px;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-body {
    max-height: 250px;
    overflow-y: auto;
  }
}

.immersive-translate-close {
  color: #666666;
  position: absolute;
  right: 16px;
  top: 16px;
  font-size: 20px;
  font-weight: bold;
}

.immersive-translate-close:hover,
.immersive-translate-close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.immersive-translate-modal-footer {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 24px;
}

.immersive-translate-btn {
  width: fit-content;
  color: #fff;
  background-color: #ea4c89;
  border: none;
  font-size: 16px;
  margin: 0 8px;
  padding: 9px 30px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.immersive-translate-btn:hover {
  background-color: #f082ac;
}
.immersive-translate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.immersive-translate-btn:disabled:hover {
  background-color: #ea4c89;
}

.immersive-translate-cancel-btn {
  /* gray color */
  background-color: rgb(89, 107, 120);
}

.immersive-translate-cancel-btn:hover {
  background-color: hsl(205, 20%, 32%);
}

.immersive-translate-action-btn {
  background-color: transparent;
  color: #ea4c89;
  border: 1px solid #ea4c89;
}

.immersive-translate-btn svg {
  margin-right: 5px;
}

.immersive-translate-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #007bff;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-primary-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-modal input[type="radio"] {
  margin: 0 6px;
  cursor: pointer;
}

.immersive-translate-modal label {
  cursor: pointer;
}

.immersive-translate-close-action {
  position: absolute;
  top: 2px;
  right: 0px;
  cursor: pointer;
}

.imt-image-status {
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 16px !important;
}
.imt-image-status img,
.imt-image-status svg,
.imt-img-loading {
  width: 28px !important;
  height: 28px !important;
  margin: 0 0 8px 0 !important;
  min-height: 28px !important;
  min-width: 28px !important;
  position: relative !important;
}
.imt-img-loading {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
  background-size: 28px 28px;
  animation: image-loading-rotate 1s linear infinite !important;
}

.imt-image-status span {
  color: var(--bg-2, #fff) !important;
  font-size: 14px !important;
  line-height: 14px !important;
  font-weight: 500 !important;
  font-family: "PingFang SC", Arial, sans-serif !important;
}

@keyframes image-loading-rotate {
  from {
    transform: rotate(360deg);
  }
  to {
    transform: rotate(0deg);
  }
}
</style><style>ul.jsx-b6b2ba738cc0019d { list-style: none; padding: 0px; margin: 0px; display: flex; flex-wrap: wrap; }li.jsx-b6b2ba738cc0019d { padding-right: 16px; }</style><style>.spacer.jsx-9f7294b33c809b30 { padding-top: 16px; padding-bottom: 16px; }</style><style>.code-line.jsx-1290c20ab25545a6 { transition: background-color 0.2s; padding-left: 0.75rem; }.code-line.highlighted.jsx-1290c20ab25545a6 { background-color: rgb(254, 243, 199); border-left: 4px solid rgb(245, 158, 11); padding-left: 0.5rem; }</style><style>.newsletter-section.jsx-2834850720 { margin-top: 20px; padding-left: 16px; padding-right: 16px; padding-bottom: 16px; border: 1px solid var(--border); border-radius: 0.4rem; }.newsletter-desc.jsx-2834850720 { margin-bottom: 16px; }.control.jsx-2834850720 { display: flex; max-width: 500px; }.email.jsx-2834850720 { width: 212px; border-style: solid; border-image: none; border-color: var(--border); font-family: inherit; display: block; border-radius: 0.4rem; border-width: 1px; background-color: var(--input-background); padding: 0.5rem 0.75rem; font-size: 1rem; font-weight: 400; margin-right: 0.5rem; outline: none; }.subscribe.jsx-2834850720 { appearance: none; font-family: inherit; cursor: pointer; border-radius: 0.4rem; border-width: 1px; border-color: transparent; vertical-align: middle; font-size: 1rem; line-height: 1.5rem; padding: 0.375rem 0.75rem; background-color: var(--button); font-weight: 500; color: var(--button-text); min-width: 8rem; }@media only screen and (max-width: 725px) {
  .control.jsx-2834850720 { display: block; }
  .email.jsx-2834850720 { width: 100%; }
  .subscribe.jsx-2834850720 { margin-top: 8px; width: 100%; }
}</style><style>header.jsx-b6ee29e184816190 { padding-top: 16px; padding-bottom: 16px; }.post-title.jsx-b6ee29e184816190 { margin-bottom: 0px; padding-bottom: 0px; }.post-text.jsx-b6ee29e184816190 { padding-top: 16px; }.post-date.jsx-b6ee29e184816190 { margin-top: 0px; padding-top: 8px; color: var(--light-text); }.other-posts.jsx-b6ee29e184816190 { padding-top: 48px; display: flex; flex-wrap: wrap; -moz-box-pack: justify; justify-content: space-between; gap: 16px; }.other-posts-link.jsx-b6ee29e184816190 { padding-bottom: 32px; }.other-posts-link.prev.jsx-b6ee29e184816190 { text-align: left; }.other-posts-link.next.jsx-b6ee29e184816190 { text-align: right; }aside.jsx-b6ee29e184816190 { background-color: var(--aside); padding: 1.5em; margin-bottom: 2.5em; }</style><style>:root { --text: #1d1d27; --input-background: #fff; --link: #1772ea; --link-hover: #496495; --light-text: #73738b; --border: #b6b6c2; --code-border: #b6b6c294; --button: #4a7ddd; --button-text: #fff; --aside: #d7d5ce; }html, body { padding: 0px; margin: 0px; font-family: "Inter", sans-serif; font-size: 16px; letter-spacing: -0.01em; }h1, h2, h3, h4, h5, h6 { letter-spacing: -0.24px; font-weight: 400; padding-top: 16px; padding-bottom: 16px; }p { margin-top: 20px; margin-bottom: 20px; line-height: 25px; color: var(--text); }pre, code { font-family: "IBM Plex Mono", monospace; font-size: 14px; border-radius: 0.4em; }code { background-color: rgb(246, 248, 250); padding: 3px; border-radius: 0.4em; }.prism-code { border-radius: 0.4em; border: 1px solid var(--code-border); }hr { border-top: 1px solid var(--border); margin-top: 48px; margin-bottom: 48px; }div[class*="language-"], div[class*="language-"] { line-height: 25px; padding: 8px 8px 16px; overflow: auto; }* { box-sizing: border-box; }a { color: var(--link); text-decoration: none; overflow-wrap: break-word; }a:hover { color: var(--link-hover); text-decoration: none; }ul { padding-top: 3px; padding-bottom: 3px; padding-left: 24px; }li { padding-top: 3px; padding-bottom: 3px; line-height: 25px; }blockquote { color: var(--light-text); margin-left: 14px; margin-right: 0px; border-left-color: var(--border); border-left-style: solid; border-left-width: 2px; }blockquote > p { color: var(--light-text); padding-left: 14px; }</style><style>.container.jsx-2905096934 { margin-left: auto; margin-right: auto; max-width: 725px; padding: 32px 14px 96px; }</style><style>@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfMZs.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+460-52F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+301, U+400-45F, U+490-491, U+4B0-4B1, U+2116; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+1F00-1FFF; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+370-377, U+37A-37F, U+384-38A, U+38C, U+38E-3A1, U+3A3-3FF; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+102-103, U+110-111, U+128-129, U+168-169, U+1A0-1A1, U+1AF-1B0, U+300-301, U+303-304, U+308-309, U+323, U+329, U+1EA0-1EF9, U+20AB; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+100-2BA, U+2BD-2C5, U+2C7-2CC, U+2CE-2D7, U+2DD-2FF, U+304, U+308, U+329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF; }@font-face { font-family: "Inter"; src: url("https://fonts.gstatic.com/s/inter/v19/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+0-FF, U+131, U+152-153, U+2BB-2BC, U+2C6, U+2DA, U+2DC, U+304, U+308, U+329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD; }</style><style>@font-face { font-family: "IBM Plex Mono"; src: url("https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n5is.woff") format("woff"); font-style: normal; font-weight: 400; font-display: swap; }@font-face { font-family: "IBM Plex Mono"; src: url("https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iIq131nj-otFQ.woff2") format("woff2"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+460-52F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F; }@font-face { font-family: "IBM Plex Mono"; src: url("https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1isq131nj-otFQ.woff2") format("woff2"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+301, U+400-45F, U+490-491, U+4B0-4B1, U+2116; }@font-face { font-family: "IBM Plex Mono"; src: url("https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iAq131nj-otFQ.woff2") format("woff2"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+102-103, U+110-111, U+128-129, U+168-169, U+1A0-1A1, U+1AF-1B0, U+300-301, U+303-304, U+308-309, U+323, U+329, U+1EA0-1EF9, U+20AB; }@font-face { font-family: "IBM Plex Mono"; src: url("https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iEq131nj-otFQ.woff2") format("woff2"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+100-2BA, U+2BD-2C5, U+2C7-2CC, U+2CE-2D7, U+2DD-2FF, U+304, U+308, U+329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF; }@font-face { font-family: "IBM Plex Mono"; src: url("https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1i8q131nj-o.woff2") format("woff2"); font-style: normal; font-weight: 400; font-display: swap; unicode-range: U+0-FF, U+131, U+152-153, U+2BB-2BC, U+2C6, U+2DA, U+2DC, U+304, U+308, U+329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD; }</style></head><body><div id="__next"><div class="jsx-2905096934 jsx-1164733520 container"><nav class="jsx-b6b2ba738cc0019d"><ul class="jsx-b6b2ba738cc0019d"><li class="jsx-b6b2ba738cc0019d"><a href="/">Andrew Healey</a></li><li class="jsx-b6b2ba738cc0019d"><a href="/articles">Articles</a></li><li class="jsx-b6b2ba738cc0019d"><a href="/projects">Projects</a></li><li class="jsx-b6b2ba738cc0019d"><a href="/notes">Notes</a></li><li class="jsx-b6b2ba738cc0019d"><a href="/about">About</a></li><li class="jsx-b6b2ba738cc0019d"><a href="https://github.com/healeycodes" target="_blank" class="jsx-b6b2ba738cc0019d">GitHub</a></li><li class="jsx-b6b2ba738cc0019d"><a href="https://twitter.com/healeycodes" target="_blank" class="jsx-b6b2ba738cc0019d">Twitter</a></li><li class="jsx-b6b2ba738cc0019d"><a href="/feed.xml" class="jsx-b6b2ba738cc0019d">RSS</a></li></ul></nav><header class="jsx-b6ee29e184816190"><h1 class="jsx-b6ee29e184816190 post-title">WebAssembly Search Tools for Static Sites</h1><p class="jsx-b6ee29e184816190 post-date"><time datetime="2021-02-20">Feb 2021</time></p></header><main class="jsx-b6ee29e184816190 post-text"><div><p>The challenge of searching static websites is effectively a solved problem with brilliant, yet widely unadopted, solutions.</p><p>These projects scan and index your content at build time and ship it to the browser with the rest of your static files. No out-of-your-control external service required. A small library in JavaScript (sometimes accompanied by WebAssembly) loads the index and allows instant searching and works just fine offline. Searching the complete Federalist Papers for multiple keywords takes less than 100µs in my Wasm <a href="https://github.com/healeycodes/crane-search">tech demo</a> (I'll get to that later on).</p><p>The most popular libraries are written in JavaScript like <a href="https://lunrjs.com/">Lunr</a>, or <a href="https://github.com/krisk/Fuse">Fuse</a>, or <a href="https://github.com/nextapps-de/flexsearch">FlexSearch</a>. They provide pre-compiled indexes and <a href="https://en.wikipedia.org/wiki/Approximate_string_matching">fuzzy</a>, wildcard, and boolean searches. They have good documentation and are ready for production usage.</p><p>But I'm more interested in how the up-and-coming Wasm-powered projects work. Browser search is a space where Wasm can really find an edge. Wasm runs faster, loads quicker, and ships smaller binaries (in theory, in practice it takes some work to get there).</p><p>The two projects I looked at both use Rust as a backend language:</p><ul><li><a href="https://github.com/tinysearch/tinysearch">tinysearch</a> generates a small, self-contained Wasm module (with an embedded index). It aims for a small memory footprint by using Bloom filters — a space-efficient probabilistic data structure that results in a negligible amount of false positives. Read more in <a href="https://endler.dev/2019/tinysearch">A Tiny, Static, Full-Text Search Engine using Rust and WebAssembly</a> by the creator, Matthias Endler.</li><li><a href="https://stork-search.net/">Stork</a> focuses more on the developer experience with rich documentation and examples. Stork also pays keen attention to the user experience by providing a progress bar for loading the index, excerpts for the results (keywords highlighted), theme support, and more (see <a href="https://stork-search.net/docs/interface">Embedding the Interface</a>). Learn about how it came to life in <a href="https://jameslittle.me/blog/2020/one-year-of-stork/">Stork Turns One: Building a search tool for static sites with Rust and WebAssembly</a> by the creator, James Little.</li></ul><p>Stork is more interesting to me because it focuses on the human experience — of the person who builds with it, and the person who searches. See the thin, quick, configurable UI below.</p><p><span class="jsx-9f7294b33c809b30 spacer"><img alt="The Stork instant search in-action" fetchpriority="high" width="600" height="464" decoding="async" data-nimg="1" style="color:transparent;display:block;margin-inline:auto;max-width:100%;height:auto" srcset="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fstork.gif&amp;w=640&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fstork.gif&amp;w=1200&amp;q=100 2x" src="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fstork.gif&amp;w=1200&amp;q=100"></span></p><p>In order to understand how these search tools work, and the design problems involved, I built a technical demo in Go, compiled to Wasm.</p><h2 id="technical-demo">Technical Demo</h2><p>My technical demo is inspired by Stork and uses a near-identical configuration file setup. So it had to be named after a bird 🐦 too — <a href="https://github.com/healeycodes/crane-search">healeycodes/crane-search</a>.</p><p>Crane is two programs. The first program scans a group of documents and builds an efficient index. 1MB of text and metadata is turned into a 25KB index (14KB gzipped). The second program is a Wasm module that is sent to the browser along with a little bit of JavaScript glue code and the index. The result is an instant search engine that helps users find web pages as they type.</p><p>The full-text search engine is powered in part with code from Artem Krylysov's blog post <a href="https://artem.krylysov.com/blog/2020/07/28/lets-build-a-full-text-search-engine/">Let's build a Full-Text Search engine</a>.</p><p>The core data-structure is an inverted index. It maps words to document IDs. This means we can check very quickly (i.e. 100µs within Wasm) which documents a word can be found in. At build time, we loop over the document files and add to the inverted index. We also create a list of results so we can relate a document ID to a document's metadata (defined in the configuration file). The metadata includes the title and URL so that we can display a list of search results in the browser.</p><p>We can return results for multiple keywords by looking at the common document IDs for each keyword. This takes linear time as the IDs are inserted into the index in order.</p><p>During the build stage, we perform normalization to make the search engine more helpful and accurate. For example, if you search for <code>fish</code> you probably want to match <code>Fishing</code>. Words are turned into lowercase, common words are dropped, and words are reduced into their root form (aka <a href="https://en.wikipedia.org/wiki/Stemming">stemming</a> — Krylysov's example code uses <a href="https://github.com/kljensen/snowball">Snowball</a> as a stemmer).</p><p>The document <code>"Alice likes to go fishing"</code> becomes <code>["alice", "go", "fish"]</code>. The search term <code>"Fishing"</code> is also turned into a token, at search-time it becomes <code>"fish"</code>.</p><p>To handle the document metadata, Crane's build program is passed the location of the configuration file. This tells it where to find the documents to index on disk, where they can be found on the static website, and what the search result should be titled.</p><pre><div class="jsx-1290c20ab25545a6 code"><div style="color:#393A34;background-color:#f6f8fa" class="jsx-1290c20ab25545a6 prism-code language-toml"><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">[input]</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">files = [</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    {</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">        path = "docs/essays/essay01.txt",</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">        url = "essays/essay01.txt",</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">        title = "Introduction"</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    },</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    # etc.</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">]</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">[output]</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">filename = "dist/federalist.crane"</span></div></div></div></pre><p>The index and result data is combined into a single struct called a store. It's encoded using <a href="https://golang.org/pkg/encoding/gob/">encoding/gob</a>, a binary encoding that is faster and smaller than JSON (<a href="https://gist.github.com/evalphobia/a2ba2636acbc112f68dcd89e8b81d349">one</a>, <a href="http://ugorji.net/blog/benchmarking-serialization-in-go">two</a>).</p><pre><div class="jsx-1290c20ab25545a6 code"><div style="color:#393A34;background-color:#f6f8fa" class="jsx-1290c20ab25545a6 prism-code language-go"><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">file</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> err </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> os</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Create</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">config</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Output</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Filename</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">check</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">err</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#00009f">defer</span><span class="jsx-1290c20ab25545a6"> file</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Close</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">encoder </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> gob</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">NewEncoder</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">file</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">store </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> search</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Store</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    Index</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:</span><span class="jsx-1290c20ab25545a6">   index</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    Results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:</span><span class="jsx-1290c20ab25545a6"> results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">err </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">=</span><span class="jsx-1290c20ab25545a6"> encoder</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Encode</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">store</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">check</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">err</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span></div></div></div></pre><p>The second part of Crane is the program that's compiled into Wasm and sent to the browser. It uses the Go standard library package <a href="https://golang.org/pkg/syscall/js/">syscall/js</a>.</p><blockquote><p>Package js gives access to the WebAssembly host environment when using the js/wasm architecture. Its API is based on JavaScript semantics.</p></blockquote><p>Our browser program makes two functions available in the global JavaScript scope. A new goroutine is spawned when they're called.</p><pre><div class="jsx-1290c20ab25545a6 code"><div style="color:#393A34;background-color:#f6f8fa" class="jsx-1290c20ab25545a6 prism-code language-go"><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="color:#999988;font-style:italic">// Store is a shared type between both programs (build/browser)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#00009f">var</span><span class="jsx-1290c20ab25545a6"> store search</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Store</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#00009f">func</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">main</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Global</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Set</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"_craneLoad"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">FuncOf</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">load</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Global</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Set</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"_craneQuery"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">FuncOf</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">query</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#999988;font-style:italic">// Wait indefinitely,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#999988;font-style:italic">// required so that our Wasm module doesn't exit straight away</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">select</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#00009f">func</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">query</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">this js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Value</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> args </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6">js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Value</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">interface</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    searchTerm </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> args</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6" style="color:#36acaa">0</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">String</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    start </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> time</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Now</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    matchedIDs </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> store</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Index</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Search</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">searchTerm</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    log</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Printf</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"Search found %d documents in %v"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">len</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">matchedIDs</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> time</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">Since</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">start</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">var</span><span class="jsx-1290c20ab25545a6"> results </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6" style="color:#00009f">interface</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">for</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#36acaa">_</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> id </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:=</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">range</span><span class="jsx-1290c20ab25545a6"> matchedIDs </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">        results </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">=</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">append</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">            </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">map</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6">string</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6" style="color:#00009f">interface</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">{</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">                </span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"title"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:</span><span class="jsx-1290c20ab25545a6"> store</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6">id</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Title</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">                </span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"url"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:</span><span class="jsx-1290c20ab25545a6">   store</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6">id</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">URL</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">                </span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"id"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">:</span><span class="jsx-1290c20ab25545a6">    store</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">Results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">[</span><span class="jsx-1290c20ab25545a6">id</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">]</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6">ID</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">           </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#999988;font-style:italic">// This will arrive as JSON</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6">    </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">return</span><span class="jsx-1290c20ab25545a6"> js</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">ValueOf</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#393A34">}</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#999988;font-style:italic">// ..</span></div></div></div></pre><p>Here's a high-level view of how everything fits together.</p><p><span class="jsx-9f7294b33c809b30 spacer"><img alt="Flow chart of the in-browser logic" fetchpriority="high" width="725" height="348.5192837465565" decoding="async" data-nimg="1" style="color:transparent;display:block;margin-inline:auto;max-width:100%;height:auto" srcset="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane-search-small.png&amp;w=750&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane-search-small.png&amp;w=1920&amp;q=100 2x" src="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane-search-small.png&amp;w=1920&amp;q=100"></span></p><p>A JavaScript support file, <a href="https://github.com/golang/go/blob/7be8358f70ff858f28b9aefe11986da25f1762bc/misc/wasm/wasm_exec.js">wasm_exec.js</a>, provides a Go class that connects JavaScript ⟷ Go. The Wasm module is loaded with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming">WebAssembly.instantiateStreaming</a> (<a href="https://github.com/golang/go/blob/b2fcfc1a50fbd46556f7075f7f1fbf600b5c9e5d/misc/wasm/wasm_exec.html#L17-L22">polyfill available</a>) and is passed to the Go instance. The store is downloaded via the Fetch API and is passed to the running Wasm module where the gob-encoded binary is decoded.</p><p>I wrote a ~50 line <a href="https://github.com/healeycodes/crane-search/blob/main/dist/crane.js">class</a> that abstracts away most of this to make the project easier for a developer to interact with.</p><pre><div class="jsx-1290c20ab25545a6 code"><div style="color:#393A34;background-color:#f6f8fa" class="jsx-1290c20ab25545a6 prism-code language-javascript"><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="color:#00009f">const</span><span class="jsx-1290c20ab25545a6"> crane </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">=</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#00009f">new</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6">Crane</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"crane.wasm"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">,</span><span class="jsx-1290c20ab25545a6"> </span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">"federalist.crane"</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">;</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#00009f">await</span><span class="jsx-1290c20ab25545a6"> crane</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">load</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6" style="display:inline-block">
</span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6" style="color:#00009f">const</span><span class="jsx-1290c20ab25545a6"> results </span><span class="jsx-1290c20ab25545a6" style="color:#393A34">=</span><span class="jsx-1290c20ab25545a6"> crane</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">query</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6" style="color:#e3116c">'some keywords'</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">;</span><span class="jsx-1290c20ab25545a6"></span></div><div class="jsx-1290c20ab25545a6 token-line code-line " style="color:#393A34"><span class="jsx-1290c20ab25545a6"></span><span class="jsx-1290c20ab25545a6">console</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">.</span><span class="jsx-1290c20ab25545a6" style="color:#d73a49">log</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">(</span><span class="jsx-1290c20ab25545a6">results</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">)</span><span class="jsx-1290c20ab25545a6" style="color:#393A34">;</span></div></div></div></pre><p>The result is, well, it's no Stork. But it works and it's fast. If there's one way to get a developer to respect the complexity of your project, have them build a technical demo of it with 1/50th of the features.</p><p><span class="jsx-9f7294b33c809b30 spacer"><img alt="Searching for keywords with Crane from the same dataset as Stork" fetchpriority="high" width="521" height="214" decoding="async" data-nimg="1" style="color:transparent;display:block;margin-inline:auto;max-width:100%;height:auto" srcset="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane.gif&amp;w=640&amp;q=100 1x, /_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane.gif&amp;w=1080&amp;q=100 2x" src="/_next/image?url=%2Fposts%2Fwebassembly-search-tools-for-static-websites%2Fcrane.gif&amp;w=1080&amp;q=100"></span></p><p>The binary is too large at around 3MB (but I didn't optimize for this). The solution for this is to read <a href="https://github.com/golang/go/wiki/WebAssembly#reducing-the-size-of-wasm-files">Reducing the size of Wasm files</a> from the Go GitHub or read any of the blogs that come up when you search <code>shrink go wasm binary</code>. The best advice I found is to use <a href="https://github.com/tinygo-org/tinygo">TinyGo</a> to generate the Wasm (the "Hello world" example is 575 bytes) and to limit the number of libraries you include. TinyGo actually artificially limits the libraries that you can use because it implements a subset of Go — which means the encoding/gob package is out (encoding/json too).</p><h2 id="design-problems">Design Problems</h2><p>If there's one thing I learned, it's that search is a reasonably solved problem. It's easy to get started; stand on the shoulders of algorithms and away you go. The key problem in this space is the developer experience. Configuring the build process of a static site can be tricky when things beyond the standard content (e.g. posts, images) need to be generated. In order to return metadata about each result, these types of search tools require a config (usually TOML or JSON) and generating these files adds complexity.</p><p>Setting up a search bar with any features beyond the basics (e.g. auto-complete, full keyboard support, highlighted excerpts) is non-trivial too, especially when you want it to feel good and always react fast.</p><p>It's also hard to build a solution that solves all use cases. Every time a feature is added (e.g. zero tolerance for false positives, fuzzy search, excerpts, partial matching) the index size grows by an order of magnitude. One rather esoteric idea that I toyed around with was building a search solution that split the index depending on the letters the user entered. Having an index for all the words that start with <code>a</code> and one for <code>b</code> and so on. However, English letter frequency is weighted towards things like <code>th</code> (see <a href="https://norvig.com/mayzner.html">English Letter Frequency Counts:
Mayzner Revisited</a>).</p><p>There's also the issue of getting people to contribute to your project. Wasm is a reasonably young technology and building, testing, and debugging your code feels harder than it should be. Building a full-stack Wasm project always feels like it requires one-too-many steps. (For Go, it's worth calling out <a href="https://github.com/agnivade/wasmbrowsertest">wasmbrowsertest</a> that automates in-browser testing.)</p><p>In <a href="https://rsms.me/wasm-intro">Introduction to WebAssembly</a>, the best low-level introduction to the technology I've seen, Rasmus Andersson writes:</p><blockquote><p>The web is an amazing concept that is currently falling short carrying a heavy legacy from the past. In order to bring truly great experiences to the web and blur the lines of what is and what isn’t a “native” experience, WebAssembly—or something else like it—needs to happen.</p></blockquote><p>A search tool for static sites is a good fit for Wasm, and I hope to see projects in this space continue to evolve. It's a noble goal to build a project which actually has <strong>four</strong> design areas when you think about it:</p><ul><li>Back-end (build process)</li><li>Back-of-the-front-end (search algorithm/Wasm)</li><li>Front-of-the-front-end (results UI)</li><li>Developer integration (APIs, docs)</li></ul><p>So, thank your local open source developer today.</p><br><small>Stork GIF sourced from <a href="https://github.com/jameslittle230/stork">https://github.com/jameslittle230/stork</a></small></div></main><hr class="jsx-b6ee29e184816190"><div class="jsx-2834850720 newsletter-section"><p class="jsx-2834850720 newsletter-desc">Subscribe to be notified (somewhat irregularly) of my new posts.</p><form action="https://buttondown.email/api/emails/embed-subscribe/healeycodes" method="post" target="popupwindow" class="jsx-2834850720 embeddable-buttondown-form"><div class="jsx-2834850720 control"><input required="" placeholder="adalovelace@gmail.com" type="email" name="email" id="bd-email" class="jsx-2834850720 email"><input type="hidden" name="embed" class="jsx-2834850720" value="1"><input type="submit" class="jsx-2834850720 subscribe" value="Subscribe"></div></form></div><div class="jsx-b6ee29e184816190 other-posts"><div class="jsx-b6ee29e184816190 other-posts-link prev"><a href="/generating-text-with-markov-chains">← Generating Text With Markov Chains</a></div><div class="jsx-b6ee29e184816190 other-posts-link next"><a href="/geoguessing-with-deep-learning">GeoGuessing with Deep Learning →</a></div></div></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"id":"webassembly-search-tools-for-static-websites","source":"
The challenge of searching static websites is effectively a solved problem with brilliant, yet widely unadopted, solutions.

These projects scan and index your content at build time and ship it to the browser with the rest of your static files. No out-of-your-control external service required. A small library in JavaScript (sometimes accompanied by WebAssembly) loads the index and allows instant searching and works just fine offline. Searching the complete Federalist Papers for multiple keywords takes less than 100µs in my Wasm [tech demo](https://github.com/healeycodes/crane-search) (I'll get to that later on).

The most popular libraries are written in JavaScript like [Lunr](https://lunrjs.com/), or [Fuse](https://github.com/krisk/Fuse), or [FlexSearch](https://github.com/nextapps-de/flexsearch). They provide pre-compiled indexes and [fuzzy](https://en.wikipedia.org/wiki/Approximate_string_matching), wildcard, and boolean searches. They have good documentation and are ready for production usage.

But I'm more interested in how the up-and-coming Wasm-powered projects work. Browser search is a space where Wasm can really find an edge. Wasm runs faster, loads quicker, and ships smaller binaries (in theory, in practice it takes some work to get there).

The two projects I looked at both use Rust as a backend language:

- [tinysearch](https://github.com/tinysearch/tinysearch) generates a small, self-contained Wasm module (with an embedded index). It aims for a small memory footprint by using Bloom filters — a space-efficient probabilistic data structure that results in a negligible amount of false positives. Read more in [A Tiny, Static, Full-Text Search Engine using Rust and WebAssembly](https://endler.dev/2019/tinysearch) by the creator, Matthias Endler.
- [Stork](https://stork-search.net/) focuses more on the developer experience with rich documentation and examples. Stork also pays keen attention to the user experience by providing a progress bar for loading the index, excerpts for the results (keywords highlighted), theme support, and more (see [Embedding the Interface](https://stork-search.net/docs/interface)). Learn about how it came to life in [Stork Turns One: Building a search tool for static sites with Rust and WebAssembly](https://jameslittle.me/blog/2020/one-year-of-stork/) by the creator, James Little.

Stork is more interesting to me because it focuses on the human experience — of the person who builds with it, and the person who searches. See the thin, quick, configurable UI below.

![The Stork instant search in-action](stork.gif)

In order to understand how these search tools work, and the design problems involved, I built a technical demo in Go, compiled to Wasm.

## Technical Demo

My technical demo is inspired by Stork and uses a near-identical configuration file setup. So it had to be named after a bird 🐦 too — [healeycodes/crane-search](https://github.com/healeycodes/crane-search).

Crane is two programs. The first program scans a group of documents and builds an efficient index. 1MB of text and metadata is turned into a 25KB index (14KB gzipped). The second program is a Wasm module that is sent to the browser along with a little bit of JavaScript glue code and the index. The result is an instant search engine that helps users find web pages as they type.

The full-text search engine is powered in part with code from Artem Krylysov's blog post [Let's build a Full-Text Search engine](https://artem.krylysov.com/blog/2020/07/28/lets-build-a-full-text-search-engine/).

The core data-structure is an inverted index. It maps words to document IDs. This means we can check very quickly (i.e. 100µs within Wasm) which documents a word can be found in. At build time, we loop over the document files and add to the inverted index. We also create a list of results so we can relate a document ID to a document's metadata (defined in the configuration file). The metadata includes the title and URL so that we can display a list of search results in the browser.

We can return results for multiple keywords by looking at the common document IDs for each keyword. This takes linear time as the IDs are inserted into the index in order.

During the build stage, we perform normalization to make the search engine more helpful and accurate. For example, if you search for `fish` you probably want to match `Fishing`. Words are turned into lowercase, common words are dropped, and words are reduced into their root form (aka [stemming](https://en.wikipedia.org/wiki/Stemming) — Krylysov's example code uses [Snowball](https://github.com/kljensen/snowball) as a stemmer).

The document `"Alice likes to go fishing"` becomes `["alice", "go", "fish"]`. The search term `"Fishing"` is also turned into a token, at search-time it becomes `"fish"`.

To handle the document metadata, Crane's build program is passed the location of the configuration file. This tells it where to find the documents to index on disk, where they can be found on the static website, and what the search result should be titled.

```toml
[input]
files = [
    {
        path = "docs/essays/essay01.txt",
        url = "essays/essay01.txt",
        title = "Introduction"
    },
    # etc.
]

[output]
filename = "dist/federalist.crane"
```

The index and result data is combined into a single struct called a store. It's encoded using [encoding/gob](https://golang.org/pkg/encoding/gob/), a binary encoding that is faster and smaller than JSON ([one](https://gist.github.com/evalphobia/a2ba2636acbc112f68dcd89e8b81d349), [two](http://ugorji.net/blog/benchmarking-serialization-in-go)).

```go
file, err := os.Create(config.Output.Filename)
check(err)
defer file.Close()

encoder := gob.NewEncoder(file)
store := search.Store{
    Index:   index,
    Results: results,
}
err = encoder.Encode(store)
check(err)
```

The second part of Crane is the program that's compiled into Wasm and sent to the browser. It uses the Go standard library package [syscall/js](https://golang.org/pkg/syscall/js/).

> Package js gives access to the WebAssembly host environment when using the js/wasm architecture. Its API is based on JavaScript semantics.

Our browser program makes two functions available in the global JavaScript scope. A new goroutine is spawned when they're called.

```go
// Store is a shared type between both programs (build/browser)
var store search.Store

func main() {
    js.Global().Set("_craneLoad", js.FuncOf(load))
    js.Global().Set("_craneQuery", js.FuncOf(query))
    // Wait indefinitely,
    // required so that our Wasm module doesn't exit straight away
    select {}
}

func query(this js.Value, args []js.Value) interface{} {
    searchTerm := args[0].String()
    start := time.Now()
    matchedIDs := store.Index.Search(searchTerm)
    log.Printf("Search found %d documents in %v", len(matchedIDs), time.Since(start))

    var results []interface{}
    for _, id := range matchedIDs {
        results = append(results,
            map[string]interface{}{
                "title": store.Results[id].Title,
                "url":   store.Results[id].URL,
                "id":    store.Results[id].ID,
           })
    }

    // This will arrive as JSON
    return js.ValueOf(results)
}

// ..
```

Here's a high-level view of how everything fits together.

![Flow chart of the in-browser logic](crane-search-small.png)

A JavaScript support file, [wasm_exec.js](https://github.com/golang/go/blob/7be8358f70ff858f28b9aefe11986da25f1762bc/misc/wasm/wasm_exec.js), provides a Go class that connects JavaScript ⟷ Go. The Wasm module is loaded with [WebAssembly.instantiateStreaming](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming) ([polyfill available](https://github.com/golang/go/blob/b2fcfc1a50fbd46556f7075f7f1fbf600b5c9e5d/misc/wasm/wasm_exec.html#L17-L22)) and is passed to the Go instance. The store is downloaded via the Fetch API and is passed to the running Wasm module where the gob-encoded binary is decoded.

I wrote a ~50 line [class](https://github.com/healeycodes/crane-search/blob/main/dist/crane.js) that abstracts away most of this to make the project easier for a developer to interact with.

```javascript
const crane = new Crane("crane.wasm", "federalist.crane");
await crane.load()

const results = crane.query('some keywords');
console.log(results);
```

The result is, well, it's no Stork. But it works and it's fast. If there's one way to get a developer to respect the complexity of your project, have them build a technical demo of it with 1/50th of the features.

![Searching for keywords with Crane from the same dataset as Stork](crane.gif)

The binary is too large at around 3MB (but I didn't optimize for this). The solution for this is to read [Reducing the size of Wasm files](https://github.com/golang/go/wiki/WebAssembly#reducing-the-size-of-wasm-files) from the Go GitHub or read any of the blogs that come up when you search `shrink go wasm binary`. The best advice I found is to use [TinyGo](https://github.com/tinygo-org/tinygo) to generate the Wasm (the "Hello world" example is 575 bytes) and to limit the number of libraries you include. TinyGo actually artificially limits the libraries that you can use because it implements a subset of Go — which means the encoding/gob package is out (encoding/json too).

## Design Problems

If there's one thing I learned, it's that search is a reasonably solved problem. It's easy to get started; stand on the shoulders of algorithms and away you go. The key problem in this space is the developer experience. Configuring the build process of a static site can be tricky when things beyond the standard content (e.g. posts, images) need to be generated. In order to return metadata about each result, these types of search tools require a config (usually TOML or JSON) and generating these files adds complexity.

Setting up a search bar with any features beyond the basics (e.g. auto-complete, full keyboard support, highlighted excerpts) is non-trivial too, especially when you want it to feel good and always react fast.

It's also hard to build a solution that solves all use cases. Every time a feature is added (e.g. zero tolerance for false positives, fuzzy search, excerpts, partial matching) the index size grows by an order of magnitude. One rather esoteric idea that I toyed around with was building a search solution that split the index depending on the letters the user entered. Having an index for all the words that start with `a` and one for `b` and so on. However, English letter frequency is weighted towards things like `th` (see [English Letter Frequency Counts:
Mayzner Revisited](https://norvig.com/mayzner.html)).

There's also the issue of getting people to contribute to your project. Wasm is a reasonably young technology and building, testing, and debugging your code feels harder than it should be. Building a full-stack Wasm project always feels like it requires one-too-many steps. (For Go, it's worth calling out [wasmbrowsertest](https://github.com/agnivade/wasmbrowsertest) that automates in-browser testing.)

In [Introduction to WebAssembly](https://rsms.me/wasm-intro), the best low-level introduction to the technology I've seen, Rasmus Andersson writes:

> The web is an amazing concept that is currently falling short carrying a heavy legacy from the past. In order to bring truly great experiences to the web and blur the lines of what is and what isn’t a “native” experience, WebAssembly—or something else like it—needs to happen.

A search tool for static sites is a good fit for Wasm, and I hope to see projects in this space continue to evolve. It's a noble goal to build a project which actually has **four** design areas when you think about it:

- Back-end (build process)
- Back-of-the-front-end (search algorithm/Wasm)
- Front-of-the-front-end (results UI)
- Developer integration (APIs, docs)

So, thank your local open source developer today.

<br>

<small>Stork GIF sourced from https://github.com/jameslittle230/stork</small>
","imageMetadata":{"crane-build-small.png":{"height":501,"width":726,"type":"png"},"crane-build.png":{"height":728,"width":1056,"type":"png"},"crane-search-small.png":{"height":349,"width":726,"type":"png"},"crane-search.png":{"height":808,"width":1680,"type":"png"},"crane.gif":{"height":214,"width":521,"type":"gif"},"stork.gif":{"height":464,"width":600,"type":"gif"}},"videoMetadata":{},"content":"
The challenge of searching static websites is effectively a solved problem with brilliant, yet widely unadopted, solutions.

These projects scan and index your content at build time and ship it to the browser with the rest of your static files. No out-of-your-control external service required. A small library in JavaScript (sometimes accompanied by WebAssembly) loads the index and allows instant searching and works just fine offline. Searching the complete Federalist Papers for multiple keywords takes less than 100µs in my Wasm [tech demo](https://github.com/healeycodes/crane-search) (I'll get to that later on).

The most popular libraries are written in JavaScript like [Lunr](https://lunrjs.com/), or [Fuse](https://github.com/krisk/Fuse), or [FlexSearch](https://github.com/nextapps-de/flexsearch). They provide pre-compiled indexes and [fuzzy](https://en.wikipedia.org/wiki/Approximate_string_matching), wildcard, and boolean searches. They have good documentation and are ready for production usage.

But I'm more interested in how the up-and-coming Wasm-powered projects work. Browser search is a space where Wasm can really find an edge. Wasm runs faster, loads quicker, and ships smaller binaries (in theory, in practice it takes some work to get there).

The two projects I looked at both use Rust as a backend language:

- [tinysearch](https://github.com/tinysearch/tinysearch) generates a small, self-contained Wasm module (with an embedded index). It aims for a small memory footprint by using Bloom filters — a space-efficient probabilistic data structure that results in a negligible amount of false positives. Read more in [A Tiny, Static, Full-Text Search Engine using Rust and WebAssembly](https://endler.dev/2019/tinysearch) by the creator, Matthias Endler.
- [Stork](https://stork-search.net/) focuses more on the developer experience with rich documentation and examples. Stork also pays keen attention to the user experience by providing a progress bar for loading the index, excerpts for the results (keywords highlighted), theme support, and more (see [Embedding the Interface](https://stork-search.net/docs/interface)). Learn about how it came to life in [Stork Turns One: Building a search tool for static sites with Rust and WebAssembly](https://jameslittle.me/blog/2020/one-year-of-stork/) by the creator, James Little.

Stork is more interesting to me because it focuses on the human experience — of the person who builds with it, and the person who searches. See the thin, quick, configurable UI below.

![The Stork instant search in-action](stork.gif)

In order to understand how these search tools work, and the design problems involved, I built a technical demo in Go, compiled to Wasm.

## Technical Demo

My technical demo is inspired by Stork and uses a near-identical configuration file setup. So it had to be named after a bird 🐦 too — [healeycodes/crane-search](https://github.com/healeycodes/crane-search).

Crane is two programs. The first program scans a group of documents and builds an efficient index. 1MB of text and metadata is turned into a 25KB index (14KB gzipped). The second program is a Wasm module that is sent to the browser along with a little bit of JavaScript glue code and the index. The result is an instant search engine that helps users find web pages as they type.

The full-text search engine is powered in part with code from Artem Krylysov's blog post [Let's build a Full-Text Search engine](https://artem.krylysov.com/blog/2020/07/28/lets-build-a-full-text-search-engine/).

The core data-structure is an inverted index. It maps words to document IDs. This means we can check very quickly (i.e. 100µs within Wasm) which documents a word can be found in. At build time, we loop over the document files and add to the inverted index. We also create a list of results so we can relate a document ID to a document's metadata (defined in the configuration file). The metadata includes the title and URL so that we can display a list of search results in the browser.

We can return results for multiple keywords by looking at the common document IDs for each keyword. This takes linear time as the IDs are inserted into the index in order.

During the build stage, we perform normalization to make the search engine more helpful and accurate. For example, if you search for `fish` you probably want to match `Fishing`. Words are turned into lowercase, common words are dropped, and words are reduced into their root form (aka [stemming](https://en.wikipedia.org/wiki/Stemming) — Krylysov's example code uses [Snowball](https://github.com/kljensen/snowball) as a stemmer).

The document `"Alice likes to go fishing"` becomes `["alice", "go", "fish"]`. The search term `"Fishing"` is also turned into a token, at search-time it becomes `"fish"`.

To handle the document metadata, Crane's build program is passed the location of the configuration file. This tells it where to find the documents to index on disk, where they can be found on the static website, and what the search result should be titled.

```toml
[input]
files = [
    {
        path = "docs/essays/essay01.txt",
        url = "essays/essay01.txt",
        title = "Introduction"
    },
    # etc.
]

[output]
filename = "dist/federalist.crane"
```

The index and result data is combined into a single struct called a store. It's encoded using [encoding/gob](https://golang.org/pkg/encoding/gob/), a binary encoding that is faster and smaller than JSON ([one](https://gist.github.com/evalphobia/a2ba2636acbc112f68dcd89e8b81d349), [two](http://ugorji.net/blog/benchmarking-serialization-in-go)).

```go
file, err := os.Create(config.Output.Filename)
check(err)
defer file.Close()

encoder := gob.NewEncoder(file)
store := search.Store{
    Index:   index,
    Results: results,
}
err = encoder.Encode(store)
check(err)
```

The second part of Crane is the program that's compiled into Wasm and sent to the browser. It uses the Go standard library package [syscall/js](https://golang.org/pkg/syscall/js/).

> Package js gives access to the WebAssembly host environment when using the js/wasm architecture. Its API is based on JavaScript semantics.

Our browser program makes two functions available in the global JavaScript scope. A new goroutine is spawned when they're called.

```go
// Store is a shared type between both programs (build/browser)
var store search.Store

func main() {
    js.Global().Set("_craneLoad", js.FuncOf(load))
    js.Global().Set("_craneQuery", js.FuncOf(query))
    // Wait indefinitely,
    // required so that our Wasm module doesn't exit straight away
    select {}
}

func query(this js.Value, args []js.Value) interface{} {
    searchTerm := args[0].String()
    start := time.Now()
    matchedIDs := store.Index.Search(searchTerm)
    log.Printf("Search found %d documents in %v", len(matchedIDs), time.Since(start))

    var results []interface{}
    for _, id := range matchedIDs {
        results = append(results,
            map[string]interface{}{
                "title": store.Results[id].Title,
                "url":   store.Results[id].URL,
                "id":    store.Results[id].ID,
           })
    }

    // This will arrive as JSON
    return js.ValueOf(results)
}

// ..
```

Here's a high-level view of how everything fits together.

![Flow chart of the in-browser logic](crane-search-small.png)

A JavaScript support file, [wasm_exec.js](https://github.com/golang/go/blob/7be8358f70ff858f28b9aefe11986da25f1762bc/misc/wasm/wasm_exec.js), provides a Go class that connects JavaScript ⟷ Go. The Wasm module is loaded with [WebAssembly.instantiateStreaming](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming) ([polyfill available](https://github.com/golang/go/blob/b2fcfc1a50fbd46556f7075f7f1fbf600b5c9e5d/misc/wasm/wasm_exec.html#L17-L22)) and is passed to the Go instance. The store is downloaded via the Fetch API and is passed to the running Wasm module where the gob-encoded binary is decoded.

I wrote a ~50 line [class](https://github.com/healeycodes/crane-search/blob/main/dist/crane.js) that abstracts away most of this to make the project easier for a developer to interact with.

```javascript
const crane = new Crane("crane.wasm", "federalist.crane");
await crane.load()

const results = crane.query('some keywords');
console.log(results);
```

The result is, well, it's no Stork. But it works and it's fast. If there's one way to get a developer to respect the complexity of your project, have them build a technical demo of it with 1/50th of the features.

![Searching for keywords with Crane from the same dataset as Stork](crane.gif)

The binary is too large at around 3MB (but I didn't optimize for this). The solution for this is to read [Reducing the size of Wasm files](https://github.com/golang/go/wiki/WebAssembly#reducing-the-size-of-wasm-files) from the Go GitHub or read any of the blogs that come up when you search `shrink go wasm binary`. The best advice I found is to use [TinyGo](https://github.com/tinygo-org/tinygo) to generate the Wasm (the "Hello world" example is 575 bytes) and to limit the number of libraries you include. TinyGo actually artificially limits the libraries that you can use because it implements a subset of Go — which means the encoding/gob package is out (encoding/json too).

## Design Problems

If there's one thing I learned, it's that search is a reasonably solved problem. It's easy to get started; stand on the shoulders of algorithms and away you go. The key problem in this space is the developer experience. Configuring the build process of a static site can be tricky when things beyond the standard content (e.g. posts, images) need to be generated. In order to return metadata about each result, these types of search tools require a config (usually TOML or JSON) and generating these files adds complexity.

Setting up a search bar with any features beyond the basics (e.g. auto-complete, full keyboard support, highlighted excerpts) is non-trivial too, especially when you want it to feel good and always react fast.

It's also hard to build a solution that solves all use cases. Every time a feature is added (e.g. zero tolerance for false positives, fuzzy search, excerpts, partial matching) the index size grows by an order of magnitude. One rather esoteric idea that I toyed around with was building a search solution that split the index depending on the letters the user entered. Having an index for all the words that start with `a` and one for `b` and so on. However, English letter frequency is weighted towards things like `th` (see [English Letter Frequency Counts:
Mayzner Revisited](https://norvig.com/mayzner.html)).

There's also the issue of getting people to contribute to your project. Wasm is a reasonably young technology and building, testing, and debugging your code feels harder than it should be. Building a full-stack Wasm project always feels like it requires one-too-many steps. (For Go, it's worth calling out [wasmbrowsertest](https://github.com/agnivade/wasmbrowsertest) that automates in-browser testing.)

In [Introduction to WebAssembly](https://rsms.me/wasm-intro), the best low-level introduction to the technology I've seen, Rasmus Andersson writes:

> The web is an amazing concept that is currently falling short carrying a heavy legacy from the past. In order to bring truly great experiences to the web and blur the lines of what is and what isn’t a “native” experience, WebAssembly—or something else like it—needs to happen.

A search tool for static sites is a good fit for Wasm, and I hope to see projects in this space continue to evolve. It's a noble goal to build a project which actually has **four** design areas when you think about it:

- Back-end (build process)
- Back-of-the-front-end (search algorithm/Wasm)
- Front-of-the-front-end (results UI)
- Developer integration (APIs, docs)

So, thank your local open source developer today.

<br>

<small>Stork GIF sourced from https://github.com/jameslittle230/stork</small>
","title":"WebAssembly Search Tools for Static Sites","description":"Building a technical demo to understand this blossoming area of technology.","date":"2021-02-20","tags":["go"],"outdated":false,"prevPost":{"id":"generating-text-with-markov-chains","content":"
I wanted to write a program that I could feed a bunch of novels and then produce similar text to the author's writing.

One method of generating fake but familiar looking text is to use a Markov chain generator. There is a fantastic Python library for doing this called [jsvine/markovify](https://github.com/jsvine/markovify) but I wanted to learn more about how it works under the hood so I implemented the algorithms from scratch!

Before we get to text generation, let's start by generating some fake weather. Skip the following section if you're familiar with Markov chains.

## Fake Weather Generation

I have some historical weather data from my town. The weather here is either sunny or rainy. When it's sunny, there's a good chance that it remains sunny the next day. It rarely rains but when it does it often rains for a few days.


Rather than using a naive probability (e.g. there's an ~83% chance it is sunny vs. rainy on any given day) we'll use a Markov chain to generate more realistic looking data. Our generated data will have streaks of weather which will more closely resemble real life patterns.

To be specific, if it's sunny there's a 10% chance it will be rainy the next day and a 90% chance it will stay sunny. If it's rainy then there's 50% chance it will be sunny the next day and a 50% chance it will stay rainy.

Here's a diagram of this two-state Markov process.

![A Markov chain with the sunny/rainy values as described above.](weather-markov-chain.png)

Instead of using weights to describe probability, let's distribute the states in a list that we randomly pick from. I find that defining Markov chains like this (while far more computationally expensive) is easier to debug.

```python
weather_chain = {
    'sun': ['sun', 'sun', 'sun', 'sun', 'sun', 'sun', 'sun', 'sun', 'sun', 'rain'],
    'rain': ['sun', 'rain']
}
```

We consume this model by picking a random starting state and using the current state to choose randomly from the possible future states. We do this over and over to generate a sequence.

```python
import random

# the initial state is chosen randomly
weather = [random.choice(list(weather_chain.keys()))]

for i in range(10):
    weather.append(random.choice(weather_chain[weather[i]]))
```

In this example output, we can see that rainy days are 'sticky' as we would expect from the model. 

```python
['rain', 'rain', 'rain', 'sun', 'sun', 'sun', 'sun', 'sun', 'rain', 'rain', 'sun']
```

## Fake Text Generation

Instead of having a predefined Markov chain like we saw in the previous section, let's build one from real data. The full source code for this article and the text corpuses can be found at [healeycodes/markov-chain-generator](https://github.com/healeycodes/markov-chain-generator).

The code excerpts assume that we're generating fiction. So the source text must have capital letters at the start of sentences and full stops at the end of sentences. We can use these two markers to generate text chunks that have a beginning and an end.

In our weather example, the state size was one — to decide the next step in the sequence, we only considered one previous day of weather. When it comes to generating language, a state size of one sometimes isn't big enough and the arrangement of words can be too random to be interesting. A state size of two is a good starting point. Going higher than two can produce text that is too similar to the original text corpus.

The following function builds a Markov chain in the same format as our weather example. It takes a source text and a state size and returns a dictionary where the keys are the current state and their values are a list of possible future states. The lists contain duplicates and this is how we handle the probabilities of future states.

```python
def build_model(source, state_size):
    '''
    Given a corpus and a state size, build a Markov chain.
    '''
    source = source.split()
    model = {}
    for i in range(state_size, len(source)):
        current_word = source[i]
        previous_words = ' '.join(source[i-state_size:i])
        if previous_words in model:
            model[previous_words].append(current_word)
        else:
            model[previous_words] = [current_word]

    return model
```

Given a tiny source of `'An apple is very good. An orange is very bad.'` and a state size of `2` it will produce the following Markov chain. Since the source was so small there are only four possible complete sentences.

```json
{
  "An apple":[
    "is"
  ],
  "apple is":[
    "very"
  ],
  "is very":[
    "good.",
    "bad."
  ],
  "very good.":[
    "An"
  ],
  "good. An":[
    "orange"
  ],
  "An orange":[
    "is"
  ],
  "orange is":[
    "very"
  ]
}
```

The following function consumes the Markov chain model and generates some fake text for us. To achieve a minimum length, we keep generating until we hit the minimum length and then keep going until we reach a token that ends with a full stop. To find a correct starting point, we pick a random key (two words) where the first character is a capital letter.

```python
def generate_text(model, state_size, min_length):
    '''
    Consume a Markov chain model (make sure to specify the <state_size> used)
    to generate text that is at least <min_length> size long.
    '''
    def get_new_starter():
        return random.choice([s.split(' ') for s in model.keys() if s[0].isupper()])
    text = get_new_starter()

    i = state_size
    while True:
        key = ' '.join(text[i-state_size:i])
        if key not in model:
            text += get_new_starter()
            i += 1
            continue

        next_word = random.choice(model[key])
        text.append(next_word)
        i += 1
        if i > min_length and text[-1][-1] == '.':
            break
    return ' '.join(text)
```

Here are those four possible complete sentences from our previous Markov chain. These can be combined infinitely by our function.


```python
'An apple is very bad.'
'An orange is very bad.'
'An orange is very good.'
'An apple is very good.'
```

## Some Examples

We can now feed in large amounts of text from an author and generate fake writing! In fact, any corpus that uses sentences will work with our program. For example, here is the result of feeding in a few Wikipedia articles.

> Cricket is more similar to dust devils and landspouts. They form when a homicide rate of 34.2 per 100,000 was reported. This included 15 officer-involved shootings. One shooting led to the latest hour of it; and lately, I know of but love, desperate love, the worst of all the more remote islands. At around the field. One of Wollstonecraft's most popular metaphors draw on military concepts: Disease is an early type of fiction that were quick to resort to violence. One of Wollstonecraft's favorite arguments.

Here's some Edgar Allen Poe.

> Count could recollect, it was never worth the trouble of the stranger. But, as usual, enveloped in frequent rolls, or bandages, of linen; but, in place of conference with the whole matter as a natural result of the river, and, plunging through a single slender gold chain, and throws a tranquil but magical radiance over all. I cannot enter into details just now: but it was found, on Sunday morning, that he was forced to allow, had ever suspected of existing in the heathen is unwonted; and fickle-mindedness has ever thought of this life and of cutting him off with a layer of plaster, thickly gilt and painted.

## Further Resources

The full source code and a few text corpuses on [healeycodes/markov-chain-generator](https://github.com/healeycodes/markov-chain-generator).

The sun/rain example was taken from [Wikipedia](https://en.wikipedia.org/wiki/Examples_of_Markov_chains#A_simple_weather_model). Victor Powell's article, [Markov Chains](https://setosa.io/ev/markov-chains/), was also helpful for my initial understanding and is worth checking out for the interactive graphics alone.

Some of the articles about Markov chains are a little inaccessible to those without a maths background. However, there's a Simple English version of Wikipedia. Many articles have an alternative page which you can find by replacing the `en` in the URL bar with `simple`. For example, the [simple version](https://simple.wikipedia.org/wiki/Markov_chain) of the Markov chain page.

Daniel Shiffman also covered Markov chains in a Coding Challenge on [The Coding Train](https://www.youtube.com/watch?v=eGFJ8vugIWA).
","title":"Generating Text With Markov Chains","description":"Generating random but familiar text by building Markov chains from scratch.","date":"2021-01-31","tags":["python"],"outdated":false},"nextPost":{"id":"geoguessing-with-deep-learning","content":"
- [A dash of deep learning](#a-dash-of-deep-learning)
- [Automating GeoGuessr with Selenium](#automating-geoguessr-with-selenium)
- [Geolocation estimation](#geolocation-estimation)
- [Web demo](#web-demo)
- [The learnability of GeoGuessr](#the-learnability-of-geoguessr)

<br>

During this last lockdown in the UK, my wife and I have been playing GeoGuessr. It's slower paced than the computer games we normally play but it goes well with having an 11-week old baby who becomes more alive each and every day.

GeoGuessr is a _geographic discovery game_. You are dropped into a random Google Street View and tasked with pointing out your location on a map. You can look around, zoom, and follow the car's path through the local streets. 

![GeoGuessr](geoguessr.png)

We've started to take the Daily Challenge on GeoGuessr quite seriously. We show up every day and push for a new high score. In the Daily Challenge there's a three minute limit per round which, for us, is either filled with frantic clicking as we zip through the Australian outback (probably while mistaking it for South Africa), or debating back and forth about whether `ø` exists in the Swedish language.

I now have a lot of _I'll know it when I see it_ knowledge. I know Greenland on sight. My lost knowledge of country flags has returned, along with new knowledge of USA state flags, which countries drive on the right vs. left, which use KM vs M. I know pretty much every country-specific domain name (they're often on roadside adverts) – I won't forget [.yu](https://en.wikipedia.org/wiki/.yu) anytime soon.

Did you know that black and white guard rails are commonly found in Russia and Ukraine? Or that you can make out the blue EU bar on license plates through Google Street View's blurification? Read more in this _80,000 word_ guide – [Geoguessr - the Top Tips, Tricks and Techniques](https://somerandomstuff1.wordpress.com/2019/02/08/geoguessr-the-top-tips-tricks-and-techniques/).

> The red and white striped arrow pointing downwards indicates that you are in Japan, most likely on the island of Hokkaido or possibly on the island of Honshu near mountains.

![Utility pole with red and white striped arrow pointing downwards.](arrows.png)

## A dash of deep learning

I once read that machine learning is currently capable of doing anything a human can do in under one second. Recognize a face, pick out some text from an image, swerve to avoid another car. This got me thinking, and thinking led me to a paper called _Geolocation Estimation of Photos using a Hierarchical Model and Scene Classification_ by Eric Müller-Budack, Kader Pustu-Iren, and Ralph Ewerth. This paper treats "geolocalization as a classification problem where the earth is subdivided into geographical cells."

It predicts the GPS coordinates of photos. 

![Left: Workflow of the proposed geolocation estimation approach. Right: Sample
images of different locations for specific scene concepts.](paper-illustration.png)

Even indoor photos! (GeoGuessr's Daily Challenge will often trap you inside a museum).

Recently, the paper's authors released a PyTorch implementation and provided weights of a pre-trained `base(M, f*)` model with underlying ResNet50 architecture.

I presumed that the pretrained model would not map well to the sections of photospheres that I could scrape from GeoGuessr. For training data, the authors used "a subset of the Yahoo Flickr Creative Commons 100 Million dataset (YFCC100M)". Which contains "around five million geo-tagged images from Flickr [and] ambiguous photos of, e.g., indoor environments, food, and humans for which the location is difficult to predict."

What was interesting was that on the Im2GPS dataset, humans found the location of an image at country granularity (within 750km) 13.9% of the time but the Individual Scene Networks were able to do it 66.7% of the time!

![Table 6. Results on the Im2GPS (top) and Im2GPS3k (bottom) test sets. Percentage is the fraction of images localized within the given radius using the GCD distance.](table6.png)

So the question became: who is better at GeoGuessr, my wife (a formidable player) or the machine?

## Automating GeoGuessr with Selenium

To scrape screenshots of the current in-game location, I created a Selenium program that performs the following four times:

- Take a screenshot of the canvas
- Step forwards
- Rotate the view ~90 degrees

![An automated GeoGuessr run.](selenium.gif)

The number of times this happens is tuneable via `NUMBER_OF_SCREENSHOTS` in the snippet below.

```python
'''
Given a GeoGuessr map URL (e.g. https://www.geoguessr.com/game/5sXkq4e32OvHU4rf)
take a number of screenshots each one step further down the road and rotated ~90 degrees.
Usage: "python file_name.py https://www.geoguessr.com/game/5sXkq4e32OvHU4rf"
'''
from selenium import webdriver
import time
import sys
NUMBER_OF_SCREENSHOTS = 4


geo_guessr_map = sys.argv[1]

driver = webdriver.Chrome()
driver.get(geo_guessr_map)

# let JS etc. load
time.sleep(2)


def screenshot_canvas():
    '''
    Take a screenshot of the streetview canvas.
    '''
    with open(f'canvas_{int(time.time())}.png', 'xb') as f:
        canvas = driver.find_element_by_tag_name('canvas')
        f.write(canvas.screenshot_as_png)


def rotate_canvas():
    '''
    Drag and click the <main> elem a few times to rotate us ~90 degrees.
    '''
    main = driver.find_element_by_tag_name('main')
    for _ in range(0, 5):
        action = webdriver.common.action_chains.ActionChains(driver)
        action.move_to_element(main) \
            .click_and_hold(main) \
            .move_by_offset(118, 0) \
            .release(main) \
            .perform()


def move_to_next_point():
    '''
    Click one of the next point arrows, doesn't matter which one
    as long as it's the same one for a session of Selenium.
    '''
    next_point = driver.find_element_by_css_selector('[fill="black"]')
    action = webdriver.common.action_chains.ActionChains(driver)
    action.click(next_point).perform()


for _ in range(0, NUMBER_OF_SCREENSHOTS):
    screenshot_canvas()
    move_to_next_point()
    rotate_canvas()

driver.close()
```

The screenshots will also contain the GeoGuessr UI. I didn't look into stripping it.

## Geolocation estimation

I checked out the [PyTorch branch](https://github.com/TIBHannover/GeoEstimation/tree/pytorch), downloaded the pretrained model, and installed the dependencies via `conda`. I commend the repository's README. The [requirements](https://github.com/TIBHannover/GeoEstimation/tree/pytorch#requirements) section was quite clear and I didn't run into any problems on a fresh Ubuntu 20.04 box.

I picked the [World](https://www.geoguessr.com/maps/world) map on GeoGuessr for the showdown between human and machine. I gave the URL to my Selenium program and then ran inference against the four screenshots captured from GeoGuessr. 

The machine's trimmed results are below.

```bash
python -m classification.inference --image_dir ../images/

                                lat        lng
canvas_1616446493 hierarchy     44.002556  -72.988518
canvas_1616446507 hierarchy     46.259434  -119.307884
canvas_1616446485 hierarchy     40.592514  -111.940224
canvas_1616446500 hierarchy     40.981506  -72.332581
```

I presented the same four screenshots to my wife. She guessed a point in Texas. The actual starting location was over in Pennsylvania. The machine, indecisively, had four different guesses for each of the four screenshots. All of the machine's guesses were in the USA. Two very close ones and two further away.

![USA guesses.](usa-guesses.png)

If we take the average location, the machine wins this round!

We played two more follow up rounds and the final results were 2-1 to the machine. The machine got quite close with a street in Singapore but failed to get anywhere near a snowy street in Canada (Madeline got the town in seconds).

I learned after writing this post that there's some fantastic prior art on machine vs. human on the battleground of GeoGuessr. In _PlaNet - Photo Geolocation with Convolutional Neural Networks_, Tobias Weyand, Ilya Kostrikov, and James Philbin also tried to determine the location of a photo from just its pixels.

> To find out how PlaNet compares with human intuition, we let it compete against 10 well-traveled human subjects in a game of Geoguessr (www.geoguessr.com). 

> [H]umans and PlaNet played a total of 50 different rounds. PlaNet won 28 of the 50 rounds with a median localization error of 1131.7 km, while the median human localization error was 2320.75 km.

## Web demo

The authors of _Geolocation Estimation of Photos using a Hierarchical Model and Scene Classification_ built a pretty neat web-tool. Here I've run it against one of the Selenium screenshots.

> A graphical demonstration where you can compete against the deep learning approach presented in the publication can be found on: https://tibhannover.github.io/GeoEstimation/. We also created an extended web-tool that additionally supports uploading and analyzing your own images: https://labs.tib.eu/geoestimation

![A machine annotated image of the street in Pennsylvania.](web-tool.png)

## The learnability of GeoGuessr

There are many reasons why trying to beat GeoGuessr (by which we mean out performing a human very often) with machine learning might be easier than locating any human-taken photo.

Compared to general geolocation estimation, in GeoGuessr we are (almost always) trying to find out which road we are on. This means more effort can be made into recognizing things which are always there – like road markings or car makes and models (both often betray a country). Effort could be made to travel down roads looking for road signs which provide the country's language or the signage text could be used to search a look-up table.

There are other markers, that some in the GeoGuessr community consider cheating, that a learning framework may pick up.

Looking downwards in street view will reveal part of the vehicle that captured the current photosphere. For example, in Kenya the front of the street view car has a black snorkel. Much of Vietnam was recorded on a motorbike and you can often see the rider's helmet. Countries are often covered by the same car with a unique color or antenna.

![The snorkel car and the Vietnam rider's helmet.](snorkel.png)

In other places, there are rifts in the sky where the photosphere stitching looks torn (largely in Senegal, Montenegro and Albania). Across Africa, there are sometimes escort cars that follow the street view car. There are different camera generations – with different resolutions, types of halo, colouring, and blurring at the bottom of the sphere. In the bottom corner of the photosphere there is the credit message – it usually has "Google" and a year but will occasionally have a photographer's name.

By exploiting these, I wouldn't be surprised if a machine could take down even the best GeoGuessrers in a timed competition. In fact, I'll go as far to say we are one research grant away from being categorically worse at GeoGuessr than machines.","title":"GeoGuessing with Deep Learning","description":"Applying photo geolocation estimation to the game of GeoGuessr.","date":"2021-03-24","tags":["python"],"outdated":false}},"__N_SSG":true},"page":"/[id]","query":{"id":"webassembly-search-tools-for-static-websites"},"buildId":"Q_5VSVzDpSrSjY_zBB1-M","isFallback":false,"gsp":true,"scriptLoader":[]}</script><script src="//gc.zgo.at/count.js" data-goatcounter="https://healeycodes.goatcounter.com/count" data-nscript="afterInteractive"></script><next-route-announcer><p aria-live="assertive" id="__next-route-announcer__" role="alert" style="border: 0px; clip: rect(0px, 0px, 0px, 0px); height: 1px; margin: -1px; overflow: hidden; padding: 0px; position: absolute; top: 0px; width: 1px; white-space: nowrap; overflow-wrap: normal;"></p></next-route-announcer><script src="/_next/static/chunks/pages/index-a259723d5cc826a6.js"></script><script src="/_next/static/chunks/pages/projects-a04138a241233f9b.js"></script><script src="/_next/static/chunks/pages/articles-d2f9082d0b927151.js"></script><script src="/_next/static/chunks/pages/notes-bf66985585fc676f.js"></script><script src="/_next/static/chunks/pages/about-dba03966484d34da.js"></script></body><div style="all: initial;"><div style="all: initial;" id="__hcfy__"></div></div><div id="immersive-translate-popup" style="all: initial"></div></html>