<!-- Filename: 书签工具栏/study/处理器/risc-v/虚拟化/内存/TLB/[PATCH v4] RISC-V_ KVM_ Flush VS-stage TLB after VCPU migration for split two-stage TLBs (2025-11-21 19：07：41).html
 Page saved with X-Webpage-Conserve 
 url: https://lore.kernel.org/kvm-riscv/KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/T/#t
 Summary: 
-->
<html><head><title>[PATCH v4] RISC-V: KVM: Flush VS-stage TLB after VCPU migration for split two-stage TLBs</title><link rel="alternate" title="Atom feed" href="../../new.atom" type="application/atom+xml"><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link type="text/css" rel="stylesheet" media="screen,print" href="../../216light.css?67c636a2"><link type="text/css" rel="stylesheet" href="../../216dark.css?67c636a2" media="screen and (prefers-color-scheme:dark)"><style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}
.immersive-translate-attach-loading::after {
  content: " ";

  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;

  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-2000%, -50%);
  z-index: 100;
}

.immersive-translate-loading-spinner {
  vertical-align: middle !important;
  width: 10px !important;
  height: 10px !important;
  display: inline-block !important;
  margin: 0 4px !important;
  border: 2px rgba(221, 244, 255, 0.6) solid !important;
  border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-radius: 50% !important;
  padding: 0 !important;
  -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
  animation: immersive-translate-loading-animation 0.6s infinite linear !important;
}

@-webkit-keyframes immersive-translate-loading-animation {
  from {
    -webkit-transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(359deg);
  }
}

@keyframes immersive-translate-loading-animation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
      100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
      110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
      120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}

.immersive-translate-toast {
  display: flex;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  right: 0;
  top: 1%;
  width: fit-content;
  padding: 12px 20px;
  margin: auto;
  overflow: auto;
  background: #fef6f9;
  box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
  font-size: 15px;
  border-radius: 8px;
  color: #333;
}

.immersive-translate-toast-content {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.immersive-translate-toast-hidden {
  margin: 0 20px 0 72px;
  text-decoration: underline;
  cursor: pointer;
}

.immersive-translate-toast-close {
  color: #666666;
  font-size: 20px;
  font-weight: bold;
  padding: 0 10px;
  cursor: pointer;
}

@media screen and (max-width: 768px) {
  .immersive-translate-toast {
    top: 0;
    padding: 12px 0px 0 10px;
  }
  .immersive-translate-toast-content {
    flex-direction: column;
    text-align: center;
  }
  .immersive-translate-toast-hidden {
    margin: 10px auto;
  }
}

.immersive-translate-dialog {
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  display: flex;
  width: 300px;
  flex-direction: column;
  align-items: center;
  font-size: 15px;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  margin: auto;
  height: fit-content;
  border-radius: 20px;
  background-color: #fff;
}

.immersive-translate-modal {
  display: none;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0, 0, 0);
  background-color: rgba(0, 0, 0, 0.4);
  font-size: 15px;
}

.immersive-translate-modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 40px 24px 24px;
  border-radius: 12px;
  width: 350px;
  font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
    "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
    "Segoe UI Symbol", "Noto Color Emoji";
  position: relative;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-content {
    margin: 25% auto !important;
  }
}

@media screen and (max-width: 480px) {
  .immersive-translate-modal-content {
    width: 80vw !important;
    margin: 20vh auto !important;
    padding: 20px 12px 12px !important;
  }

  .immersive-translate-modal-title {
    font-size: 14px !important;
  }

  .immersive-translate-modal-body {
    font-size: 13px !important;
    max-height: 60vh !important;
  }

  .immersive-translate-btn {
    font-size: 13px !important;
    padding: 8px 16px !important;
    margin: 0 4px !important;
  }

  .immersive-translate-modal-footer {
    gap: 6px !important;
    margin-top: 16px !important;
  }
}

.immersive-translate-modal .immersive-translate-modal-content-in-input {
  max-width: 500px;
}
.immersive-translate-modal-content-in-input .immersive-translate-modal-body {
  text-align: left;
  max-height: unset;
}

.immersive-translate-modal-title {
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #333333;
}

.immersive-translate-modal-body {
  text-align: center;
  font-size: 14px;
  font-weight: 400;
  color: #333333;
  margin-top: 24px;
  word-break: break-all;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-body {
    max-height: 250px;
    overflow-y: auto;
  }
}

.immersive-translate-close {
  color: #666666;
  position: absolute;
  right: 16px;
  top: 16px;
  font-size: 20px;
  font-weight: bold;
}

.immersive-translate-close:hover,
.immersive-translate-close:focus {
  text-decoration: none;
  cursor: pointer;
}

.immersive-translate-modal-footer {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 24px;
}

.immersive-translate-btn {
  width: fit-content;
  color: #fff;
  background-color: #ea4c89;
  border: none;
  font-size: 14px;
  margin: 0 8px;
  padding: 9px 30px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.immersive-translate-btn-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.immersive-translate-btn:hover {
  background-color: #f082ac;
}
.immersive-translate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.immersive-translate-btn:disabled:hover {
  background-color: #ea4c89;
}

.immersive-translate-link-btn {
  background-color: transparent;
  color: #ea4c89;
  border: none;
  cursor: pointer;
  height: 30px;
  line-height: 30px;
}

.immersive-translate-cancel-btn {
  /* gray color */
  background-color: rgb(89, 107, 120);
}

.immersive-translate-cancel-btn:hover {
  background-color: hsl(205, 20%, 32%);
}

.immersive-translate-action-btn {
  background-color: transparent;
  color: #ea4c89;
  border: 1px solid #ea4c89;
}

.immersive-translate-btn svg {
  margin-right: 5px;
}

.immersive-translate-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-primary-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-modal input[type="radio"] {
  margin: 0 6px;
  cursor: pointer;
}

.immersive-translate-modal label {
  cursor: pointer;
}

.immersive-translate-close-action {
  position: absolute;
  top: 2px;
  right: 0px;
  cursor: pointer;
}

.imt-image-status {
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 16px !important;
}
.imt-image-status img,
.imt-image-status svg,
.imt-img-loading {
  width: 28px !important;
  height: 28px !important;
  margin: 0 0 8px 0 !important;
  min-height: 28px !important;
  min-width: 28px !important;
  position: relative !important;
}
.imt-img-loading {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
  background-size: 28px 28px;
  animation: image-loading-rotate 1s linear infinite !important;
}

.imt-image-status span {
  color: var(--bg-2, #fff) !important;
  font-size: 14px !important;
  line-height: 14px !important;
  font-weight: 500 !important;
  font-family: "PingFang SC", Arial, sans-serif !important;
}

.imt-primary-button {
  display: flex;
  padding: 12px 80px;
  justify-content: center;
  align-items: center;
  gap: 8px;
  border-radius: 8px;
  background: #ea4c89;
  color: #fff;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
  line-height: 24px;
  border: none;
  cursor: pointer;
}

.imt-retry-text {
  color: #999;
  text-align: center;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 21px;
  cursor: pointer;
}

.imt-action-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.imt-modal-content-text {
  text-align: left;
  color: #333;
  font-size: 16px;
  font-weight: 400;
  line-height: 24px;
}

@keyframes image-loading-rotate {
  from {
    transform: rotate(360deg);
  }
  to {
    transform: rotate(0deg);
  }
}

.imt-linear-gradient-text {
  background: linear-gradient(90deg, #00a6ff 0%, #c369ff 52.4%, #ff4590 100%);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.imt-flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.imt-linear-black-btn {
  border-radius: 50px;
  background: linear-gradient(66deg, #222 19%, #696969 94.25%);
  height: 48px;
  width: 100%;
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  cursor: pointer;
  justify-content: center;
}
</style><style>pre { white-space: pre-wrap; }* { font-size: 100%; font-family: monospace; }</style><style>* { font-size: 100%; font-family: monospace; background: rgb(255, 255, 255); color: rgb(0, 0, 51); }pre { white-space: pre-wrap; }a:link { color: rgb(0, 0, 255); text-decoration: none; }a:visited { color: rgb(136, 0, 136); }.q { color: rgb(0, 0, 102); }.add { color: rgb(0, 102, 0); }.del { color: rgb(153, 0, 0); }.head { color: rgb(0, 0, 0); }.hunk { color: rgb(153, 102, 0); }.hl.num { color: rgb(255, 51, 0); }.hl.esc { color: rgb(255, 0, 255); }.hl.str { color: rgb(255, 51, 0); }.hl.ppc { color: rgb(204, 51, 204); }.hl.pps { color: rgb(255, 51, 0); }.hl.slc { color: rgb(0, 153, 153); }.hl.com { color: rgb(0, 153, 153); }.hl.kwa { color: rgb(255, 153, 0); }.hl.kwb { color: rgb(0, 102, 0); }.hl.kwc { color: rgb(255, 153, 0); }</style><style>* { font-size: 100%; font-family: monospace; background: rgb(0, 0, 0); color: rgb(204, 204, 204); }pre { white-space: pre-wrap; }a:link { color: rgb(102, 153, 255); text-decoration: none; }a:visited { color: rgb(153, 102, 255); }.q { color: rgb(0, 153, 255); }.add { color: rgb(0, 255, 255); }.del { color: rgb(255, 0, 255); }.head { color: rgb(255, 255, 255); }.hunk { color: rgb(204, 153, 51); }.hl.num { color: rgb(255, 51, 0); }.hl.esc { color: rgb(255, 0, 255); }.hl.str { color: rgb(255, 51, 0); }.hl.ppc { color: rgb(255, 0, 255); }.hl.pps { color: rgb(255, 51, 0); }.hl.slc { color: rgb(0, 153, 255); }.hl.com { color: rgb(0, 153, 255); }.hl.kwa { color: rgb(255, 255, 0); }.hl.kwb { color: rgb(0, 255, 0); }.hl.kwc { color: rgb(255, 255, 0); }</style></head><body><form action="../../"><pre><a href="../../?t=20251119040816"><b>kvm-riscv.lists.infradead.org archive mirror</b></a>
<input name="q" type="text"><input type="submit" value="search"> <a href="../../_/text/help/">help</a> / <a href="../../_/text/color/">color</a> / <a id="mirror" href="../../_/text/mirror/">mirror</a> / <a href="../../new.atom">Atom feed</a></pre></form><pre><a href="#ed7c24e5117a4488ab92111916a2337d321e5b476" id="md7c24e5117a4488ab92111916a2337d321e5b476">*</a> <b>[PATCH v4] RISC-V: KVM: Flush VS-stage TLB after VCPU migration for split two-stage TLBs</b>
<b>@ 2025-11-17  8:45 Hui Min Mina Chou</b>
  2025-11-19  4:07 ` <a href="#m6a6e3759900c04d44bc84cda4fa26e29163ed535">Nutty.Liu</a>
  <a href="#rd7c24e5117a4488ab92111916a2337d321e5b476">0 siblings, 1 reply; 2+ messages in thread</a>
From: Hui Min Mina Chou @ 2025-11-17  8:45 UTC (<a href="../../20251117084555.157642-1-minachou@andestech.com/">permalink</a> / <a href="../../20251117084555.157642-1-minachou@andestech.com/raw">raw</a>)
  To: anup, atish.patra, pjw, palmer, aou, alex
  Cc: <a href="../../../kvm/?t=20251117084918">kvm</a>, <a href="../../../kvm-riscv/?t=20251117084918">kvm-riscv</a>, <a href="../../../linux-riscv/?t=20251117084918">linux-riscv</a>, <a href="../../../lkml/?t=20251117084918">linux-kernel</a>, tim609, minachou,
	ben717, az70021, Radim Krčmář

Most implementations cache the combined result of two-stage
translation, but some, like Andes cores, use split TLBs that
store VS-stage and G-stage entries separately.

On such systems, when a VCPU migrates to another CPU, an additional
HFENCE.VVMA is required to avoid using stale VS-stage entries, which
could otherwise cause guest faults.

Introduce a static key to identify CPUs with split two-stage TLBs.
When enabled, KVM issues an extra HFENCE.VVMA on VCPU migration to
prevent stale VS-stage mappings.

Signed-off-by: Hui Min Mina Chou &lt;minachou@andestech.com&gt;
Signed-off-by: Ben Zong-You Xie &lt;ben717@andestech.com&gt;
Reviewed-by: Radim Krčmář &lt;rkrcmar@ventanamicro.com&gt;
---
Changelog:

v4:
 - Rename the patch subject
 - Remove the Fixes tag
 - Add a static key so that HFENCE.VVMA is issued only on CPUs with
   split two-stage TLBs
 - Add kvm_riscv_setup_vendor_features() to detect mvendorid/marchid
   and enable the key when required

v3:
 - Resolved build warning; updated header declaration and call side to
   kvm_riscv_local_tlb_sanitize
 - Add Radim Krčmář's Reviewed-by tag
 (<a href="https://lore.kernel.org/all/20251023032517.2527193-1-minachou@andestech.com/">https://lore.kernel.org/all/20251023032517.2527193-1-minachou@andestech.com/</a>)

v2:
 - Updated Fixes commit to 92e450507d56
 - Renamed function to kvm_riscv_local_tlb_sanitize
 (<a href="https://lore.kernel.org/all/20251021083105.4029305-1-minachou@andestech.com/">https://lore.kernel.org/all/20251021083105.4029305-1-minachou@andestech.com/</a>)
---
 <a id="iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_host.h" href="#Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_host.h">arch/riscv/include/asm/kvm_host.h</a> |  2 ++
 <a id="iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_vmid.h" href="#Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_vmid.h">arch/riscv/include/asm/kvm_vmid.h</a> |  2 +-
 <a id="iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:main.c" href="#Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:main.c">arch/riscv/kvm/main.c</a>             | 14 ++++++++++++++
 <a id="iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vcpu.c" href="#Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vcpu.c">arch/riscv/kvm/vcpu.c</a>             |  2 +-
 <a id="iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vmid.c" href="#Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vmid.c">arch/riscv/kvm/vmid.c</a>             |  6 +++++-
 5 files <a href="#ed7c24e5117a4488ab92111916a2337d321e5b476">changed</a>, 23 insertions(+), 3 deletions(-)

<span class="head"><a href="#iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_host.h" id="Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_host.h">diff</a> --git a/arch/riscv/include/asm/kvm_host.h b/arch/riscv/include/asm/kvm_host.h
index d71d3299a335..21abac2f804e 100644
--- a/arch/riscv/include/asm/kvm_host.h
+++ b/arch/riscv/include/asm/kvm_host.h
</span><span class="hunk">@@ -323,4 +323,6 @@ bool kvm_riscv_vcpu_stopped(struct kvm_vcpu *vcpu);
</span> 
 void kvm_riscv_vcpu_record_steal_time(struct kvm_vcpu *vcpu);
 
<span class="add">+DECLARE_STATIC_KEY_FALSE(kvm_riscv_tlb_split_mode);
+
</span> #endif /* __RISCV_KVM_HOST_H__ */
<span class="head"><a href="#iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_vmid.h" id="Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:include:asm:kvm_vmid.h">diff</a> --git a/arch/riscv/include/asm/kvm_vmid.h b/arch/riscv/include/asm/kvm_vmid.h
index ab98e1434fb7..75fb6e872ccd 100644
--- a/arch/riscv/include/asm/kvm_vmid.h
+++ b/arch/riscv/include/asm/kvm_vmid.h
</span><span class="hunk">@@ -22,6 +22,6 @@ unsigned long kvm_riscv_gstage_vmid_bits(void);
</span> int kvm_riscv_gstage_vmid_init(struct kvm *kvm);
 bool kvm_riscv_gstage_vmid_ver_changed(struct kvm_vmid *vmid);
 void kvm_riscv_gstage_vmid_update(struct kvm_vcpu *vcpu);
<span class="del">-void kvm_riscv_gstage_vmid_sanitize(struct kvm_vcpu *vcpu);
</span><span class="add">+void kvm_riscv_local_tlb_sanitize(struct kvm_vcpu *vcpu);
</span> 
 #endif
<span class="head"><a href="#iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:main.c" id="Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:main.c">diff</a> --git a/arch/riscv/kvm/main.c b/arch/riscv/kvm/main.c
index 67c876de74ef..bf0e4f1abe0f 100644
--- a/arch/riscv/kvm/main.c
+++ b/arch/riscv/kvm/main.c
</span><span class="hunk">@@ -15,6 +15,18 @@
</span> #include &lt;asm/kvm_nacl.h&gt;
 #include &lt;asm/sbi.h&gt;
 
<span class="add">+DEFINE_STATIC_KEY_FALSE(kvm_riscv_tlb_split_mode);
+
+static void kvm_riscv_setup_vendor_features(void)
+{
+	/* Andes AX66: split two-stage TLBs */
+	if (riscv_cached_mvendorid(0) == ANDES_VENDOR_ID &amp;&amp;
+	    (riscv_cached_marchid(0) &amp; 0xFFFF) == 0x8A66) {
+		static_branch_enable(&amp;kvm_riscv_tlb_split_mode);
+		kvm_info("using split two-stage TLBs requiring extra HFENCE.VVMA
");
+	}
+}
+
</span> long kvm_arch_dev_ioctl(struct file *filp,
 			unsigned int ioctl, unsigned long arg)
 {
<span class="hunk">@@ -159,6 +171,8 @@ static int __init riscv_kvm_init(void)
</span> 		kvm_info("AIA available with %d guest external interrupts
",
 			 kvm_riscv_aia_nr_hgei);
 
<span class="add">+	kvm_riscv_setup_vendor_features();
+
</span> 	kvm_register_perf_callbacks(NULL);
 
 	rc = kvm_init(sizeof(struct kvm_vcpu), 0, THIS_MODULE);
<span class="head"><a href="#iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vcpu.c" id="Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vcpu.c">diff</a> --git a/arch/riscv/kvm/vcpu.c b/arch/riscv/kvm/vcpu.c
index 3ebcfffaa978..796218e4a462 100644
--- a/arch/riscv/kvm/vcpu.c
+++ b/arch/riscv/kvm/vcpu.c
</span><span class="hunk">@@ -968,7 +968,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)
</span> 		 * Note: This should be done after G-stage VMID has been
 		 * updated using kvm_riscv_gstage_vmid_ver_changed()
 		 */
<span class="del">-		kvm_riscv_gstage_vmid_sanitize(vcpu);
</span><span class="add">+		kvm_riscv_local_tlb_sanitize(vcpu);
</span> 
 		trace_kvm_entry(vcpu);
 
<span class="head"><a href="#iZ2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vmid.c" id="Z2e.:..:20251117084555.157642-1-minachou::40andestech.com:1arch:riscv:kvm:vmid.c">diff</a> --git a/arch/riscv/kvm/vmid.c b/arch/riscv/kvm/vmid.c
index 3b426c800480..1dbd50c67a88 100644
--- a/arch/riscv/kvm/vmid.c
+++ b/arch/riscv/kvm/vmid.c
</span><span class="hunk">@@ -125,7 +125,7 @@ void kvm_riscv_gstage_vmid_update(struct kvm_vcpu *vcpu)
</span> 		kvm_make_request(KVM_REQ_UPDATE_HGATP, v);
 }
 
<span class="del">-void kvm_riscv_gstage_vmid_sanitize(struct kvm_vcpu *vcpu)
</span><span class="add">+void kvm_riscv_local_tlb_sanitize(struct kvm_vcpu *vcpu)
</span> {
 	unsigned long vmid;
 
<span class="hunk">@@ -146,4 +146,8 @@ void kvm_riscv_gstage_vmid_sanitize(struct kvm_vcpu *vcpu)
</span> 
 	vmid = READ_ONCE(vcpu-&gt;kvm-&gt;arch.vmid.vmid);
 	kvm_riscv_local_hfence_gvma_vmid_all(vmid);
<span class="add">+
+	/* For split TLB designs, flush VS-stage entries also */
+	if (static_branch_unlikely(&amp;kvm_riscv_tlb_split_mode))
+		kvm_riscv_local_hfence_vvma_all(vmid);
</span> }
-- 
2.34.1


-- 
kvm-riscv mailing list
kvm-riscv@lists.infradead.org
<a href="http://lists.infradead.org/mailman/listinfo/kvm-riscv">http://lists.infradead.org/mailman/listinfo/kvm-riscv</a>

<a href="#md7c24e5117a4488ab92111916a2337d321e5b476" id="ed7c24e5117a4488ab92111916a2337d321e5b476">^</a> <a href="../../20251117084555.157642-1-minachou@andestech.com/">permalink</a> <a href="../../20251117084555.157642-1-minachou@andestech.com/raw">raw</a> <a href="../../20251117084555.157642-1-minachou@andestech.com/#R">reply</a> <a href="../../20251117084555.157642-1-minachou@andestech.com/#related">related</a>	[<a href="../../20251117084555.157642-1-minachou@andestech.com/T/#u"><b>flat</b></a>|<a href="../../20251117084555.157642-1-minachou@andestech.com/t/#u">nested</a>] <a href="#rd7c24e5117a4488ab92111916a2337d321e5b476">2+ messages in thread</a></pre><hr><pre><a href="#e6a6e3759900c04d44bc84cda4fa26e29163ed535" id="m6a6e3759900c04d44bc84cda4fa26e29163ed535">*</a> <u id="u"><b>Re: [PATCH v4] RISC-V: KVM: Flush VS-stage TLB after VCPU migration for split two-stage TLBs</b></u>
  2025-11-17  8:45 <a href="#md7c24e5117a4488ab92111916a2337d321e5b476">[PATCH v4] RISC-V: KVM: Flush VS-stage TLB after VCPU migration for split two-stage TLBs</a> Hui Min Mina Chou
<b>@ 2025-11-19  4:07 ` Nutty.Liu</b>
  <a href="#r6a6e3759900c04d44bc84cda4fa26e29163ed535">0 siblings, 0 replies; 2+ messages in thread</a>
From: Nutty.Liu @ 2025-11-19  4:07 UTC (<a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/">permalink</a> / <a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/raw">raw</a>)
  To: Hui Min Mina Chou, anup, atish.patra, pjw, palmer, aou, alex
  Cc: <a href="../../../kvm/?t=20251119040816">kvm</a>, <a href="../../../kvm-riscv/?t=20251119040816">kvm-riscv</a>, <a href="../../../linux-riscv/?t=20251119040816">linux-riscv</a>, <a href="../../../lkml/?t=20251119040816">linux-kernel</a>, tim609, ben717,
	az70021, Radim Krčmář

On 11/17/2025 4:45 PM, Hui Min Mina Chou wrote:
<span class="q">&gt; Most implementations cache the combined result of two-stage
&gt; translation, but some, like Andes cores, use split TLBs that
&gt; store VS-stage and G-stage entries separately.
&gt;
&gt; On such systems, when a VCPU migrates to another CPU, an additional
&gt; HFENCE.VVMA is required to avoid using stale VS-stage entries, which
&gt; could otherwise cause guest faults.
&gt;
&gt; Introduce a static key to identify CPUs with split two-stage TLBs.
&gt; When enabled, KVM issues an extra HFENCE.VVMA on VCPU migration to
&gt; prevent stale VS-stage mappings.
&gt;
&gt; Signed-off-by: Hui Min Mina Chou &lt;minachou@andestech.com&gt;
&gt; Signed-off-by: Ben Zong-You Xie &lt;ben717@andestech.com&gt;
&gt; Reviewed-by: Radim Krčmář &lt;rkrcmar@ventanamicro.com&gt;
&gt; ---
&gt; Changelog:
&gt;
&gt; v4:
&gt;   - Rename the patch subject
&gt;   - Remove the Fixes tag
&gt;   - Add a static key so that HFENCE.VVMA is issued only on CPUs with
&gt;     split two-stage TLBs
&gt;   - Add kvm_riscv_setup_vendor_features() to detect mvendorid/marchid
&gt;     and enable the key when required
&gt;
&gt; v3:
&gt;   - Resolved build warning; updated header declaration and call side to
&gt;     kvm_riscv_local_tlb_sanitize
&gt;   - Add Radim Krčmář's Reviewed-by tag
&gt;   (<a href="https://lore.kernel.org/all/20251023032517.2527193-1-minachou@andestech.com/">https://lore.kernel.org/all/20251023032517.2527193-1-minachou@andestech.com/</a>)
&gt;
&gt; v2:
&gt;   - Updated Fixes commit to 92e450507d56
&gt;   - Renamed function to kvm_riscv_local_tlb_sanitize
&gt;   (<a href="https://lore.kernel.org/all/20251021083105.4029305-1-minachou@andestech.com/">https://lore.kernel.org/all/20251021083105.4029305-1-minachou@andestech.com/</a>)
&gt; ---
&gt;   arch/riscv/include/asm/kvm_host.h |  2 ++
&gt;   arch/riscv/include/asm/kvm_vmid.h |  2 +-
&gt;   arch/riscv/kvm/main.c             | 14 ++++++++++++++
&gt;   arch/riscv/kvm/vcpu.c             |  2 +-
&gt;   arch/riscv/kvm/vmid.c             |  6 +++++-
&gt;   5 files changed, 23 insertions(+), 3 deletions(-)
&gt;
&gt; diff --git a/arch/riscv/include/asm/kvm_host.h b/arch/riscv/include/asm/kvm_host.h
&gt; index d71d3299a335..21abac2f804e 100644
&gt; --- a/arch/riscv/include/asm/kvm_host.h
&gt; +++ b/arch/riscv/include/asm/kvm_host.h
&gt; @@ -323,4 +323,6 @@ bool kvm_riscv_vcpu_stopped(struct kvm_vcpu *vcpu);
&gt;   
&gt;   void kvm_riscv_vcpu_record_steal_time(struct kvm_vcpu *vcpu);
&gt;   
&gt; +DECLARE_STATIC_KEY_FALSE(kvm_riscv_tlb_split_mode);
&gt; +
&gt;   #endif /* __RISCV_KVM_HOST_H__ */
&gt; diff --git a/arch/riscv/include/asm/kvm_vmid.h b/arch/riscv/include/asm/kvm_vmid.h
&gt; index ab98e1434fb7..75fb6e872ccd 100644
&gt; --- a/arch/riscv/include/asm/kvm_vmid.h
&gt; +++ b/arch/riscv/include/asm/kvm_vmid.h
&gt; @@ -22,6 +22,6 @@ unsigned long kvm_riscv_gstage_vmid_bits(void);
&gt;   int kvm_riscv_gstage_vmid_init(struct kvm *kvm);
&gt;   bool kvm_riscv_gstage_vmid_ver_changed(struct kvm_vmid *vmid);
&gt;   void kvm_riscv_gstage_vmid_update(struct kvm_vcpu *vcpu);
&gt; -void kvm_riscv_gstage_vmid_sanitize(struct kvm_vcpu *vcpu);
&gt; +void kvm_riscv_local_tlb_sanitize(struct kvm_vcpu *vcpu);
&gt;   
&gt;   #endif
&gt; diff --git a/arch/riscv/kvm/main.c b/arch/riscv/kvm/main.c
&gt; index 67c876de74ef..bf0e4f1abe0f 100644
&gt; --- a/arch/riscv/kvm/main.c
&gt; +++ b/arch/riscv/kvm/main.c
&gt; @@ -15,6 +15,18 @@
&gt;   #include &lt;asm/kvm_nacl.h&gt;
&gt;   #include &lt;asm/sbi.h&gt;
&gt;   
&gt; +DEFINE_STATIC_KEY_FALSE(kvm_riscv_tlb_split_mode);
&gt; +
&gt; +static void kvm_riscv_setup_vendor_features(void)
&gt; +{
&gt; +	/* Andes AX66: split two-stage TLBs */
&gt; +	if (riscv_cached_mvendorid(0) == ANDES_VENDOR_ID &amp;&amp;
&gt; +	    (riscv_cached_marchid(0) &amp; 0xFFFF) == 0x8A66) {
</span>How about to define a macro like 'ANDES_ARCH_ID' instead of '0x8A66' 
(like 'ANDES_VENDOR_ID') ?

Otherwise,
Reviewed-by: Nutty Liu &lt;nutty.liu@hotmail.com&gt;

Thanks,
Nutty
<span class="q">&gt; +		static_branch_enable(&amp;kvm_riscv_tlb_split_mode);
&gt; +		kvm_info("using split two-stage TLBs requiring extra HFENCE.VVMA
");
&gt; +	}
&gt; +}
&gt; +
&gt;   long kvm_arch_dev_ioctl(struct file *filp,
&gt;   			unsigned int ioctl, unsigned long arg)
&gt;   {
&gt; @@ -159,6 +171,8 @@ static int __init riscv_kvm_init(void)
&gt;   		kvm_info("AIA available with %d guest external interrupts
",
&gt;   			 kvm_riscv_aia_nr_hgei);
&gt;   
&gt; +	kvm_riscv_setup_vendor_features();
&gt; +
&gt;   	kvm_register_perf_callbacks(NULL);
&gt;   
&gt;   	rc = kvm_init(sizeof(struct kvm_vcpu), 0, THIS_MODULE);
&gt; diff --git a/arch/riscv/kvm/vcpu.c b/arch/riscv/kvm/vcpu.c
&gt; index 3ebcfffaa978..796218e4a462 100644
&gt; --- a/arch/riscv/kvm/vcpu.c
&gt; +++ b/arch/riscv/kvm/vcpu.c
&gt; @@ -968,7 +968,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)
&gt;   		 * Note: This should be done after G-stage VMID has been
&gt;   		 * updated using kvm_riscv_gstage_vmid_ver_changed()
&gt;   		 */
&gt; -		kvm_riscv_gstage_vmid_sanitize(vcpu);
&gt; +		kvm_riscv_local_tlb_sanitize(vcpu);
&gt;   
&gt;   		trace_kvm_entry(vcpu);
&gt;   
&gt; diff --git a/arch/riscv/kvm/vmid.c b/arch/riscv/kvm/vmid.c
&gt; index 3b426c800480..1dbd50c67a88 100644
&gt; --- a/arch/riscv/kvm/vmid.c
&gt; +++ b/arch/riscv/kvm/vmid.c
&gt; @@ -125,7 +125,7 @@ void kvm_riscv_gstage_vmid_update(struct kvm_vcpu *vcpu)
&gt;   		kvm_make_request(KVM_REQ_UPDATE_HGATP, v);
&gt;   }
&gt;   
&gt; -void kvm_riscv_gstage_vmid_sanitize(struct kvm_vcpu *vcpu)
&gt; +void kvm_riscv_local_tlb_sanitize(struct kvm_vcpu *vcpu)
&gt;   {
&gt;   	unsigned long vmid;
&gt;   
&gt; @@ -146,4 +146,8 @@ void kvm_riscv_gstage_vmid_sanitize(struct kvm_vcpu *vcpu)
&gt;   
&gt;   	vmid = READ_ONCE(vcpu-&gt;kvm-&gt;arch.vmid.vmid);
&gt;   	kvm_riscv_local_hfence_gvma_vmid_all(vmid);
&gt; +
&gt; +	/* For split TLB designs, flush VS-stage entries also */
&gt; +	if (static_branch_unlikely(&amp;kvm_riscv_tlb_split_mode))
&gt; +		kvm_riscv_local_hfence_vvma_all(vmid);
&gt;   }
</span>
-- 
kvm-riscv mailing list
kvm-riscv@lists.infradead.org
<a href="http://lists.infradead.org/mailman/listinfo/kvm-riscv">http://lists.infradead.org/mailman/listinfo/kvm-riscv</a>

<a href="#m6a6e3759900c04d44bc84cda4fa26e29163ed535" id="e6a6e3759900c04d44bc84cda4fa26e29163ed535">^</a> <a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/">permalink</a> <a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/raw">raw</a> <a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/#R">reply</a>	[<a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/T/#u"><b>flat</b></a>|<a href="../../KUZPR04MB9265F5F027802D0C0C7F429CF3D7A@KUZPR04MB9265.apcprd04.prod.outlook.com/t/#u">nested</a>] <a href="#r6a6e3759900c04d44bc84cda4fa26e29163ed535">2+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a href="../../?t=20251119040816">~2025-11-19  4:08 UTC</a> | <a href="../../">newest</a>]

<b id="t">Thread overview:</b> 2+ messages (download: <a href="../t.mbox.gz">mbox.gz</a> follow: <a href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
2025-11-17  8:45 <a href="#md7c24e5117a4488ab92111916a2337d321e5b476" id="rd7c24e5117a4488ab92111916a2337d321e5b476">[PATCH v4] RISC-V: KVM: Flush VS-stage TLB after VCPU migration for split two-stage TLBs</a> Hui Min Mina Chou
2025-11-19  4:07 ` <a href="#m6a6e3759900c04d44bc84cda4fa26e29163ed535" id="r6a6e3759900c04d44bc84cda4fa26e29163ed535">Nutty.Liu</a>
</pre><hr><pre>This is a public inbox, see <a href="../../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body><div style="all: initial;"><div style="all: initial;" id="__hcfy__"></div></div><div id="immersive-translate-popup" style="all: initial"></div></html>