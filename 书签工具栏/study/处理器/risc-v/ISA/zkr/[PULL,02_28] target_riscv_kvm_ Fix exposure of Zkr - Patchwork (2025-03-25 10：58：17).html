<!-- Filename: 书签工具栏/study/处理器/risc-v/ISA/zkr/[PULL,02_28] target_riscv_kvm_ Fix exposure of Zkr - Patchwork (2025-03-25 10：58：17).html
 Page saved with X-Webpage-Conserve 
 url: https://patchwork.kernel.org/project/qemu-devel/patch/20240528024328.246965-3-alistair.francis@wdc.com/
 Summary: This text is a diff output showing changes made to the RISC-V QEMU emulator code. The changes include adding a new function `riscv_new_csr_seed()` to create a new value for the SEED CSR, and updating the `rmw_seed()` function to use this new function instead of generating a random value directly. The changes also include adding a new case `KVM_EXIT_RISCV_CSR` to the `kvm_arch_handle_exit()` function to handle the CSR EXIT reason.此文本是一个差异输出，显示了对 RISC-V QEMU 仿真器代码所做的更改。这些更改包括添加新函数 'riscv_new_csr_seed（）' 为 SEED CSR 创建新值，以及更新 'rmw_seed（）' 函数以使用此新函数，而不是直接生成随机值。这些更改还包括向 'kvm_arch_handle_exit（）' 函数添加新的 case 'KVM_EXIT_RISCV_CSR' 来处理 CSR EXIT 原因。
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" imt-state="dual"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>[PULL,02/28] target/riscv/kvm: Fix exposure of Zkr - Patchwork</title>
  <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.1999ae14de69.css">
  <link rel="stylesheet" type="text/css" href="/static/css/selectize.bootstrap3.5d3fb8271165.css">
  <link rel="stylesheet" type="text/css" href="/static/css/style.2951ca37f12e.css">
  <script src="/static/js/jquery-1.10.1.min.33d85132f015.js"></script>
  <script src="/static/js/jquery.stickytableheaders.min.f7c636d6c766.js"></script>
  <script src="/static/js/jquery.checkboxes-1.0.6.min.cfa3c7bf5d41.js"></script>
  <!-- IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js">
    </script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.0.8/es5-shim.min.js"></script>
  <![endif]-->
  <script src="/static/js/bootstrap.min.abda843684d0.js"></script>
  <script src="/static/js/selectize.min.7cdaf5b36b90.js"></script>
  <script src="/static/js/clipboard.min.3e5e0fa949e0.js"></script>
  <script>
   $(document).ready(function() {
       new Clipboard(document.querySelectorAll('button.btn-copy'));
   });
  </script>

 <style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}
.immersive-translate-attach-loading::after {
  content: " ";

  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;

  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-2000%, -50%);
  z-index: 100;
}

.immersive-translate-loading-spinner {
  vertical-align: middle !important;
  width: 10px !important;
  height: 10px !important;
  display: inline-block !important;
  margin: 0 4px !important;
  border: 2px rgba(221, 244, 255, 0.6) solid !important;
  border-top: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-left: 2px rgba(0, 0, 0, 0.375) solid !important;
  border-radius: 50% !important;
  padding: 0 !important;
  -webkit-animation: immersive-translate-loading-animation 0.6s infinite linear !important;
  animation: immersive-translate-loading-animation 0.6s infinite linear !important;
}

@-webkit-keyframes immersive-translate-loading-animation {
  from {
    -webkit-transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(359deg);
  }
}

@keyframes immersive-translate-loading-animation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color),
      0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color),
      100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color),
      110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color),
      120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
      200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}

.immersive-translate-toast {
  display: flex;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  right: 0;
  top: 1%;
  width: fit-content;
  padding: 12px 20px;
  margin: auto;
  overflow: auto;
  background: #fef6f9;
  box-shadow: 0px 4px 10px 0px rgba(0, 10, 30, 0.06);
  font-size: 15px;
  border-radius: 8px;
  color: #333;
}

.immersive-translate-toast-content {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.immersive-translate-toast-hidden {
  margin: 0 20px 0 72px;
  text-decoration: underline;
  cursor: pointer;
}

.immersive-translate-toast-close {
  color: #666666;
  font-size: 20px;
  font-weight: bold;
  padding: 0 10px;
  cursor: pointer;
}

@media screen and (max-width: 768px) {
  .immersive-translate-toast {
    top: 0;
    padding: 12px 0px 0 10px;
  }
  .immersive-translate-toast-content {
    flex-direction: column;
    text-align: center;
  }
  .immersive-translate-toast-hidden {
    margin: 10px auto;
  }
}

.immersive-translate-modal {
  display: none;
  position: fixed;
  z-index: 2147483647;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0, 0, 0);
  background-color: rgba(0, 0, 0, 0.4);
  font-size: 15px;
}

.immersive-translate-modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 40px 24px 24px;
  border: 1px solid #888;
  border-radius: 10px;
  width: 80%;
  max-width: 270px;
  font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Ubuntu",
    "Cantarell", "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
    "Segoe UI Symbol", "Noto Color Emoji";
  position: relative;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-content {
    margin: 50% auto !important;
  }
}

.immersive-translate-modal .immersive-translate-modal-content-in-input {
  max-width: 500px;
}
.immersive-translate-modal-content-in-input .immersive-translate-modal-body {
  text-align: left;
  max-height: unset;
}

.immersive-translate-modal-title {
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #333333;
}

.immersive-translate-modal-body {
  text-align: center;
  font-size: 14px;
  font-weight: 400;
  color: #333333;
  word-break: break-all;
  margin-top: 24px;
}

@media screen and (max-width: 768px) {
  .immersive-translate-modal-body {
    max-height: 250px;
    overflow-y: auto;
  }
}

.immersive-translate-close {
  color: #666666;
  position: absolute;
  right: 16px;
  top: 16px;
  font-size: 20px;
  font-weight: bold;
}

.immersive-translate-close:hover,
.immersive-translate-close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.immersive-translate-modal-footer {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 24px;
}

.immersive-translate-btn {
  width: fit-content;
  color: #fff;
  background-color: #ea4c89;
  border: none;
  font-size: 16px;
  margin: 0 8px;
  padding: 9px 30px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.immersive-translate-btn:hover {
  background-color: #f082ac;
}
.immersive-translate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.immersive-translate-btn:disabled:hover {
  background-color: #ea4c89;
}

.immersive-translate-cancel-btn {
  /* gray color */
  background-color: rgb(89, 107, 120);
}

.immersive-translate-cancel-btn:hover {
  background-color: hsl(205, 20%, 32%);
}

.immersive-translate-action-btn {
  background-color: transparent;
  color: #ea4c89;
  border: 1px solid #ea4c89;
}

.immersive-translate-btn svg {
  margin-right: 5px;
}

.immersive-translate-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #007bff;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-primary-link {
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  text-decoration: none;
  color: #ea4c89;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.immersive-translate-modal input[type="radio"] {
  margin: 0 6px;
  cursor: pointer;
}

.immersive-translate-modal label {
  cursor: pointer;
}

.immersive-translate-close-action {
  position: absolute;
  top: 2px;
  right: 0px;
  cursor: pointer;
}

.imt-image-status {
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 16px !important;
}
.imt-image-status img,
.imt-image-status svg,
.imt-img-loading {
  width: 28px !important;
  height: 28px !important;
  margin: 0 0 8px 0 !important;
  min-height: 28px !important;
  min-width: 28px !important;
  position: relative !important;
}
.imt-img-loading {
  background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4CAMAAACfWMssAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAPHRSTlMABBMIDyQXHwyBfFdDMSw+OjXCb+5RG51IvV/k0rOqlGRM6KKMhdvNyZBz9MaupmxpWyj437iYd/yJVNZeuUC7AAACt0lEQVRIx53T2XKiUBCA4QYOiyCbiAsuuGBcYtxiYtT3f6/pbqoYHVFO5r+iivpo6DpAWYpqeoFfr9f90DsYAuRSWkFnPO50OgR9PwiCUFcl2GEcx+N/YBh6pvKaefHlUgZd1zVe0NbYcQjGBfzrPE8Xz8aF+71D8gG6DHFPpc4a7xFiCDuhaWgKgGIJQ3d5IMGDrpS4S5KgpIm+en9f6PlAhKby4JwEIxlYJV9h5k5nee9GoxHJ2IDSNB0dwdad1NAxDJ/uXDHYmebdk4PdbkS58CIVHdYSUHTYYRWOJblWSyu2lmy3KNFVJNBhxcuGW4YBVCbYGRZwIooipHsNqjM4FbgOQqQqSKQQU9V8xmi1QlgHqQQ6DDBvRUVCDirs+EzGDGOQTCATgtYTnbCVLgsVgRE0T1QE0qHCFAht2z6dLvJQs3Lo2FQoDxWNUiBhaP4eRgwNkI+dAjVOA/kUrIDwf3CG8NfNOE0eiFotSuo+rBiq8tD9oY4Qzc6YJw99hl1wzpQvD7ef2M8QgnOGJfJw+EltQc+oX2yn907QB22WZcvlUpd143dqQu+8pCJZuGE4xCuPXJqqcs5sNpsI93Rmzym1k4Npk+oD1SH3/a3LOK/JpUBpWfqNySxWzCfNCUITuDG5dtuphrUJ1myeIE9bIsPiKrfqTai5WZxbhtNphYx6GEIHihyGFTI69lje/rxajdh0s0msZ0zYxyPLhYCb1CyHm9Qsd2H37Y3lugVwL9kNh8Ot8cha6fUNQ8nuXi5z9/ExsAO4zQrb/ev1yrCB7lGyQzgYDGuxq1toDN/JGvN+HyWNHKB7zEoK+PX11e12G431erGYzwmytAWU56fkMHY5JJnDRR2eZji3AwtIcrEV8Cojat/BdQ7XOwGV1e1hDjGGjXbdArm8uJZtCH5MbcctVX8A1WpqumJHwckAAAAASUVORK5CYII=");
  background-size: 28px 28px;
  animation: image-loading-rotate 1s linear infinite !important;
}

.imt-image-status span {
  color: var(--bg-2, #fff) !important;
  font-size: 14px !important;
  line-height: 14px !important;
  font-weight: 500 !important;
  font-family: "PingFang SC", Arial, sans-serif !important;
}

@keyframes image-loading-rotate {
  from {
    transform: rotate(360deg);
  }
  to {
    transform: rotate(0deg);
  }
}
</style>undefined</head>
 <body style="">
  <nav class="navbar navbar-inverse navbar-static-top">
   <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Patchwork</a>
      <span class="navbar-subbrand">
         QEMU patches
      </span>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapse">


      <ul class="nav navbar-nav">
        <li class="">
          <a href="/project/qemu-devel/list/">
            <span class="glyphicon glyphicon-file"></span>
            Patches
          </a>
        </li>
        <li class="">
          <a href="/project/qemu-devel/bundles/">
            <span class="glyphicon glyphicon-gift"></span>
            Bundles
          </a>
        </li>
        <li class="">
          <a href="/project/qemu-devel/">
            <span class="glyphicon glyphicon-info-sign"></span>
            About this project
          </a>
        </li>
      </ul>


     <ul class="nav navbar-nav navbar-right">

     <li><a href="/user/login/">Login</a></li>
     <li><a href="/register/">Register</a></li>
     <li><a href="/mail/">Mail settings</a></li>

     </ul>
    </div>
   </div>
  </nav>

  <div class="container-fluid">

<script>
function toggle_div(link_id, headers_id, label_show, label_hide)
{
    var link = document.getElementById(link_id)
    var headers = document.getElementById(headers_id)

    var hidden = headers.style['display'] == 'none';

    if (hidden) {
        link.innerHTML = label_hide || 'hide';
        headers.style['display'] = 'block';
    } else {
        link.innerHTML = label_show || 'show';
        headers.style['display'] = 'none';
    }

}
</script>

<div>
  <div class="btn-group pull-right">
  <button type="button" class="btn btn-default btn-copy" data-clipboard-text="13676011" title="Copy to Clipboard">
      13676011
  </button>
  
  <a href="/project/qemu-devel/patch/20240528024328.246965-3-alistair.francis@wdc.com/raw/" class="btn btn-default" role="button" title="Download patch diff">diff</a>
  <a href="/project/qemu-devel/patch/20240528024328.246965-3-alistair.francis@wdc.com/mbox/" class="btn btn-default" role="button" title="Download patch mbox">mbox</a>
  
  
  <a href="/series/856345/mbox/" class="btn btn-default" role="button" title="Download patch mbox with dependencies">series</a>
  
</div>

  <h1>[PULL,02/28] target/riscv/kvm: Fix exposure of Zkr</h1>
</div>

<table class="patchmeta">
 <tbody><tr>
  <th>Message ID</th>
  
  <td>20240528024328.246965-3-alistair.francis@wdc.com (<a href="https://lore.kernel.org/r/20240528024328.246965-3-alistair.francis@wdc.com">mailing list archive</a>)</td>
  
 </tr>

 <tr>
  <th>State</th>
  <td>New, archived</td>
 </tr>



 <tr>
  <th>Headers</th>
  <td><a id="togglepatchheaders" href="javascript:toggle_div('togglepatchheaders', 'patchheaders')">show</a>
   <div id="patchheaders" class="patchheaders" style="display:none;">
    <pre>Return-Path: &lt;qemu-devel-bounces+qemu-devel=archiver.kernel.org@nongnu.org&gt;
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.lore.kernel.org (Postfix) with ESMTPS id 60193C25B7C
	for &lt;qemu-devel@archiver.kernel.org&gt;; Tue, 28 May 2024 02:44:40 +0000 (UTC)
Received: from localhost ([::1] helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from &lt;qemu-devel-bounces@nongnu.org&gt;)
	id 1sBmox-0001zq-BG; Mon, 27 May 2024 22:44:16 -0400
Received: from eggs.gnu.org ([2001:470:142:3::10])
 by lists.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from &lt;alistair23@gmail.com&gt;)
 id 1sBmot-0001sZ-7Y; Mon, 27 May 2024 22:44:11 -0400
Received: from mail-pl1-x62a.google.com ([2607:f8b0:4864:20::62a])
 by eggs.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.90_1) (envelope-from &lt;alistair23@gmail.com&gt;)
 id 1sBmoq-0003hi-2R; Mon, 27 May 2024 22:44:10 -0400
Received: by mail-pl1-x62a.google.com with SMTP id
 d9443c01a7336-1f44b45d6abso2988435ad.0;
 Mon, 27 May 2024 19:44:06 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20230601; t=1716864245; x=1717469045; darn=nongnu.org;
 h=content-transfer-encoding:mime-version:references:in-reply-to
 :message-id:date:subject:cc:to:from:from:to:cc:subject:date
 :message-id:reply-to;
 bh=D8UK8uAVTnW82lBqc0PHDyOOwY4BUuAnWYWQniDrcpo=;
 b=gzpPVTkfDP3ENordFuovrv5fHn/u+q8WXGi1r4Om3mhuLVNZhPMnnUgmun+LKwJoEa
 7PeyvtiEU2JiAa9fkPWMiRluouI6+30RdAxBAsOyJS3Qd5LvkybuJDX1v4jaX9hqOhIc
 2rVXu3bDUk5T7gg5cfvijtGZHcCsZK4Mnu52dy9R6rzRKULVs0fSyJvKPpe4bziBDyoI
 Rs/Rbumx5PhTJ+AdwQu9fEqlfdf01ETC4gbMP2gSHYxyw0n0vBT7zfLW2IocnrHjgiDr
 qWAQ6EhzzqsfUiQgzcfruYhBlZqQ1qpRb6j3Xq/Acp1jni8jqMM7UtQv+PDSc2S3O4qu
 xOWA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20230601; t=1716864245; x=1717469045;
 h=content-transfer-encoding:mime-version:references:in-reply-to
 :message-id:date:subject:cc:to:from:x-gm-message-state:from:to:cc
 :subject:date:message-id:reply-to;
 bh=D8UK8uAVTnW82lBqc0PHDyOOwY4BUuAnWYWQniDrcpo=;
 b=fEcmAIh+O/KGek59n9LIoN0tumXPW0xS/XdH4Zitdxt3GS941rnCBt+KWP2oUUW0jF
 UIZwwOIG0Ylx0ZdhCtgaBjvNdelLXpuAPNHZ4gsQ6UJHG4zEldBgGvDQM2JWCzIjCMXC
 smzveNERbfe+B435F9RSLRhjC9VEFkQVxZxeclgmlLtgmMBRjB/9STGIhPSEnx8OEG3a
 R7D/ys6h/ekTZRizK9T8a02/+tmVI+d6gSq7St5LGcL6hU4J7Pgg1yk8Zo7oA0uDw5Y6
 oQM3MG/h9MMm4sYUpNrQ8CSbO+pwp/xGSRlI62U1KYbw+v6EPr1l/772s0BDlm1iMiGa
 Fa1A==
X-Forwarded-Encrypted: i=1;
 AJvYcCWQkORBqw1faPlsaTjonHKW9RIq316nsI55BKqT9RIVV83DftNqleWY/7z3eEobWRxF/6wq0cDHFnuUC4ypg1M630zhWQFF
X-Gm-Message-State: AOJu0YwmNE990vXsPfemBC/rUMlX3L4rUDXBK1gvl14Q/oOXqQS1iOT0
 96ev/1v6ZP7w21zqLTaPjV7KIv8BSePOTjoVboR/UNxD7n3HoelPga/x0A==
X-Google-Smtp-Source: 
 AGHT+IGhv6X9Tw9YAcoS4jjlrHDAmQ8glmnqfh9Jx0yTE8bM8RWt3n459uoJGGnTCoHr7PwUpXLKwA==
X-Received: by 2002:a17:902:ce12:b0:1f4:977e:bf with SMTP id
 d9443c01a7336-1f4977e13cbmr56012445ad.19.1716864245109;
 Mon, 27 May 2024 19:44:05 -0700 (PDT)
Received: from toolbox.alistair23.me
 (2403-580b-97e8-0-82ce-f179-8a79-69f4.ip6.aussiebb.net.
 [2403:580b:97e8:0:82ce:f179:8a79:69f4])
 by smtp.gmail.com with ESMTPSA id
 d9443c01a7336-1f44c970ca0sm70733225ad.142.2024.05.27.19.44.02
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 27 May 2024 19:44:04 -0700 (PDT)
From: Alistair Francis &lt;alistair23@gmail.com&gt;
X-Google-Original-From: Alistair Francis &lt;alistair.francis@wdc.com&gt;
To: qemu-devel@nongnu.org
Cc: alistair23@gmail.com, Andrew Jones &lt;ajones@ventanamicro.com&gt;,
 Daniel Henrique Barboza &lt;dbarboza@ventanamicro.com&gt;,
 qemu-stable &lt;qemu-stable@nongnu.org&gt;,
 Alistair Francis &lt;alistair.francis@wdc.com&gt;
Subject: [PULL 02/28] target/riscv/kvm: Fix exposure of Zkr
Date: Tue, 28 May 2024 12:43:02 +1000
Message-ID: &lt;20240528024328.246965-3-alistair.francis@wdc.com&gt;
X-Mailer: git-send-email 2.45.1
In-Reply-To: &lt;20240528024328.246965-1-alistair.francis@wdc.com&gt;
References: &lt;20240528024328.246965-1-alistair.francis@wdc.com&gt;
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Received-SPF: pass client-ip=2607:f8b0:4864:20::62a;
 envelope-from=alistair23@gmail.com; helo=mail-pl1-x62a.google.com
X-Spam_score_int: -18
X-Spam_score: -1.9
X-Spam_bar: -
X-Spam_report: (-1.9 / 5.0 requ) BAYES_00=-1.9, DKIM_SIGNED=0.1,
 DKIM_VALID=-0.1, DKIM_VALID_AU=-0.1, DKIM_VALID_EF=-0.1,
 FREEMAIL_ENVFROM_END_DIGIT=0.25, FREEMAIL_FROM=0.001,
 RCVD_IN_DNSWL_NONE=-0.0001, SPF_HELO_NONE=0.001, SPF_PASS=-0.001,
 T_SCC_BODY_TEXT_LINE=-0.01 autolearn=ham autolearn_force=no
X-Spam_action: no action
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: &lt;qemu-devel.nongnu.org&gt;
List-Unsubscribe: &lt;https://lists.nongnu.org/mailman/options/qemu-devel&gt;,
 &lt;mailto:qemu-devel-request@nongnu.org?subject=unsubscribe&gt;
List-Archive: &lt;https://lists.nongnu.org/archive/html/qemu-devel&gt;
List-Post: &lt;mailto:qemu-devel@nongnu.org&gt;
List-Help: &lt;mailto:qemu-devel-request@nongnu.org?subject=help&gt;
List-Subscribe: &lt;https://lists.nongnu.org/mailman/listinfo/qemu-devel&gt;,
 &lt;mailto:qemu-devel-request@nongnu.org?subject=subscribe&gt;
Errors-To: qemu-devel-bounces+qemu-devel=archiver.kernel.org@nongnu.org
Sender: qemu-devel-bounces+qemu-devel=archiver.kernel.org@nongnu.org</pre>
   </div>
  </td>
 </tr>

 <tr>
  <th>Series</th>
  <td>
   <a href="/project/qemu-devel/list/?series=856345">
    [PULL,01/28] hw/intc/riscv_aplic: APLICs should add child earlier than realize
   </a> |
   <a id="togglepatchseries" href="javascript:toggle_div('togglepatchseries', 'patchseries', 'expand', 'collapse')">expand</a>
   <div id="patchseries" class="submissionlist" style="display:none;">
    <ul>
     
      <li>
      
      </li>
     
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-2-alistair.francis@wdc.com/">
        [PULL,01/28] hw/intc/riscv_aplic: APLICs should add child earlier than realize
       </a>
       
      </li>
     
      <li>
       
        [PULL,02/28] target/riscv/kvm: Fix exposure of Zkr
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-4-alistair.francis@wdc.com/">
        [PULL,03/28] target/riscv: Raise exceptions on wrs.nto
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-5-alistair.francis@wdc.com/">
        [PULL,04/28] target/riscv/kvm: implement SBI debug console (DBCN) calls
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-6-alistair.francis@wdc.com/">
        [PULL,05/28] hw/riscv/boot.c: Support 64-bit address for initrd
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-7-alistair.francis@wdc.com/">
        [PULL,06/28] target/riscv: change RISCV_EXCP_SEMIHOST exception number to 63
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-8-alistair.francis@wdc.com/">
        [PULL,07/28] target/riscv/kvm: tolerate KVM disable ext errors
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-9-alistair.francis@wdc.com/">
        [PULL,08/28] target/riscv/debug: set tval=pc in breakpoint exceptions
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-10-alistair.francis@wdc.com/">
        [PULL,09/28] trans_privileged.c.inc: set (m|s)tval on ebreak breakpoint
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-11-alistair.francis@wdc.com/">
        [PULL,10/28] target/riscv: Add support for Zve32x extension
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-12-alistair.francis@wdc.com/">
        [PULL,11/28] target/riscv: Add support for Zve64x extension
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-13-alistair.francis@wdc.com/">
        [PULL,12/28] target/riscv: Relax vector register check in RISCV gdbstub
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-14-alistair.francis@wdc.com/">
        [PULL,13/28] target/riscv: Fix the element agnostic function problem
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-15-alistair.francis@wdc.com/">
        [PULL,14/28] target/riscv/cpu.c: fix Zvkb extension config
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-16-alistair.francis@wdc.com/">
        [PULL,15/28] target/riscv: Implement dynamic establishment of custom decoder
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-17-alistair.francis@wdc.com/">
        [PULL,16/28] riscv: thead: Add th.sxstatus CSR emulation
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-18-alistair.francis@wdc.com/">
        [PULL,17/28] target/riscv: rvv: Fix Zvfhmin checking for vfwcvt.f.f.v and vfncvt.f.f.w instructions
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-19-alistair.francis@wdc.com/">
        [PULL,18/28] target/riscv: rvv: Check single width operator for vector fp widen instructions
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-20-alistair.francis@wdc.com/">
        [PULL,19/28] target/riscv: rvv: Check single width operator for vfncvt.rod.f.f.w
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-21-alistair.francis@wdc.com/">
        [PULL,20/28] target/riscv: rvv: Remove redudant SEW checking for vector fp narrow/widen instructions
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-22-alistair.francis@wdc.com/">
        [PULL,21/28] target/riscv: prioritize pmp errors in raise_mmu_exception()
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-23-alistair.francis@wdc.com/">
        [PULL,22/28] target/riscv: do not set mtval2 for non guest-page faults
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-24-alistair.francis@wdc.com/">
        [PULL,23/28] target/riscv: Remove experimental prefix from "B" extension
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-25-alistair.francis@wdc.com/">
        [PULL,24/28] target/riscv: rvzicbo: Fixup CBO extension register calculation
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-26-alistair.francis@wdc.com/">
        [PULL,25/28] target/riscv/kvm.c: Fix the hart bit setting of AIA
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-27-alistair.francis@wdc.com/">
        [PULL,26/28] riscv, gdbstub.c: fix reg_width in ricsv_gen_dynamic_vector_feature()
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-28-alistair.francis@wdc.com/">
        [PULL,27/28] disas/riscv: Decode all of the pmpcfg and pmpaddr CSRs
       </a>
       
      </li>
     
      <li>
       
       <a href="/project/qemu-devel/patch/20240528024328.246965-29-alistair.francis@wdc.com/">
        [PULL,28/28] target/riscv: raise an exception when CSRRS/CSRRC writes a read-only CSR
       </a>
       
      </li>
     
    </ul>
   </div>
  </td>
 </tr>


</tbody></table>

<div class="patchforms">




 <div style="clear: both;">
 </div>
</div>






<h2>Commit Message</h2>

<div class="comment">
<div class="meta">
 <span><a href="/project/qemu-devel/list/?submitter=152321">Alistair Francis</a></span>
 <span class="pull-right">May 28, 2024, 2:43 a.m. UTC</span>
</div>
<pre class="content"><span class="from">From: Andrew Jones &lt;ajones@ventanamicro.com&gt;</span>

The Zkr extension may only be exposed to KVM guests if the VMM
implements the SEED CSR. Use the same implementation as TCG.

Without this patch, running with a KVM which does not forward the
SEED CSR access to QEMU will result in an ILL exception being
injected into the guest (this results in Linux guests crashing on
boot). And, when running with a KVM which does forward the access,
QEMU will crash, since QEMU doesn't know what to do with the exit.

Fixes: 3108e2f1c69d ("target/riscv/kvm: update KVM exts to Linux 6.8")
<span class="signed-off-by">Signed-off-by: Andrew Jones &lt;ajones@ventanamicro.com&gt;</span>
<span class="reviewed-by">Reviewed-by: Daniel Henrique Barboza &lt;dbarboza@ventanamicro.com&gt;</span>
Cc: qemu-stable &lt;qemu-stable@nongnu.org&gt;
Message-ID: &lt;20240422134605.534207-2-ajones@ventanamicro.com&gt;
<span class="signed-off-by">Signed-off-by: Alistair Francis &lt;alistair.francis@wdc.com&gt;</span>
---
 target/riscv/cpu.h         |  3 +++
 target/riscv/csr.c         | 18 ++++++++++++++----
 target/riscv/kvm/kvm-cpu.c | 25 +++++++++++++++++++++++++
 3 files changed, 42 insertions(+), 4 deletions(-)
</pre>
</div>




<div>
  <div class="btn-group pull-right">
  <button type="button" class="btn btn-default btn-copy" data-clipboard-text="13676011" title="Copy to Clipboard">
      13676011
  </button>
  
  <a href="/project/qemu-devel/patch/20240528024328.246965-3-alistair.francis@wdc.com/raw/" class="btn btn-default" role="button" title="Download patch diff">diff</a>
  <a href="/project/qemu-devel/patch/20240528024328.246965-3-alistair.francis@wdc.com/mbox/" class="btn btn-default" role="button" title="Download patch mbox">mbox</a>
  
  
  <a href="/series/856345/mbox/" class="btn btn-default" role="button" title="Download patch mbox with dependencies">series</a>
  
</div>

  <h2>Patch</h2>
</div>
<div id="patch" class="patch">
<pre class="content"><span class="p_header">diff --git a/target/riscv/cpu.h b/target/riscv/cpu.h</span>
<span class="p_header">index 2d0c02c35b..746efd099a 100644</span>
<span class="p_header">--- a/target/riscv/cpu.h</span>
<span class="p_header">+++ b/target/riscv/cpu.h</span>
<span class="p_chunk">@@ -819,6 +819,9 @@</span> <span class="p_context"> void riscv_set_csr_ops(int csrno, riscv_csr_operations *ops);</span>
 
 void riscv_cpu_register_gdb_regs_for_features(CPUState *cs);
 
<span class="p_add">+target_ulong riscv_new_csr_seed(target_ulong new_value,</span>
<span class="p_add">+                                target_ulong write_mask);</span>
<span class="p_add">+</span>
 uint8_t satp_mode_max_from_map(uint32_t map);
 const char *satp_mode_str(uint8_t satp_mode, bool is_32_bit);
 
<span class="p_header">diff --git a/target/riscv/csr.c b/target/riscv/csr.c</span>
<span class="p_header">index 726096444f..829d8346ed 100644</span>
<span class="p_header">--- a/target/riscv/csr.c</span>
<span class="p_header">+++ b/target/riscv/csr.c</span>
<span class="p_chunk">@@ -4267,10 +4267,8 @@</span> <span class="p_context"> static RISCVException write_upmbase(CPURISCVState *env, int csrno,</span>
 #endif
 
 /* Crypto Extension */
<span class="p_del">-static RISCVException rmw_seed(CPURISCVState *env, int csrno,</span>
<span class="p_del">-                               target_ulong *ret_value,</span>
<span class="p_del">-                               target_ulong new_value,</span>
<span class="p_del">-                               target_ulong write_mask)</span>
<span class="p_add">+target_ulong riscv_new_csr_seed(target_ulong new_value,</span>
<span class="p_add">+                                target_ulong write_mask)</span>
 {
     uint16_t random_v;
     Error *random_e = NULL;
<span class="p_chunk">@@ -4294,6 +4292,18 @@</span> <span class="p_context"> static RISCVException rmw_seed(CPURISCVState *env, int csrno,</span>
         rval = random_v | SEED_OPST_ES16;
     }
 
<span class="p_add">+    return rval;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
<span class="p_add">+static RISCVException rmw_seed(CPURISCVState *env, int csrno,</span>
<span class="p_add">+                               target_ulong *ret_value,</span>
<span class="p_add">+                               target_ulong new_value,</span>
<span class="p_add">+                               target_ulong write_mask)</span>
<span class="p_add">+{</span>
<span class="p_add">+    target_ulong rval;</span>
<span class="p_add">+</span>
<span class="p_add">+    rval = riscv_new_csr_seed(new_value, write_mask);</span>
<span class="p_add">+</span>
     if (ret_value) {
         *ret_value = rval;
     }
<span class="p_header">diff --git a/target/riscv/kvm/kvm-cpu.c b/target/riscv/kvm/kvm-cpu.c</span>
<span class="p_header">index eaa36121c7..b8136c7ef8 100644</span>
<span class="p_header">--- a/target/riscv/kvm/kvm-cpu.c</span>
<span class="p_header">+++ b/target/riscv/kvm/kvm-cpu.c</span>
<span class="p_chunk">@@ -1418,6 +1418,28 @@</span> <span class="p_context"> static int kvm_riscv_handle_sbi(CPUState *cs, struct kvm_run *run)</span>
     return ret;
 }
 
<span class="p_add">+static int kvm_riscv_handle_csr(CPUState *cs, struct kvm_run *run)</span>
<span class="p_add">+{</span>
<span class="p_add">+    target_ulong csr_num = run-&gt;riscv_csr.csr_num;</span>
<span class="p_add">+    target_ulong new_value = run-&gt;riscv_csr.new_value;</span>
<span class="p_add">+    target_ulong write_mask = run-&gt;riscv_csr.write_mask;</span>
<span class="p_add">+    int ret = 0;</span>
<span class="p_add">+</span>
<span class="p_add">+    switch (csr_num) {</span>
<span class="p_add">+    case CSR_SEED:</span>
<span class="p_add">+        run-&gt;riscv_csr.ret_value = riscv_new_csr_seed(new_value, write_mask);</span>
<span class="p_add">+        break;</span>
<span class="p_add">+    default:</span>
<span class="p_add">+        qemu_log_mask(LOG_UNIMP,</span>
<span class="p_add">+                      "%s: un-handled CSR EXIT for CSR %lx
",</span>
<span class="p_add">+                      __func__, csr_num);</span>
<span class="p_add">+        ret = -1;</span>
<span class="p_add">+        break;</span>
<span class="p_add">+    }</span>
<span class="p_add">+</span>
<span class="p_add">+    return ret;</span>
<span class="p_add">+}</span>
<span class="p_add">+</span>
 int kvm_arch_handle_exit(CPUState *cs, struct kvm_run *run)
 {
     int ret = 0;
<span class="p_chunk">@@ -1425,6 +1447,9 @@</span> <span class="p_context"> int kvm_arch_handle_exit(CPUState *cs, struct kvm_run *run)</span>
     case KVM_EXIT_RISCV_SBI:
         ret = kvm_riscv_handle_sbi(cs, run);
         break;
<span class="p_add">+    case KVM_EXIT_RISCV_CSR:</span>
<span class="p_add">+        ret = kvm_riscv_handle_csr(cs, run);</span>
<span class="p_add">+        break;</span>
     default:
         qemu_log_mask(LOG_UNIMP, "%s: un-handled exit reason %d
",
                       __func__, run-&gt;exit_reason);

</pre>
</div>



  </div>
  <div id="footer">
   <a href="http://jk.ozlabs.org/projects/patchwork/">patchwork</a>
   patch tracking system | version v2.2.6 | <a href="/about/">about patchwork</a>
  </div>
 

<orbit-wrapper style="border-block: initial; border-inline: initial; border-start-start-radius: initial; border-start-end-radius: initial; border-end-start-radius: initial; border-end-end-radius: initial; overflow-block: initial; overflow-inline: initial; overscroll-behavior-block: initial; overscroll-behavior-inline: initial; margin-block: initial; margin-inline: initial; scroll-margin-block: initial; scroll-margin-inline: initial; padding-block: initial; padding-inline: initial; scroll-padding-block: initial; scroll-padding-inline: initial; inset-block: initial; inset-inline: initial; block-size: initial; min-block-size: initial; max-block-size: initial; inline-size: initial; min-inline-size: initial; max-inline-size: initial; contain-intrinsic-block-size: initial; contain-intrinsic-inline-size: initial; background: initial; background-blend-mode: initial; border: initial; border-radius: initial; box-decoration-break: initial; -moz-float-edge: initial; display: initial; position: fixed; float: initial; clear: initial; vertical-align: initial; baseline-source: initial; overflow: initial; overflow-anchor: initial; transform: initial; rotate: initial; scale: initial; translate: initial; offset: initial; scroll-behavior: initial; scroll-snap-align: initial; scroll-snap-type: initial; scroll-snap-stop: initial; overscroll-behavior: initial; isolation: initial; break-after: initial; break-before: initial; break-inside: initial; resize: initial; perspective: initial; perspective-origin: initial; backface-visibility: initial; transform-box: initial; transform-style: initial; transform-origin: initial; contain: initial; content-visibility: initial; container: initial; appearance: initial; -moz-orient: initial; will-change: initial; shape-image-threshold: initial; shape-margin: initial; shape-outside: initial; touch-action: initial; -webkit-line-clamp: initial; scrollbar-gutter: initial; zoom: initial; columns: initial; column-fill: initial; column-rule: initial; column-span: initial; content: initial; counter-increment: initial; counter-reset: initial; counter-set: initial; opacity: initial; box-shadow: initial; clip: initial; filter: initial; backdrop-filter: initial; mix-blend-mode: initial; font: initial; font-synthesis: initial; font-palette: initial; math-depth: initial; math-style: initial; visibility: initial; writing-mode: initial; text-orientation: initial; print-color-adjust: initial; image-rendering: initial; image-orientation: initial; dominant-baseline: initial; text-anchor: initial; color-interpolation: initial; color-interpolation-filters: initial; fill: initial; fill-opacity: initial; fill-rule: initial; shape-rendering: initial; stroke: initial; stroke-width: initial; stroke-linecap: initial; stroke-linejoin: initial; stroke-miterlimit: initial; stroke-opacity: initial; stroke-dasharray: initial; stroke-dashoffset: initial; clip-rule: initial; marker: initial; paint-order: initial; border-collapse: initial; empty-cells: initial; caption-side: initial; border-spacing: initial; color: initial; text-transform: initial; hyphens: initial; -moz-text-size-adjust: initial; text-indent: initial; overflow-wrap: initial; word-break: initial; text-justify: initial; text-align-last: initial; text-align: initial; letter-spacing: initial; word-spacing: initial; white-space: initial; text-shadow: initial; text-emphasis: initial; text-emphasis-position: initial; tab-size: initial; line-break: initial; -webkit-text-fill-color: initial; -webkit-text-stroke: initial; ruby-align: initial; ruby-position: initial; text-combine-upright: initial; text-rendering: initial; text-underline-offset: initial; text-underline-position: initial; text-decoration-skip-ink: initial; hyphenate-character: initial; forced-color-adjust: initial; -webkit-text-security: initial; text-wrap: initial; cursor: initial; pointer-events: initial; caret-color: initial; accent-color: initial; color-scheme: initial; scrollbar-color: initial; list-style: initial; quotes: initial; margin: initial; overflow-clip-margin: initial; scroll-margin: initial; outline: initial; outline-offset: initial; padding: initial; scroll-padding: initial; page: initial; top: 0px; right: 0px; bottom: initial; left: initial; z-index: 2147483647; flex-flow: initial; place-content: initial; place-items: initial; flex: initial; place-self: initial; order: initial; height: 100vh; min-height: initial; max-height: initial; width: 0px; min-width: initial; max-width: initial; box-sizing: initial; object-fit: initial; object-position: initial; grid-area: initial; grid: initial; gap: initial; aspect-ratio: initial; contain-intrinsic-size: initial; vector-effect: initial; stop-color: initial; stop-opacity: initial; flood-color: initial; flood-opacity: initial; lighting-color: initial; mask-type: initial; clip-path: initial; mask: initial; x: initial; y: initial; cx: initial; cy: initial; rx: initial; ry: initial; r: initial; d: initial; table-layout: initial; text-overflow: initial; text-decoration: initial; ime-mode: initial; scrollbar-width: initial; user-select: initial; -moz-window-dragging: initial; -moz-force-broken-image-icon: initial; transition: initial; animation: initial; animation-composition: initial; -moz-box-align: initial; -moz-box-direction: initial; -moz-box-flex: initial; -moz-box-orient: initial; -moz-box-pack: initial; -moz-box-ordinal-group: initial;"></orbit-wrapper></body><div style="all: initial;"><div style="all: initial;" id="__hcfy__"></div></div><div id="immersive-translate-popup" style="all: initial"></div></html>